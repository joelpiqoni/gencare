<!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GENCARE â€¢ GENE4LIFE</title>

  <!-- Save to gallery -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- Cute font (optional, falls back safely) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@600;700;800;900&display=swap" rel="stylesheet">

  <style>
    :root{
      /* MAIN: GREEN PALETTE (shades) */
      --g-950:#0a1f16;
      --g-900:#0e2b1e;
      --g-850:#123224;
      --g-800:#143a28;
      --g-700:#1b4d35;
      --g-600:#236b47;
      --g-500:#2f8a5e;
      --g-400:#43a874;
      --g-300:#67c08f;
      --g-200:#9fe3c1;
      --g-150:#c9f2dd;
      --g-100:#eafff4;

      /* ACCENTS (soft + kid-friendly, used sparingly) */
      --sun:#ffd36a;
      --sky:#7fd7ff;
      --berry:#ff78b7;
      --tanger:#ff9a6a;
      --violet:#b49bff;

      /* UI */
      --ink:#0c1712;
      --ink2:rgba(12,23,18,.72);
      --card:rgba(255,255,255,.75);
      --card2:rgba(255,255,255,.58);
      --stroke:rgba(255,255,255,.55);
      --shadow: 0 18px 55px rgba(0,0,0,.18);
      --shadow2: 0 10px 28px rgba(0,0,0,.14);
      --radius: 24px;
      --radius2: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Nunito", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--ink);
      overflow-x:hidden;

      /* Base background */
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(67,192,143,.30), rgba(10,31,22,.0) 60%),
        radial-gradient(900px 700px at 85% 25%, rgba(127,215,255,.20), rgba(10,31,22,.0) 62%),
        radial-gradient(1100px 900px at 60% 90%, rgba(255,120,183,.10), rgba(10,31,22,.0) 60%),
        linear-gradient(160deg, var(--g-950), var(--g-900) 35%, var(--g-850) 70%, var(--g-900));
    }

    a{color:inherit;text-decoration:none}
    button{font:inherit; cursor:pointer}
    .hidden{display:none !important}

    /* =========================================================
       ANIMATED CHILD DOODLES BACKGROUND (stars + hearts + clouds)
       ========================================================= */
    .bg{
      position:fixed; inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index:0;
    }
    .bg:before{
      content:"";
      position:absolute; inset:-20%;
      opacity:.26;
      filter: saturate(1.1);
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='560' height='560' viewBox='0 0 560 560'%3E%3Cg fill='none' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M64 92l8 18 20 4-15 14 4 20-17-9-18 9 4-20-15-14 20-4z' stroke='%23C9F2DD' stroke-width='6' opacity='.55'/%3E%3Cpath d='M210 110c14-8 22 8 10 16-11 7-10 18 2 22 14 5 4 26-12 14-10-7-20-6-26 2-10 13-27-2-15-16 7-8 5-18-7-22-16-6-2-28 13-14 8 7 18 6 35-2z' stroke='%2367C08F' stroke-width='6' opacity='.5'/%3E%3Cpath d='M420 88c10-10 24 4 14 14-8 8-6 18 6 20 16 3 7 26-9 18-10-5-20 0-22 10-4 16-27 9-18-8 6-10 2-20-9-24-15-5-2-28 12-16 8 7 18 4 26-4z' stroke='%237FD7FF' stroke-width='6' opacity='.45'/%3E%3Cpath d='M104 320c26-22 44 6 26 26-16 18 0 34 20 28 28-10 34 28 6 34-18 4-28 18-20 34 12 24-24 40-34 16-8-18-26-22-40-8-22 22-48-10-24-28 16-10 16-28 0-38-26-16-8-54 18-34 14 10 32 6 48-10z' stroke='%23FFD36A' stroke-width='6' opacity='.35'/%3E%3Cpath d='M388 338c18-16 30 6 16 20-12 12-2 26 14 22 22-6 24 24 2 26-14 2-20 14-14 26 10 18-18 30-24 12-6-12-18-14-28-4-16 16-34-8-18-20 10-7 10-18 0-24-18-10-6-38 12-24 10 8 22 4 40-6z' stroke='%23FF78B7' stroke-width='6' opacity='.30'/%3E%3Cpath d='M112 490c18-20 44 2 28 20-10 10-8 22 8 24 22 4 14 32-8 24-12-4-24 4-22 16 4 24-30 28-26 4 2-12-8-22-20-20-24 4-30-30-6-26 12 2 20-8 18-20z' stroke='%23B49BFF' stroke-width='6' opacity='.30'/%3E%3C/g%3E%3C/svg%3E");
      background-size: 560px 560px;
      animation: doodleDrift 22s linear infinite;
      transform: rotate(-6deg);
    }
    @keyframes doodleDrift{
      0%{transform: translate3d(-2%, -2%, 0) rotate(-6deg)}
      50%{transform: translate3d(2%, 1%, 0) rotate(-5deg)}
      100%{transform: translate3d(-2%, -2%, 0) rotate(-6deg)}
    }

    .sticker{
      position:absolute;
      width: 220px; height: 220px;
      border-radius: 60% 40% 55% 45% / 45% 55% 40% 60%;
      background:
        radial-gradient(circle at 35% 30%, rgba(255,255,255,.50), rgba(255,255,255,0) 55%),
        radial-gradient(circle at 70% 70%, rgba(127,215,255,.18), rgba(255,255,255,0) 55%),
        linear-gradient(160deg, rgba(67,192,143,.20), rgba(255,120,183,.10));
      filter: blur(.2px);
      opacity:.55;
      animation: floaty 9s ease-in-out infinite;
      box-shadow: 0 18px 60px rgba(0,0,0,.18);
    }
    .st1{left:-60px; top:10vh; animation-duration:10.5s}
    .st2{right:-90px; top:32vh; width:260px; height:260px; opacity:.45; animation-duration:12.2s}
    .st3{left:10vw; bottom:-110px; width:300px; height:300px; opacity:.35; animation-duration:13.4s}
    @keyframes floaty{
      0%,100%{transform: translateY(0) rotate(-3deg)}
      50%{transform: translateY(-18px) rotate(3deg)}
    }

    .twinkle{
      position:absolute;
      width:10px; height:10px; border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.95), rgba(255,255,255,.0) 70%);
      box-shadow: 0 0 22px rgba(255,255,255,.35);
      opacity:.55;
      animation: tw 2.8s ease-in-out infinite;
    }
    @keyframes tw{0%,100%{transform: scale(.7); opacity:.35} 50%{transform: scale(1.2); opacity:.75}}

    /* =========================================================
       APP SHELL
       ========================================================= */
    .app{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      position:relative;
      z-index:1;
    }

    .shell{
      width:min(1140px, 100%);
      border-radius: 30px;
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(255,255,255,.40), rgba(255,255,255,.14) 50%, rgba(255,255,255,.06)),
        linear-gradient(180deg, rgba(255,255,255,.15), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.30);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      backdrop-filter: blur(12px);
    }

    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.26);
      background:
        radial-gradient(900px 240px at 20% 10%, rgba(67,192,143,.22), rgba(255,255,255,0) 65%),
        linear-gradient(180deg, rgba(255,255,255,.20), rgba(255,255,255,.08));
    }

    .brand{
      display:flex; align-items:center; gap:12px;
      font-weight:900;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-size:12px;
      color: rgba(12,23,18,.88);
      user-select:none;
    }
    .logoMark{ width:34px; height:34px; flex:0 0 auto; filter: drop-shadow(0 10px 18px rgba(0,0,0,.12)); }
    .brand .sub{ font-weight:900; opacity:.68; letter-spacing:.14em; margin-left:6px; }
    .right-actions{display:flex; gap:10px; align-items:center}

    .pill{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.40);
      background:
        radial-gradient(220px 60px at 30% 10%, rgba(255,255,255,.60), rgba(255,255,255,.10)),
        linear-gradient(180deg, rgba(255,255,255,.20), rgba(255,255,255,.08));
      box-shadow: 0 12px 24px rgba(0,0,0,.12);
      color: rgba(12,23,18,.86);
      font-weight:900;
      font-size:13px;
      transition: transform .12s ease, filter .12s ease;
    }
    .pill.secondary{opacity:.86}
    .pill:hover{filter: brightness(1.06)}
    .pill:active{transform: translateY(2px) scale(.99)}
    .pill:focus{outline:3px solid rgba(103,192,143,.35); outline-offset:2px}

    .content{ min-height: calc(100vh - 90px); padding:18px; }

    /* =========================================================
       KID-GLASS CARDS + BUTTONS
       ========================================================= */
    .glass{
      background:
        radial-gradient(800px 220px at 20% 10%, rgba(255,255,255,.65), rgba(255,255,255,.18) 55%, rgba(255,255,255,.12)),
        linear-gradient(180deg, rgba(255,255,255,.38), rgba(255,255,255,.18));
      border:1px solid rgba(255,255,255,.45);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(14px);
      border-radius: var(--radius);
      position:relative;
      overflow:hidden;
    }
    .glass:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(900px 260px at 15% 0%, rgba(103,192,143,.25), transparent 60%),
        radial-gradient(900px 260px at 85% 0%, rgba(127,215,255,.18), transparent 60%),
        radial-gradient(700px 260px at 70% 120%, rgba(255,120,183,.10), transparent 65%);
      pointer-events:none;
      opacity:.9;
    }
    .glass > *{position:relative}

    .card-pad{padding:18px}
    .stack{display:flex; flex-direction:column; gap:12px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .grid2{display:grid; grid-template-columns: 1.05fr .95fr; gap:16px}
    @media (max-width: 900px){ .grid2{grid-template-columns:1fr} }

    h1,h2,h3{margin:0}
    .muted{color:var(--ink2)}
    .small{font-size:13px}
    .tiny{font-size:12px}

    .section-title{
      font-weight:950;
      letter-spacing:.01em;
      font-size:18px;
      color: rgba(12,23,18,.92);
    }

    .field{display:flex; flex-direction:column; gap:6px}
    label{font-size:12px; opacity:.84; font-weight:900}
    input, select, textarea{
      width:100%;
      padding:12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.55);
      background: rgba(255,255,255,.52);
      outline:none;
      color: rgba(12,23,18,.90);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.60);
      transition: transform .10s ease, box-shadow .10s ease, border-color .10s ease;
    }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(103,192,143,.65);
      box-shadow: 0 0 0 4px rgba(103,192,143,.18), inset 0 1px 0 rgba(255,255,255,.65);
    }
    textarea{min-height:88px; resize:vertical}

    .note{
      padding:12px 14px;
      border-radius: 18px;
      background:
        radial-gradient(260px 80px at 20% 0%, rgba(255,211,106,.26), rgba(255,255,255,0) 65%),
        linear-gradient(180deg, rgba(255,255,255,.55), rgba(255,255,255,.40));
      border:1px dashed rgba(67,192,143,.55);
      color: rgba(12,23,18,.80);
      box-shadow: 0 12px 26px rgba(0,0,0,.10);
    }

    .view-anim{animation: in .26s cubic-bezier(.2,.8,.2,1)}
    @keyframes in{from{opacity:0; transform: translateY(10px) scale(.99)} to{opacity:1; transform:none}}

    .bigbtn{
      padding:16px 16px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.50);
      background:
        radial-gradient(500px 150px at 20% 10%, rgba(255,255,255,.70), rgba(255,255,255,.18) 55%, rgba(255,255,255,.12)),
        linear-gradient(180deg, rgba(255,255,255,.35), rgba(255,255,255,.16));
      box-shadow: 0 16px 40px rgba(0,0,0,.14);
      text-align:left;
      position:relative;
      overflow:hidden;
      transition: transform .12s ease, filter .12s ease;
    }
    .bigbtn:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(700px 200px at 18% 10%, rgba(103,192,143,.25), transparent 60%),
        radial-gradient(700px 200px at 85% 0%, rgba(127,215,255,.16), transparent 60%);
      pointer-events:none;
      opacity:.9;
    }
    .bigbtn:hover{filter: brightness(1.05)}
    .bigbtn:active{transform: translateY(2px) scale(.995)}
    .bigbtn .t{position:relative; font-weight:950; letter-spacing:.01em; font-size:16px}
    .bigbtn .d{position:relative; margin-top:6px; color:rgba(12,23,18,.72); font-weight:800; font-size:13px; line-height:1.35}

    /* =========================================================
       LANDING
       ========================================================= */
    .landing{
      min-height: 78vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:26px 16px;
      position:relative;
      overflow:hidden;
      border-radius: 26px;

      background:
        radial-gradient(1100px 700px at 20% 20%, rgba(103,192,143,.36), rgba(10,31,22,0) 60%),
        radial-gradient(900px 650px at 85% 30%, rgba(127,215,255,.18), rgba(10,31,22,0) 62%),
        linear-gradient(160deg, rgba(14,43,30,.92), rgba(18,50,36,.80));
      border:1px solid rgba(255,255,255,.20);
      box-shadow: 0 22px 70px rgba(0,0,0,.22);
    }

    .landing:before{
      content:"";
      position:absolute; inset:-30%;
      opacity:.18;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='520' height='520' viewBox='0 0 520 520'%3E%3Cg fill='none' stroke-linecap='round' stroke-linejoin='round' stroke-width='6'%3E%3Cpath d='M70 120l10 22 24 5-18 16 5 24-21-11-22 11 5-24-18-16 24-5z' stroke='%23E9FFF4' opacity='.55'/%3E%3Cpath d='M340 140c20-16 40 10 20 26-16 12-10 30 8 30 26 0 20 36-6 32-18-2-30 12-24 28 10 26-28 36-34 12-4-18-24-22-38-8-22 20-46-12-24-26 14-10 14-28 0-38-22-14-2-48 20-30 12 10 26 8 58-2z' stroke='%2367C08F' opacity='.45'/%3E%3Cpath d='M170 320c10-10 22 2 14 12-6 8-2 16 8 16 14 0 10 20-4 18-10-2-16 6-12 16 6 14-16 20-18 6-2-10-12-12-20-4-12 10-24-8-12-14 8-6 8-14 0-18-14-8-2-28 10-18 8 6 14 4 26-2z' stroke='%237FD7FF' opacity='.45'/%3E%3Cpath d='M412 334c10-10 22 2 14 12-6 8-2 16 8 16 14 0 10 20-4 18-10-2-16 6-12 16 6 14-16 20-18 6-2-10-12-12-20-4-12 10-24-8-12-14 8-6 8-14 0-18-14-8-2-28 10-18 8 6 14 4 26-2z' stroke='%23FFD36A' opacity='.35'/%3E%3C/g%3E%3C/svg%3E");
      background-size: 520px 520px;
      animation: landDrift 16s ease-in-out infinite;
      pointer-events:none;
    }
    @keyframes landDrift{0%{transform: translate(-2%,-2%)} 50%{transform: translate(2%,1%)} 100%{transform: translate(-2%,-2%)}}

    .landing-center{
      position:relative;
      text-align:center;
      padding:26px 18px;
      border-radius: 30px;
      background:
        radial-gradient(800px 220px at 20% 0%, rgba(255,255,255,.32), rgba(255,255,255,.10) 60%),
        linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.22);
      box-shadow: 0 26px 70px rgba(0,0,0,.22);
      backdrop-filter: blur(14px);
      max-width: 880px;
    }

    .gencare-link{
      display:inline-block;
      font-weight: 1000;
      letter-spacing: .10em;
      text-transform: uppercase;
      font-size: clamp(44px, 9vw, 92px);
      line-height: 1.02;
      padding: 10px 14px;
      border-radius: 24px;
      cursor:pointer;
      user-select:none;

      color: rgba(255,255,255,.95);
      text-shadow:
        0 2px 0 rgba(0,0,0,.24),
        0 20px 60px rgba(0,0,0,.22);

      background:
        radial-gradient(900px 160px at 30% 15%, rgba(255,255,255,.28), transparent 55%),
        radial-gradient(700px 180px at 70% 70%, rgba(103,192,143,.22), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.04));
      border: 1px solid rgba(255,255,255,.24);
      box-shadow:
        0 24px 64px rgba(0,0,0,.22),
        inset 0 1px 0 rgba(255,255,255,.22);
      transition: transform .12s ease, filter .12s ease;
      animation: pulseCute 2.4s ease-in-out infinite;
    }
    @keyframes pulseCute{ 0%,100%{transform: translateY(0)} 50%{transform: translateY(-2px)} }
    .gencare-link:hover{filter: brightness(1.06)}
    .gencare-link:active{transform: translateY(2px) scale(.995); animation:none}

    .landing-slogan{
      margin-top:10px;
      font-size: clamp(14px, 2.2vw, 18px);
      color: rgba(255,255,255,.88);
      font-weight: 800;
      letter-spacing:.01em;
    }

    /* =========================================================
       HOME + MENU
       ========================================================= */
    .home-scroll{max-height: 72vh; overflow:auto; padding-right:6px}
    .home-scroll::-webkit-scrollbar{width:10px}
    .home-scroll::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.26);
      border-radius:999px;
      border:2px solid rgba(255,255,255,.18);
    }

    .hero{
      padding:20px;
      border-radius: 28px;
      background:
        radial-gradient(900px 360px at 30% 10%, rgba(103,192,143,.26), rgba(255,255,255,.18) 55%, rgba(255,255,255,.10)),
        radial-gradient(650px 260px at 85% 0%, rgba(127,215,255,.18), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.25), rgba(255,255,255,.12));
      border: 1px solid rgba(255,255,255,.35);
      box-shadow: 0 18px 45px rgba(0,0,0,.12);
      position:relative;
      overflow:hidden;
    }
    .hero:after{
      content:"";
      position:absolute; inset:-30%;
      opacity:.15;
      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='520' height='220' viewBox='0 0 520 220'%3E%3Cg fill='none' stroke='%23E9FFF4' stroke-width='6' stroke-linecap='round'%3E%3Cpath d='M60 70c10-16 30-18 42-6 12 12 10 30-6 40-10 6-14 18-8 28' opacity='.7'/%3E%3Cpath d='M168 50l10 22 24 5-18 16 5 24-21-11-22 11 5-24-18-16 24-5z' opacity='.55'/%3E%3Cpath d='M360 60c16-12 30 2 20 18-8 12-2 26 12 28' opacity='.55'/%3E%3Cpath d='M432 70l8 18 20 4-15 14 4 20-17-9-18 9 4-20-15-14 20-4z' opacity='.45'/%3E%3C/g%3E%3C/svg%3E");
      background-size: 520px 220px;
      animation: heroDoodle 18s ease-in-out infinite;
      pointer-events:none;
      transform: rotate(-2deg);
    }
    @keyframes heroDoodle{
      0%{transform: translate(-1%,-1%) rotate(-2deg)}
      50%{transform: translate(1%,1%) rotate(-1deg)}
      100%{transform: translate(-1%,-1%) rotate(-2deg)}
    }

    .hero h1{
      font-size: clamp(28px, 4.8vw, 54px);
      font-weight: 1000;
      letter-spacing: .10em;
      text-transform: uppercase;
      margin-bottom: 8px;
    }
    .hero p{
      margin:8px 0 0;
      color: rgba(12,23,18,.82);
      font-weight:800;
      line-height: 1.55;
    }

    .color-break{
      height:18px;
      border-radius: 999px;
      background: linear-gradient(90deg,
        rgba(103,192,143,.85),
        rgba(159,227,193,.78),
        rgba(127,215,255,.60),
        rgba(255,211,106,.60),
        rgba(255,120,183,.45)
      );
      border:1px solid rgba(255,255,255,.30);
      box-shadow: 0 12px 26px rgba(0,0,0,.10);
      margin:14px 0;
      position:relative;
      overflow:hidden;
    }
    .color-break:before{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(240px 120px at 30% 40%, rgba(255,255,255,.35), transparent 60%);
      animation: sheen 5s ease-in-out infinite;
      opacity:.7;
    }
    @keyframes sheen{0%,100%{transform: translateX(-8%)} 50%{transform: translateX(8%)}}

    .menu-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){ .menu-grid{grid-template-columns: repeat(2,1fr)} }
    @media (max-width: 600px){ .menu-grid{grid-template-columns: 1fr} }

    /* =========================================================
       INFORMOHU
       ========================================================= */
    .dna-stage{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width: 900px){ .dna-stage{grid-template-columns:1fr} }

    .dna-box{
      padding:18px;
      position:relative;
      min-height: 430px;
      overflow:hidden;
    }
    .dna-bg{
      position:absolute; inset:0;
      background:
        radial-gradient(900px 520px at 20% 10%, rgba(103,192,143,.22), transparent 58%),
        radial-gradient(700px 520px at 80% 70%, rgba(127,215,255,.16), transparent 62%),
        linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.10));
      animation: drift 16s ease-in-out infinite;
      opacity:.95;
    }
    @keyframes drift{
      0%{transform: translate(-2%, -1%)}
      50%{transform: translate(2%, 1%)}
      100%{transform: translate(-2%, -1%)}
    }

    .helix-svg{
      position:absolute;
      left:50%; top:50%;
      width:min(440px, 78vw);
      transform: translate(-50%,-50%);
      opacity:.98;
      filter: drop-shadow(0 18px 35px rgba(0,0,0,.14));
    }

    .marker{
      position:absolute;
      width:52px; height:52px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.45);
      background:
        radial-gradient(120px 60px at 30% 10%, rgba(255,255,255,.75), rgba(255,255,255,.18)),
        linear-gradient(180deg, rgba(255,255,255,.30), rgba(255,255,255,.14));
      box-shadow: 0 18px 36px rgba(0,0,0,.16);
      display:flex; align-items:center; justify-content:center;
      font-weight: 1000;
      cursor:pointer;
      transition: transform .12s ease, filter .12s ease;
      user-select:none;
    }
    .marker:hover{filter: brightness(1.06)}
    .marker:active{transform: translateY(2px) scale(.99)}
    .marker span{
      display:inline-block;
      width:32px; height:32px;
      border-radius: 999px;
      display:flex; align-items:center; justify-content:center;
      color: rgba(255,255,255,.95);
      text-shadow: 0 1px 0 rgba(0,0,0,.20);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25);
      font-size:18px;
    }

    /* =========================================================
       GAMES
       ========================================================= */
    .game-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
    }
    @media (max-width: 980px){ .game-grid{grid-template-columns: repeat(2,1fr)} }
    @media (max-width: 600px){ .game-grid{grid-template-columns: 1fr} }

    .starrow{display:flex; gap:10px; flex-wrap:wrap}
    .star{
      width:56px; height:56px;
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.45);
      background:
        radial-gradient(160px 70px at 30% 10%, rgba(255,255,255,.75), rgba(255,255,255,.18)),
        linear-gradient(180deg, rgba(255,255,255,.30), rgba(255,255,255,.12));
      box-shadow: 0 18px 34px rgba(0,0,0,.14);
      display:flex; align-items:center; justify-content:center;
      font-size:22px;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, filter .12s ease;
    }
    .star:hover{filter: brightness(1.06)}
    .star:active{transform: translateY(2px) scale(.99)}

    .progressbar{
      height:12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.35);
      background: rgba(255,255,255,.22);
      overflow:hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.35);
    }
    .progressbar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(103,192,143,.95), rgba(159,227,193,.85), rgba(127,215,255,.55));
      border-right:1px solid rgba(255,255,255,.30);
      transition: width .25s ease;
    }

    .game-board{padding:16px; min-height: 320px}
    .game-hud{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .hud-chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.40);
      background: rgba(255,255,255,.40);
      font-weight:950;
      font-size:12px;
      color: rgba(12,23,18,.78);
      box-shadow: 0 10px 18px rgba(0,0,0,.10);
    }

    /* Pause/Resume icons (Pause=triangle, Resume=||) */
    .iconbtn{
      width:48px; height:48px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.45);
      background:
        radial-gradient(160px 70px at 30% 10%, rgba(255,255,255,.75), rgba(255,255,255,.18)),
        linear-gradient(180deg, rgba(255,255,255,.30), rgba(255,255,255,.12));
      box-shadow: 0 16px 34px rgba(0,0,0,.14);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, filter .12s ease;
    }
    .iconbtn:hover{filter: brightness(1.06)}
    .iconbtn:active{transform: translateY(2px) scale(.99)}
    .tri{
      width:0;height:0;
      border-top:11px solid transparent;
      border-bottom:11px solid transparent;
      border-left:18px solid rgba(12,23,18,.82);
      margin-left:3px;
    }
    .bars{width:16px; height:22px; display:flex; justify-content:space-between}
    .bars i{
      display:block; width:5px; height:22px; border-radius:4px;
      background: rgba(12,23,18,.78);
    }

    .tiles{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 720px){ .tiles{grid-template-columns: repeat(3,1fr)} }
    @media (max-width: 480px){ .tiles{grid-template-columns: repeat(2,1fr)} }

    .tile{
      padding:14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.40);
      background: rgba(255,255,255,.40);
      box-shadow: 0 14px 30px rgba(0,0,0,.10);
      min-height: 70px;
      display:flex; align-items:center; justify-content:center;
      text-align:center;
      font-weight:950;
      cursor:pointer;
      user-select:none;
      transition: transform .12s ease, filter .12s ease;
      position:relative;
      overflow:hidden;
    }
    .tile:before{
      content:"";
      position:absolute; inset:-30%;
      background: radial-gradient(240px 120px at 30% 40%, rgba(255,255,255,.45), transparent 60%);
      opacity:.65;
      pointer-events:none;
      animation: tileSheen 6s ease-in-out infinite;
    }
    @keyframes tileSheen{0%,100%{transform: translateX(-6%)} 50%{transform: translateX(6%)}}
    .tile:hover{filter: brightness(1.06)}
    .tile:active{transform: translateY(2px) scale(.99)}
    .tile.good{outline: 3px solid rgba(67,192,143,.45)}
    .tile.bad{outline: 3px solid rgba(255,120,183,.35)}

    .divider{height:1px; background: rgba(255,255,255,.35); margin: 8px 0}

    .q-item{
      padding:14px;
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.40);
      background: rgba(255,255,255,.40);
      box-shadow: 0 16px 34px rgba(0,0,0,.10);
      position:relative;
      overflow:hidden;
    }
    .q-item:before{
      content:"";
      position:absolute; inset:-40%;
      background:
        radial-gradient(300px 160px at 20% 10%, rgba(103,192,143,.18), transparent 60%),
        radial-gradient(260px 160px at 80% 0%, rgba(127,215,255,.16), transparent 60%);
      opacity:.95;
      pointer-events:none;
    }
    .q-item > *{position:relative}
    .q-title{font-weight:1000; margin-bottom:10px}
    .radio-row{display:flex; gap:10px; flex-wrap:wrap}
    .radio{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.45);
      background: rgba(255,255,255,.32);
      cursor:pointer;
      user-select:none;
      font-weight:950;
      font-size:13px;
      color: rgba(12,23,18,.74);
      transition: transform .12s ease, filter .12s ease;
    }
    .radio:hover{filter: brightness(1.06)}
    .radio:active{transform: translateY(2px) scale(.99)}
    .radio input{width:auto}
    .radio.active{
      background: rgba(103,192,143,.22);
      border-color: rgba(67,192,143,.55);
      color: rgba(12,23,18,.92);
    }

    .task{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:12px 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.40);
      background: rgba(255,255,255,.40);
      align-items:center;
      box-shadow: 0 12px 26px rgba(0,0,0,.10);
    }
    .task b{font-size:13px}
    .check{
      width:24px;height:24px;
      border-radius:9px;
      border:1px solid rgba(255,255,255,.50);
      background: rgba(255,255,255,.42);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      user-select:none;
      font-weight:1000;
      box-shadow: 0 10px 18px rgba(0,0,0,.10);
      transition: transform .12s ease, filter .12s ease;
    }
    .check:hover{filter: brightness(1.06)}
    .check:active{transform: translateY(2px) scale(.99)}
    .check.on{
      background: rgba(103,192,143,.28);
      border-color: rgba(67,192,143,.55);
    }

    /* BrainAge (12 games) small extra */
    .stepper{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }
    .stepDot{
      width:32px; height:32px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.45);
      background: rgba(255,255,255,.38);
      box-shadow: 0 12px 22px rgba(0,0,0,.10);
      display:flex; align-items:center; justify-content:center;
      font-weight:1000;
      font-size:12px;
      color: rgba(12,23,18,.80);
      user-select:none;
    }
    .stepDot.on{
      outline: 3px solid rgba(67,192,143,.38);
      background: rgba(103,192,143,.18);
      color: rgba(12,23,18,.92);
    }
  </style>
</head>

<body>
  <div class="bg" aria-hidden="true">
    <div class="sticker st1"></div>
    <div class="sticker st2"></div>
    <div class="sticker st3"></div>

    <div class="twinkle" style="left:10vw; top:12vh; animation-delay:.2s"></div>
    <div class="twinkle" style="left:22vw; top:22vh; animation-delay:1.1s"></div>
    <div class="twinkle" style="left:75vw; top:14vh; animation-delay:.6s"></div>
    <div class="twinkle" style="left:86vw; top:36vh; animation-delay:1.6s"></div>
    <div class="twinkle" style="left:62vw; top:78vh; animation-delay:.9s"></div>
  </div>

  <div class="app">
    <div class="shell" id="shell">
      <div class="topbar">
        <div class="brand" aria-label="GENCARE GENE4LIFE">
          <svg class="logoMark" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="GENCARE logo">
            <defs>
              <linearGradient id="lg" x1="0" x2="1">
                <stop offset="0" stop-color="#67c08f"/>
                <stop offset="1" stop-color="#2f8a5e"/>
              </linearGradient>
            </defs>
            <circle cx="32" cy="34" r="14" fill="url(#lg)" opacity=".95"/>
            <path d="M39 30c0-2 2-4 4-4s4 2 4 4-2 4-4 4c-1 0-2-.4-3-1v3h-6v-6h3c1-.7 2-1 2-1z"
                  fill="rgba(255,255,255,.95)" opacity=".9"/>
            <path d="M24 10c10 8 16 14 16 22s-6 14-16 22" fill="none" stroke="rgba(255,255,255,.9)" stroke-width="3.8" stroke-linecap="round"/>
            <path d="M40 10c-10 8-16 14-16 22s6 14 16 22" fill="none" stroke="rgba(255,255,255,.75)" stroke-width="3.8" stroke-linecap="round"/>
            <path d="M26 18h12M26 26h12M26 34h12M26 42h12M26 50h12" stroke="rgba(255,255,255,.65)" stroke-width="3" stroke-linecap="round"/>
          </svg>

          <span>GENCARE</span>
          <span class="sub">â€¢ GENE4LIFE</span>
        </div>

        <div class="right-actions">
          <button class="pill secondary" id="btnBack" title="Kthehu" style="display:none">â† Kthehu</button>
          <button class="pill" id="btnHome" title="Faqja Kryesore" style="display:none">ğŸ  Kryesore</button>
        </div>
      </div>

      <div class="content" id="view"></div>
    </div>
  </div>

<script>
/* =======================
   STORAGE + STATE
======================= */
const LS_USERS = "gencare_users_v1";
const LS_SESSION = "gencare_session_v1";
const LS_ROUTINE = "gencare_routine_v1";
const LS_BRAINAGE = "gencare_brainage_v1";

const state = {
  route: "landing",
  routeStack: [],
  infoTopicIndex: 0,
  selectedGameId: null,
  selectedLevel: 1,
  gameRuntime: null,

  // brain age
  brainAgeStep: 0,
  brainAgeScores: [],
};

const GAMES = [
  { id:"komunikimi", title:"Komunikimi", desc:"FjalÃ«, figura, shprehje â€” pÃ«r tÃ« ndihmuar komunikimin." },
  { id:"social", title:"Socializimi", desc:"Situata sociale dhe zgjedhje tÃ« thjeshta." },
  { id:"perqendrim", title:"TÃ« NxÃ«nit & PÃ«rqendrimi", desc:"KujtesÃ« e shpejtÃ« dhe fokus." },
  { id:"emocione", title:"Emocionet", desc:"Njohja e emocioneve nÃ« mÃ«nyrÃ« tÃ« qetÃ«." },
  { id:"sensori", title:"NdjeshmÃ«ria Sensorjale", desc:"Zgjedhje tÃ« buta â€” tinguj/ndjesi tÃ« imagjinuara." },
  { id:"koordinim", title:"LÃ«vizja & Koordinimi", desc:"Reagim i kontrolluar â€” prek/shfaq." },
];

const INFO_TOPICS = [
  {
    key:"komunikimi",
    title:"Komunikimi & Gjuha",
    bullets:[
      "Shenjat e para mund tÃ« shfaqen gradualisht: vonesÃ« nÃ« fjalÃ«, pak gjeste, ose vÃ«shtirÃ«si nÃ« pÃ«rdorimin e fjalÃ«ve pÃ«r kÃ«rkesa.",
      "Mund tÃ« vÃ«rehet pÃ«rsÃ«ritje fjalÃ«sh/frasash (ekolali) ose pÃ«rdorim i kufizuar i gjuhÃ«s funksionale.",
      "Ndihmon: rutinÃ« e qetÃ«, fjali tÃ« shkurtra, zgjedhje me 2 opsione, vizualÃ« (figura)."
    ]
  },
  {
    key:"social",
    title:"NdÃ«rveprimi Social & Kontakti me Sy",
    bullets:[
      "Mund tÃ« ketÃ« kontakt me sy tÃ« kufizuar, vÃ«shtirÃ«si nÃ« ndjekjen e lojÃ«s sÃ« pÃ«rbashkÃ«t, ose mungesÃ« interesi pÃ«r bashkÃ«moshatarÃ«t.",
      "Reagimi ndaj emrit mund tÃ« jetÃ« i dobÃ«t, ose preferon lojÃ« tÃ« vetmuar pÃ«r kohÃ« tÃ« gjatÃ«.",
      "Ndihmon: lojÃ«ra me radhÃ«, aktivitete tÃ« shkurtra bashkÃ«, lavdÃ«rim i qartÃ« dhe i butÃ«."
    ]
  },
  {
    key:"perqendrim",
    title:"TÃ« NxÃ«nit & PÃ«rqendrimi",
    bullets:[
      "VÃ«shtirÃ«si nÃ« fokus, kalim i shpejtÃ« nga njÃ« aktivitet tek tjetri, ose vÃ«mendje shumÃ« e lartÃ« vetÃ«m pÃ«r njÃ« interes specifik.",
      "Mund tÃ« ketÃ« sfida nÃ« ndjekjen e udhÃ«zimeve me shumÃ« hapa.",
      "Ndihmon: udhÃ«zime 1â€“2 hapa, pushime tÃ« shkurtra, strukturÃ« vizuale e ditÃ«s."
    ]
  },
  {
    key:"emocione",
    title:"Emocionet",
    bullets:[
      "VÃ«shtirÃ«si nÃ« shprehjen/kuptimin e emocioneve; shpÃ«rthime kur nuk kuptohet nevoja ose kur ka ndryshime tÃ« papritura.",
      "Rritje ankthi nÃ« ambiente tÃ« zhurmshme ose gjatÃ« tranzicioneve.",
      "Ndihmon: paralajmÃ«rime tÃ« buta pÃ«r ndryshime, â€œkarte emocioniâ€, frymÃ«marrje e udhÃ«zuar."
    ]
  },
  {
    key:"sensori",
    title:"NdjeshmÃ«ria Sensorjale",
    bullets:[
      "Reagime tÃ« forta ndaj dritÃ«s, zhurmÃ«s, prekjes, erÃ«rave ose teksturave tÃ« caktuara.",
      "Mund tÃ« kÃ«rkojÃ« stimulim (lÃ«kundje, rrotullim) ose tÃ« shmangÃ« disa ndjesi.",
      "Ndihmon: â€œkÃ«nd qetÃ«simiâ€, kufje, lodra sensoriale tÃ« buta, zgjedhje tÃ« kontrolluara."
    ]
  },
  {
    key:"koordinim",
    title:"LÃ«vizja & Koordinimi",
    bullets:[
      "Mund tÃ« ketÃ« vÃ«shtirÃ«si me motorikÃ«n e imÃ«t (laps, gÃ«rshÃ«rÃ«) ose koordinimin nÃ« lojÃ«ra fizike.",
      "Sjellje pÃ«rsÃ«ritÃ«se (p.sh. lÃ«kundje) mund tÃ« shÃ«rbejÃ« si vetÃ«rregullim.",
      "Ndihmon: ushtrime tÃ« shkurtra motorike, aktivitete me ritÃ«m tÃ« ngadaltÃ«, progres gradual."
    ]
  }
];

/* =======================
   STORAGE HELPERS
======================= */
function getUsers(){
  try{ return JSON.parse(localStorage.getItem(LS_USERS) || "[]"); }catch(e){ return []; }
}
function setUsers(users){ localStorage.setItem(LS_USERS, JSON.stringify(users)); }
function getSession(){
  try{ return JSON.parse(localStorage.getItem(LS_SESSION) || "null"); }catch(e){ return null; }
}
function setSession(s){ localStorage.setItem(LS_SESSION, JSON.stringify(s)); }
function clearSession(){ localStorage.removeItem(LS_SESSION); }
function currentUser(){
  const s = getSession();
  if(!s) return null;
  return getUsers().find(u => u.username === s.username) || null;
}
function updateUser(patch){
  const users = getUsers();
  const idx = users.findIndex(u => u.username === patch.username);
  if(idx>=0){
    users[idx] = { ...users[idx], ...patch };
    setUsers(users);
  }
}

function getBrainAgeStoreKey(){
  const u = currentUser();
  return u ? `${LS_BRAINAGE}_${u.username}` : `${LS_BRAINAGE}_guest`;
}
function loadBrainAge(){
  try{
    const raw = localStorage.getItem(getBrainAgeStoreKey());
    return raw ? JSON.parse(raw) : null;
  }catch(e){ return null; }
}
function saveBrainAge(obj){
  localStorage.setItem(getBrainAgeStoreKey(), JSON.stringify(obj));
}

/* =======================
   ROUTING
======================= */
const view = document.getElementById("view");
const btnBack = document.getElementById("btnBack");
const btnHome = document.getElementById("btnHome");

btnBack.addEventListener("click", () => popRoute());
btnHome.addEventListener("click", () => go("home"));

function go(route, params={}){
  stopGameRuntime();
  state.routeStack.push({ route: state.route, snapshot: snapshotState() });
  state.route = route;
  Object.assign(state, params);
  render();
}
function popRoute(){
  stopGameRuntime();
  const prev = state.routeStack.pop();
  if(!prev){ state.route="home"; render(); return; }
  state.route = prev.route;
  restoreSnapshot(prev.snapshot);
  render();
}
function snapshotState(){
  return {
    infoTopicIndex: state.infoTopicIndex,
    selectedGameId: state.selectedGameId,
    selectedLevel: state.selectedLevel,
    brainAgeStep: state.brainAgeStep,
    brainAgeScores: state.brainAgeScores,
  };
}
function restoreSnapshot(s){
  if(!s) return;
  state.infoTopicIndex = s.infoTopicIndex;
  state.selectedGameId = s.selectedGameId;
  state.selectedLevel = s.selectedLevel;
  state.brainAgeStep = s.brainAgeStep || 0;
  state.brainAgeScores = Array.isArray(s.brainAgeScores) ? s.brainAgeScores : [];
}
function setNavButtons(){
  const showBack = state.route !== "landing" && state.route !== "home";
  const showHome = state.route !== "landing";
  btnBack.style.display = showBack ? "inline-flex" : "none";
  btnHome.style.display = showHome ? "inline-flex" : "none";
}

/* =======================
   HELPERS
======================= */
function esc(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
function niceDate(d = new Date()){
  return d.toLocaleDateString("sq-AL", { weekday:"short", year:"numeric", month:"short", day:"2-digit" });
}
function ensureUserProgress(u){
  return {
    ...u,
    progress: u.progress || { games:{}, routines:{ streak:0, lastDay:null } },
    createdAt: u.createdAt || Date.now()
  };
}
function computeOverallProgress(u){
  u = ensureUserProgress(u);
  let total=0, done=0;
  for(const g of GAMES){
    for(let lvl=1; lvl<=5; lvl++){
      total++;
      if(u.progress.games?.[g.id]?.[lvl] === true) done++;
    }
  }
  const pct = total ? Math.round((done/total)*100) : 0;
  return { pct, done, total };
}

/* =======================
   RENDER
======================= */
function render(){
  setNavButtons();
  view.className = "view-anim";

  if(state.route === "landing") return renderLanding();
  if(state.route === "home") return renderHome();
  if(state.route === "manual") return renderManual();
  if(state.route === "profile") return renderProfile();
  if(state.route === "informohu") return renderInformohu();
  if(state.route === "infoTopic") return renderInfoTopic();
  if(state.route === "games") return renderGamesMenu();
  if(state.route === "gameLevels") return renderGameLevels();
  if(state.route === "gamePlay") return renderGamePlay();
  if(state.route === "change") return renderChange();
  if(state.route === "routine") return renderRoutine();
  if(state.route === "brainAge") return renderBrainAge();
  if(state.route === "result") return renderResult();

  view.innerHTML = `<div class="glass card-pad"><b>RrugÃ« e panjohur:</b> ${esc(state.route)}</div>`;
}

/* =======================
   SVG HELIX
======================= */
function helixSVG(opacity=1){
  return `
  <svg viewBox="0 0 220 520" class="helix-svg" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <defs>
      <linearGradient id="g1" x1="0" x2="1">
        <stop offset="0" stop-color="#67c08f" stop-opacity="${opacity}"/>
        <stop offset="1" stop-color="#2f8a5e" stop-opacity="${opacity}"/>
      </linearGradient>
      <linearGradient id="g2" x1="0" x2="1">
        <stop offset="0" stop-color="#9fe3c1" stop-opacity="${opacity}"/>
        <stop offset="1" stop-color="#43a874" stop-opacity="${opacity}"/>
      </linearGradient>
    </defs>

    <path d="M70,10 C160,60 160,120 70,170 C-20,220 -20,300 70,350 C160,400 160,460 70,510"
          fill="none" stroke="url(#g1)" stroke-width="10" stroke-linecap="round" opacity=".96"/>
    <path d="M150,10 C60,60 60,120 150,170 C240,220 240,300 150,350 C60,400 60,460 150,510"
          fill="none" stroke="url(#g2)" stroke-width="10" stroke-linecap="round" opacity=".92"/>

    ${Array.from({length:10}).map((_,i)=>{
      const y = 40 + i*48;
      const flip = i%2===0;
      return `<line x1="${flip?78:142}" y1="${y}" x2="${flip?142:78}" y2="${y+12}"
                    stroke="rgba(255,255,255,.55)" stroke-width="6" stroke-linecap="round"/>`;
    }).join("")}

    <circle cx="74" cy="40" r="4" fill="rgba(255,255,255,.55)"/>
    <circle cx="146" cy="92" r="4" fill="rgba(255,255,255,.50)"/>
    <circle cx="78" cy="244" r="4" fill="rgba(255,255,255,.45)"/>
    <circle cx="148" cy="410" r="4" fill="rgba(255,255,255,.40)"/>
  </svg>`;
}

/* =======================
   LANDING
======================= */
function renderLanding(){
  btnHome.style.display = "none";
  btnBack.style.display = "none";

  view.innerHTML = `
    <section class="landing">
      <div class="landing-center">
        <div style="display:flex; justify-content:center; gap:10px; align-items:center; margin-bottom:10px">
          <span style="font-weight:1000; letter-spacing:.12em; color:rgba(255,255,255,.88); text-transform:uppercase; font-size:12px">
            GENE4LIFE
          </span>
          <span style="opacity:.7; color:#fff">â€¢</span>
          <span style="font-weight:1000; letter-spacing:.12em; color:rgba(255,255,255,.88); text-transform:uppercase; font-size:12px">
            Informim & Stimulim
          </span>
        </div>

        <div class="gencare-link" id="enterGencare" role="button" tabindex="0" aria-label="Hyr nÃ« GENCARE">
          GENCARE
        </div>
        <div class="landing-slogan">Ndryshimet na bÃ«jnÃ« unike.</div>

        <div style="height:14px"></div>
        <div class="note" style="max-width:820px; margin:0 auto; background: rgba(255,255,255,.14); border-color: rgba(255,255,255,.28); color: rgba(255,255,255,.88)">
          <b>QÃ«llimi i website-it:</b> informim + lojÃ«ra stimuluese + pyetÃ«sorÃ« orientues + plan javor rutinash.
          <span style="opacity:.9">Nuk zÃ«vendÃ«son vlerÃ«simin profesional.</span>
        </div>
      </div>
    </section>
  `;

  const enter = document.getElementById("enterGencare");
  const open = () => {
    state.routeStack = [];
    state.route = "home";
    render();
  };
  enter.addEventListener("click", open);
  enter.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); open(); } });
}

/* =======================
   HOME
======================= */
function renderHome(){
  const u = currentUser();
  const overall = u ? computeOverallProgress(u) : null;

  view.innerHTML = `
    <div class="home-scroll">
      <div class="hero">
        <h1>GENCARE</h1>
        <p><b>MirÃ« se erdhÃ«t nÃ« website</b></p>
        <p>
          NjÃ« ndryshim i vogÃ«l nÃ« ADN nuk Ã«shtÃ« pengesÃ«. Me <b>GENE4LIFE</b>, Ã§do fÃ«mijÃ« mund tÃ« stimulohet,
          tÃ« mÃ«sojÃ« dhe tÃ« zhvillojÃ« aftÃ«sitÃ« e tij unike. Ndihmo fÃ«mijÃ«n tÃ« arrijÃ« potencialin e plotÃ«.
        </p>

        <div class="color-break"></div>

        <div class="row">
          <span class="pill secondary">Status: ${u ? "I identifikuar" : "Pa profil"}</span>
          ${u ? `<span class="pill secondary">PÃ«rdorues: <b>${esc(u.username)}</b></span>` : ""}
          ${u ? `<span class="pill secondary">Progres: <b>${overall.pct}%</b> (${overall.done}/${overall.total})</span>` : ""}
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="menu-grid">
        ${menuBtn("Manuali i pÃ«rdorimit","Si tÃ« pÃ«rdoret website-i (orientues, i qartÃ«).","manual")}
        ${menuBtn("Profili i fÃ«mijÃ«s","Krijo profil (username unik) dhe shiko progresin.","profile")}
        ${menuBtn("Informohu","Kliko nÃ« ADN dhe lexo informacionin pÃ«r Ã§do temÃ«.","informohu")}
        ${menuBtn("Lojrat","6 lojÃ«ra me 5 nivele â€“ me pauzÃ« & resume.","games")}
        ${menuBtn("Mosha e trurit","12 mini-lojÃ«ra â†’ vlerÃ«sim orientues i performancÃ«s (moshÃ«-ekuivalente).","brainAge")}
        ${menuBtn("Fillo Ndryshimin","PyetÃ«sor orientues (12 pyetje).","change")}
        ${menuBtn("Rutina Ime","PyetÃ«sor (20) + plan javor me checklist.","routine")}
      </div>

      <div style="height:14px"></div>
      <div class="note">
        <b>ShÃ«nim:</b> Ky website Ã«shtÃ« ndÃ«rtuar pÃ«r informim dhe stimulim. Nuk zÃ«vendÃ«son vlerÃ«simin profesional.
      </div>
    </div>
  `;
}

function menuBtn(t,d,route){
  return `
    <button class="bigbtn" data-route="${route}">
      <div class="t">${esc(t)}</div>
      <div class="d">${esc(d)}</div>
    </button>
  `;
}

view.addEventListener("click", (e)=>{
  const btn = e.target.closest("[data-route]");
  if(!btn) return;
  go(btn.getAttribute("data-route"));
});

/* =======================
   MANUAL
======================= */
function renderManual(){
  view.innerHTML = `
    <div class="glass card-pad stack">
      <div>
        <div class="section-title">Manuali i pÃ«rdorimit</div>
        <div class="muted small">Si mund ta pÃ«rdorÃ« prindi kÃ«tÃ« website, hap pas hapi.</div>
      </div>

      <div class="note">
        <b>1) Fillimi</b><br>
        Krijoni njÃ« profil tek <b>â€œProfili i fÃ«mijÃ«sâ€</b>. Kjo ruan progresin nÃ« pajisjen tuaj (localStorage).
      </div>

      <div class="note">
        <b>2) Informohu</b><br>
        Tek <b>â€œInformohuâ€</b> klikoni shenjÃ«n <b>!</b> nÃ« heliksin e ADN pÃ«r tÃ« lexuar tema tÃ« ndryshme.
      </div>

      <div class="note">
        <b>3) Lojrat</b><br>
        Zgjidhni njÃ« lojÃ« â†’ zgjidhni nivelin (1â€“5) â†’ luani. PÃ«rfundimi i nivelit shÃ«nohet nÃ« profil.
      </div>

      <div class="note">
        <b>4) PyetÃ«sorÃ«t</b><br>
        <b>â€œFillo Ndryshiminâ€</b> jep njÃ« vlerÃ«sim orientues (jo diagnozÃ«). <b>â€œRutina Imeâ€</b> krijon njÃ« plan javor.
      </div>

      <div class="note">
        <b>â€œMosha e truritâ€</b><br>
        Ã‹shtÃ« njÃ« seri mini-lojÃ«ra qÃ« japin njÃ« <b>vlerÃ«sim loje</b> (moshÃ«-ekuivalente e performancÃ«s). Nuk Ã«shtÃ« diagnozÃ«.
      </div>

      <div class="row">
        <button class="pill" onclick="go('home')">ğŸ  Ktheu nÃ« faqen kryesore</button>
      </div>
    </div>
  `;
}

/* =======================
   PROFILE
======================= */
function renderProfile(){
  const u = currentUser();

  if(!u){
    view.innerHTML = `
      <div class="grid2">
        <div class="glass card-pad stack">
          <div>
            <div class="section-title">Profili i fÃ«mijÃ«s</div>
            <div class="muted small">Krijo profil personal (username unik) dhe ruaj progresin.</div>
          </div>

          <div class="note">
            <b>Siguria:</b> TÃ« dhÃ«nat ruhen vetÃ«m nÃ« pajisjen tuaj (browser) dhe nuk dÃ«rgohen askund.
          </div>

          <form id="signupForm" class="stack">
            <div class="field"><label>Emri i prindit/kujdestarit ligjor</label><input required name="parentName" placeholder="p.sh. Renita"/></div>
            <div class="field"><label>Emri i fÃ«mijÃ«s</label><input required name="childName" placeholder="p.sh. Mateo"/></div>
            <div class="row">
              <div class="field" style="flex:1"><label>Mosha e fÃ«mijÃ«s</label><input required name="childAge" type="number" min="1" max="18" placeholder="p.sh. 8"/></div>
              <div class="field" style="flex:1"><label>Problemi i deklaruar/diagnostifikuar (opsional)</label><input name="declared" placeholder="opsional"/></div>
            </div>
            <div class="row">
              <div class="field" style="flex:1"><label>Adresa e gmail tÃ« prindit</label><input required name="gmail" type="email" placeholder="emri@gmail.com"/></div>
              <div class="field" style="flex:1"><label>Numri i kontaktit (opsional)</label><input name="phone" placeholder="+355 ..."/></div>
            </div>

            <div class="divider"></div>

            <div class="row">
              <div class="field" style="flex:1"><label>Username (unik)</label><input required name="username" placeholder="p.sh. gencare_prindi"/></div>
              <div class="field" style="flex:1"><label>Password (min 6 + karakter special)</label><input required name="password" type="password" placeholder="******"/></div>
            </div>

            <div class="row">
              <button class="pill" type="submit">Ruaj profilin</button>
              <button class="pill secondary" type="button" id="goLogin">Kam profil (Log in)</button>
            </div>

            <div class="note tiny" id="signupMsg" style="display:none"></div>
          </form>
        </div>

        <div class="glass card-pad stack">
          <div class="section-title">Pse profil?</div>
          <div class="muted small">
            Profili mban shÃ«nim:
            <ul>
              <li>Progresin nÃ« lojÃ«ra (nivel/yll)</li>
              <li>Streak tÃ« rutinÃ«s (ditÃ« rresht me aktivitete tÃ« kryera)</li>
              <li>Rezultatet orientuese tÃ« pyetÃ«sorÃ«ve</li>
              <li>Rezultatin e â€œMosha e truritâ€ (orientues)</li>
            </ul>
          </div>
          <div class="note">
            <b>KÃ«shillÃ«:</b> Filloni me nivelet 1â€“2 dhe rriteni gradualisht vÃ«shtirÃ«sinÃ«.
          </div>
        </div>
      </div>
    `;

    document.getElementById("goLogin").addEventListener("click", () => renderLoginInline());
    document.getElementById("signupForm").addEventListener("submit", (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const data = Object.fromEntries(fd.entries());

      const msg = document.getElementById("signupMsg");
      const users = getUsers();
      const username = String(data.username||"").trim().toLowerCase();

      if(username.length < 3){
        msg.style.display="block"; msg.textContent="Username duhet tÃ« ketÃ« tÃ« paktÃ«n 3 karaktere."; return;
      }
      if(users.some(u=>u.username === username)){
        msg.style.display="block"; msg.textContent="Ky username ekziston. Zgjidh njÃ« tjetÃ«r."; return;
      }
      const pw = String(data.password||"");
      if(pw.length < 6 || !/[^\w\s]/.test(pw)){
        msg.style.display="block";
        msg.textContent="Password duhet tÃ« ketÃ« min 6 karaktere dhe tÃ« paktÃ«n 1 karakter special (p.sh. ! @ #).";
        return;
      }

      const user = ensureUserProgress({
        username,
        password: pw,
        parentName: data.parentName.trim(),
        childName: data.childName.trim(),
        childAge: Number(data.childAge),
        declared: (data.declared||"").trim(),
        gmail: data.gmail.trim(),
        phone: (data.phone||"").trim(),
        createdAt: Date.now(),
        lastResults: {}
      });

      users.push(user);
      setUsers(users);
      setSession({ username });

      msg.style.display="block";
      msg.textContent="TÃ« dhÃ«nat tuaja u ruajtÃ«n. Duke rifreskuarâ€¦";
      setTimeout(()=>{ renderProfile(); }, 650);
    });

    return;
  }

  const fixed = ensureUserProgress(u);
  updateUser(fixed);
  const overall = computeOverallProgress(fixed);

  const streak = fixed.progress?.routines?.streak || 0;
  const lastDay = fixed.progress?.routines?.lastDay;

  const ba = fixed.lastResults?.brainAge;

  view.innerHTML = `
    <div class="glass card-pad stack">
      <div class="row" style="justify-content:space-between; align-items:flex-start">
        <div>
          <div class="section-title">Profili i fÃ«mijÃ«s</div>
          <div class="muted small">TÃ« dhÃ«nat u ruajtÃ«n â€” ky Ã«shtÃ« progresi aktual.</div>
        </div>
        <button class="pill secondary" id="logoutBtn">Dil (Log out)</button>
      </div>

      <div class="grid2">
        <div class="glass card-pad stack">
          <div class="row">
            <span class="pill secondary">Username: <b>${esc(fixed.username)}</b></span>
            <span class="pill secondary">Krijuar: <b>${niceDate(new Date(fixed.createdAt))}</b></span>
          </div>

          <div class="note">
            <b>Prindi/Kujdestari:</b> ${esc(fixed.parentName)}<br>
            <b>FÃ«mija:</b> ${esc(fixed.childName)} (${esc(fixed.childAge)} vjeÃ§)<br>
            <b>DiagnozÃ«/Problem (ops.):</b> ${esc(fixed.declared || "â€”")}<br>
            <b>Gmail:</b> ${esc(fixed.gmail)}<br>
            <b>Kontakt (ops.):</b> ${esc(fixed.phone || "â€”")}
          </div>

          <div class="note">
            <b>Streak i rutinÃ«s:</b> <b>${streak}</b> ditÃ« rresht<br>
            <span class="tiny muted">Dita e fundit e plotÃ«suar: ${esc(lastDay || "â€”")}</span>
          </div>

          <div class="note">
            <b>Mosha e trurit (orientuese):</b> ${ba ? `<b>${esc(ba.ageEq)} vjeÃ§</b> (skor mesatar: ${esc(ba.avgScore)}%)` : "â€”"}<br>
            <span class="tiny muted">Kjo Ã«shtÃ« moshÃ«-ekuivalente e performancÃ«s nÃ« lojÃ«ra, jo diagnozÃ«.</span>
          </div>

          <div>
            <div class="row" style="justify-content:space-between">
              <b>Progresi i lojÃ«rave</b>
              <span class="muted small">${overall.done}/${overall.total}</span>
            </div>
            <div class="progressbar"><div style="width:${overall.pct}%"></div></div>
            <div class="tiny muted" style="margin-top:6px">PÃ«rfunduar: <b>${overall.pct}%</b></div>
          </div>
        </div>

        <div class="glass card-pad stack">
          <div class="section-title">Detaje progresi</div>
          <div class="muted small">Kliko â€œLojratâ€ pÃ«r tÃ« vazhduar. KÃ«tu shfaqen nivelet e pÃ«rfunduara.</div>
          <div class="stack" style="gap:10px">
            ${GAMES.map(g=>{
              const map = fixed.progress.games?.[g.id] || {};
              const doneLvls = [1,2,3,4,5].filter(l=>map[l]===true).length;
              return `
                <div class="task">
                  <div>
                    <b>${esc(g.title)}</b><div class="tiny muted">${doneLvls}/5 nivele</div>
                  </div>
                  <span class="pill secondary">${doneLvls===5 ? "âœ…" : "â­"}</span>
                </div>
              `;
            }).join("")}
          </div>
        </div>
      </div>

      <div class="row">
        <button class="pill" onclick="go('home')">ğŸ  Ktheu nÃ« faqen kryesore</button>
      </div>
    </div>
  `;

  document.getElementById("logoutBtn").addEventListener("click", ()=>{
    clearSession();
    renderProfile();
  });
}

function renderLoginInline(){
  view.innerHTML = `
    <div class="glass card-pad stack" style="max-width:640px; margin:0 auto">
      <div>
        <div class="section-title">Log in</div>
        <div class="muted small">Fut username dhe password pÃ«r tÃ« hapur profilin.</div>
      </div>

      <form id="loginForm" class="stack">
        <div class="field"><label>Username</label><input required name="username" placeholder="username"/></div>
        <div class="field"><label>Password</label><input required type="password" name="password" placeholder="******"/></div>
        <div class="row">
          <button class="pill" type="submit">Hyr</button>
          <button class="pill secondary" type="button" onclick="go('profile')">Kthehu</button>
        </div>
        <div class="note tiny" id="loginMsg" style="display:none"></div>
      </form>
    </div>
  `;

  document.getElementById("loginForm").addEventListener("submit", (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const username = String(fd.get("username")||"").trim().toLowerCase();
    const password = String(fd.get("password")||"");

    const msg = document.getElementById("loginMsg");
    const u = getUsers().find(x => x.username===username && x.password===password);
    if(!u){
      msg.style.display="block";
      msg.textContent="TÃ« dhÃ«nat nuk pÃ«rputhen. Provo pÃ«rsÃ«ri.";
      return;
    }
    setSession({ username });
    renderProfile();
  });
}

/* =======================
   INFORMOHU
======================= */
function renderInformohu(){
  view.innerHTML = `
    <div class="dna-stage">
      <div class="glass dna-box">
        <div class="dna-bg"></div>
        ${helixSVG(.98)}

        ${INFO_TOPICS.map((t, i)=>{
          const pos = [
            {x: "62%", y:"18%"},
            {x: "48%", y:"30%"},
            {x: "60%", y:"42%"},
            {x: "46%", y:"56%"},
            {x: "58%", y:"70%"},
            {x: "50%", y:"83%"},
          ][i];

          const colors = ["#2f8a5e","#43a874","#67c08f","#7fd7ff","#ffd36a","#ff78b7"];
          const c = colors[i % colors.length];
          return `
            <div class="marker" data-topic="${i}" style="left:${pos.x}; top:${pos.y}">
              <span style="background:${c}">!</span>
            </div>
          `;
        }).join("")}
      </div>

      <div class="glass card-pad stack">
        <div>
          <div class="section-title">Informohu</div>
          <div class="muted small">
            Kliko shenjÃ«n <b>!</b> nÃ« ADN pÃ«r tÃ« hapur temÃ«n pÃ«rkatÃ«se. Pastaj mund tÃ« vazhdosh me shigjetÃ« tek tema tjetÃ«r.
          </div>
        </div>

        <div class="note">
          <b>Temat:</b>
          <ul class="small" style="margin:8px 0 0; color:rgba(12,23,18,.78)">
            ${INFO_TOPICS.map(t=>`<li>${esc(t.title)}</li>`).join("")}
          </ul>
        </div>

        <div class="row">
          <button class="pill" onclick="go('home')">ğŸ  Ktheu nÃ« faqen kryesore</button>
        </div>
      </div>
    </div>
  `;

  view.querySelectorAll("[data-topic]").forEach(el=>{
    el.addEventListener("click", ()=>{
      const idx = Number(el.getAttribute("data-topic"));
      state.infoTopicIndex = idx;
      go("infoTopic");
    });
  });
}

function renderInfoTopic(){
  const idx = state.infoTopicIndex || 0;
  const t = INFO_TOPICS[idx];

  const prevIdx = (idx - 1 + INFO_TOPICS.length) % INFO_TOPICS.length;
  const nextIdx = (idx + 1) % INFO_TOPICS.length;

  view.innerHTML = `
    <div class="glass card-pad stack" id="topicCard">
      <div class="row" style="justify-content:space-between; align-items:flex-start">
        <div>
          <div class="section-title">${esc(t.title)}</div>
          <div class="muted small">Kur shfaqen shenjat, si shfaqen, dhe Ã§farÃ« mund tÃ« ndihmojÃ« (orientuese).</div>
        </div>
        <div class="row">
          <button class="pill secondary" id="prevTopic">â†</button>
          <button class="pill secondary" id="nextTopic">â†’</button>
        </div>
      </div>

      <div class="note">
        <b>Informacion i pÃ«rgjithshÃ«m</b>
        <ul class="small" style="margin:8px 0 0; color:rgba(12,23,18,.78); line-height:1.55">
          ${t.bullets.map(b=>`<li>${esc(b)}</li>`).join("")}
        </ul>
      </div>

      <div class="note tiny">
        <b>Kujdes:</b> KÃ«to janÃ« informacione orientuese. PÃ«r shqetÃ«sime specifike, konsultohuni me specialist.
      </div>

      <div class="row">
        <button class="pill" onclick="go('home')">ğŸ  Ktheu nÃ« faqen kryesore</button>
        <button class="pill secondary" onclick="popRoute()">â†© Kthehu te ADN</button>
      </div>
    </div>
  `;

  document.getElementById("prevTopic").addEventListener("click", ()=>{
    state.infoTopicIndex = prevIdx; renderInfoTopic();
  });
  document.getElementById("nextTopic").addEventListener("click", ()=>{
    state.infoTopicIndex = nextIdx; renderInfoTopic();
  });
}

/* =======================
   GAMES MENU + LEVELS
======================= */
function renderGamesMenu(){
  view.innerHTML = `
    <div class="glass card-pad stack">
      <div>
        <div class="section-title">Lojrat</div>
        <div class="muted small">Zgjidh njÃ« lojÃ«. Secila ka 5 nivele (â­) dhe shÃ«non progresin nÃ« profil.</div>
      </div>

      <div class="game-grid">
        ${GAMES.map(g=>`
          <button class="bigbtn" data-game="${g.id}">
            <div class="t">${esc(g.title)}</div>
            <div class="d">${esc(g.desc)}</div>
          </button>
        `).join("")}
      </div>

      <div class="note tiny">
        <b>Pauz/Resume:</b> NÃ« lojÃ« do shohÃ«sh <b>pauzÃ«</b> (â–¶) dhe <b>resume</b> (||) sipas ikonave tÃ« kÃ«rkuara.
      </div>

      <div class="row">
        <button class="pill" onclick="go('home')">ğŸ  Ktheu nÃ« faqen kryesore</button>
      </div>
    </div>
  `;

  view.querySelectorAll("[data-game]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.selectedGameId = btn.getAttribute("data-game");
      go("gameLevels");
    });
  });
}

function renderGameLevels(){
  const g = GAMES.find(x=>x.id===state.selectedGameId) || GAMES[0];
  const u = currentUser();
  const doneMap = u?.progress?.games?.[g.id] || {};

  view.innerHTML = `
    <div class="glass card-pad stack">
      <div class="row" style="justify-content:space-between; align-items:flex-start">
        <div>
          <div class="section-title">${esc(g.title)}</div>
          <div class="muted small">Zgjidh nivelin e vÃ«shtirÃ«sisÃ« (â­1 mÃ« i thjeshti â†’ â­5 mÃ« i vÃ«shtiri).</div>
        </div>
        <button class="pill secondary" onclick="go('games')">â† Te Lojrat</button>
      </div>

      <div class="starrow">
        ${[1,2,3,4,5].map(l=>{
          const done = doneMap[l]===true;
          return `<div class="star" data-level="${l}" title="Niveli ${l}">${done ? "âœ…" : "â­"}</div>`;
        }).join("")}
      </div>

      <div class="note">
        <b>KÃ«shillÃ«:</b> NÃ«se fÃ«mija lodhet, pÃ«rdor pauzÃ« (â–¶) dhe vazhdo kur tÃ« jetÃ« gati.
      </div>

      <div class="row">
        <button class="pill" onclick="go('home')">ğŸ  Ktheu nÃ« faqen kryesore</button>
      </div>
    </div>
  `;

  view.querySelectorAll("[data-level]").forEach(el=>{
    el.addEventListener("click", ()=>{
      state.selectedLevel = Number(el.getAttribute("data-level"));
      go("gamePlay");
    });
  });
}

/* =======================
   GAME PLAY
======================= */
function renderGamePlay(){
  const g = GAMES.find(x=>x.id===state.selectedGameId) || GAMES[0];
  const lvl = state.selectedLevel || 1;
  const u = currentUser();

  view.innerHTML = `
    <div class="glass card-pad stack">
      <div class="row" style="justify-content:space-between; align-items:flex-start">
        <div>
          <div class="section-title">${esc(g.title)} â€¢ Niveli ${lvl}</div>
          <div class="muted small">Loja Ã«shtÃ« e thjeshtÃ«, qetÃ«suese dhe me progres gradual.</div>
        </div>
        <div class="row">
          <button class="pill secondary" onclick="go('gameLevels')">â† Nivelet</button>
          <button class="pill" onclick="go('home')">ğŸ  Kryesore</button>
        </div>
      </div>

      ${u ? "" : `<div class="note"><b>ShÃ«nim:</b> PÃ«r tÃ« ruajtur progresin, krijo profil tek â€œProfili i fÃ«mijÃ«sâ€.</div>`}

      <div class="glass game-board">
        <div class="game-hud">
          <span class="hud-chip" id="hudGoal">QÃ«llimi: â€”</span>
          <span class="hud-chip" id="hudScore">Progres: 0%</span>
          <div class="row" style="gap:10px">
            <div class="iconbtn" id="pauseBtn" title="PauzÃ« (â–¶)">
              <div class="tri"></div>
            </div>
            <div class="iconbtn" id="resumeBtn" title="Vazhdo (||)" style="display:none">
              <div class="bars"><i></i><i></i></div>
            </div>
          </div>
        </div>

        <div id="gameArea"></div>
      </div>

      <div class="row">
        <button class="pill secondary" id="endBtn">PÃ«rfundo & Kthehu</button>
      </div>
    </div>
  `;

  const gameArea = document.getElementById("gameArea");
  const hudGoal = document.getElementById("hudGoal");
  const hudScore = document.getElementById("hudScore");
  const pauseBtn = document.getElementById("pauseBtn");
  const resumeBtn = document.getElementById("resumeBtn");
  const endBtn = document.getElementById("endBtn");

  let paused = false;
  const runtime = {
    interval: null,
    timeout: null,
    cleanup: [],
    setPaused(v){
      paused = v;
      pauseBtn.style.display = paused ? "none" : "flex";
      resumeBtn.style.display = paused ? "flex" : "none";
    },
    isPaused(){ return paused; },
    clearAll(){
      if(runtime.interval) clearInterval(runtime.interval);
      if(runtime.timeout) clearTimeout(runtime.timeout);
      runtime.cleanup.forEach(fn=>{ try{fn()}catch{} });
      runtime.cleanup = [];
    }
  };
  state.gameRuntime = runtime;

  pauseBtn.addEventListener("click", ()=> runtime.setPaused(true));
  resumeBtn.addEventListener("click", ()=> runtime.setPaused(false));
  endBtn.addEventListener("click", ()=>{ finishGame(false); });

  function setGoal(s){ hudGoal.textContent = "QÃ«llimi: " + s; }
  function setPct(p){ hudScore.textContent = "Progres: " + p + "%"; }

  function finishGame(completed){
    runtime.clearAll();
    state.gameRuntime = null;

    if(completed){
      const u2 = currentUser();
      if(u2){
        const uu = ensureUserProgress(u2);
        uu.progress.games = uu.progress.games || {};
        uu.progress.games[g.id] = uu.progress.games[g.id] || {};
        uu.progress.games[g.id][lvl] = true;
        updateUser(uu);
      }
      gameArea.innerHTML = `
        <div class="note" style="margin-top:10px">
          <b>Bravo!</b> Niveli u pÃ«rfundua dhe u shÃ«nua nÃ« profil.
        </div>
        <div class="row" style="margin-top:10px">
          <button class="pill" onclick="go('home')">ğŸ  Ktheu nÃ« faqen kryesore</button>
          <button class="pill secondary" onclick="go('gameLevels')">â­ Zgjidh nivel tjetÃ«r</button>
        </div>
      `;
      pauseBtn.style.display="none";
      resumeBtn.style.display="none";
    }else{
      go("gameLevels");
    }
  }

  if(g.id === "komunikimi") return game_Communication(lvl, gameArea, setGoal, setPct, runtime, finishGame);
  if(g.id === "social") return game_Social(lvl, gameArea, setGoal, setPct, runtime, finishGame);
  if(g.id === "perqendrim") return game_Focus(lvl, gameArea, setGoal, setPct, runtime, finishGame);
  if(g.id === "emocione") return game_Emotions(lvl, gameArea, setGoal, setPct, runtime, finishGame);
  if(g.id === "sensori") return game_Sensory(lvl, gameArea, setGoal, setPct, runtime, finishGame);
  if(g.id === "koordinim") return game_Coordination(lvl, gameArea, setGoal, setPct, runtime, finishGame);
}

/* ==== GAME 1 (FIXED: unique targets per level) ==== */
function game_Communication(lvl, root, setGoal, setPct, rt, finish){
  const pool = [
    {w:"UjÃ«", p:"ğŸ«—"},{w:"BukÃ«", p:"ğŸ"},{w:"LibÃ«r", p:"ğŸ“˜"},{w:"Top", p:"âš½"},
    {w:"Gjumi", p:"ğŸŒ™"},{w:"Luaj", p:"ğŸ²"},{w:"MuzikÃ«", p:"ğŸµ"},{w:"Vizat", p:"âœï¸"},
    {w:"MollÃ«", p:"ğŸ"},{w:"Banane", p:"ğŸŒ"},{w:"Karrige", p:"ğŸª‘"},{w:"ShtÃ«pi", p:"ğŸ "},
    {w:"ZemÃ«r", p:"ğŸ’š"},{w:"Diell", p:"â˜€ï¸"},{w:"Lule", p:"ğŸŒ¼"},{w:"Qen", p:"ğŸ¶"},
  ];

  const itemCount = Math.min(6 + lvl, pool.length);
  const items = shuffle(pool).slice(0, itemCount);

  let targetCycle = shuffle(items).slice();
  let target = targetCycle.pop();

  let correct = 0;
  const need = Math.max(4, 4 + lvl);

  setGoal(`Kliko ikonÃ«n qÃ« pÃ«rputhet me fjalÃ«n: â€œ${target.w}â€ (duhen ${need} saktÃ«)`);
  setPct(0);

  function nextTarget(){
    if(targetCycle.length === 0) targetCycle = shuffle(items).slice();
    target = targetCycle.pop();
    setGoal(`Kliko ikonÃ«n qÃ« pÃ«rputhet me fjalÃ«n: â€œ${target.w}â€ (duhen ${need} saktÃ«)`);
  }

  renderTiles();

  function renderTiles(){
    root.innerHTML = `
      <div class="note small">Fjala: <b style="font-size:18px">${esc(target.w)}</b></div>
      <div class="tiles">
        ${items.map(it=>`<div class="tile" data-w="${esc(it.w)}" style="font-size:28px">${esc(it.p)}</div>`).join("")}
      </div>
    `;
    root.querySelectorAll(".tile").forEach(t=>{
      t.addEventListener("click", ()=>{
        if(rt.isPaused()) return;
        const w = t.getAttribute("data-w");
        if(w === target.w){
          t.classList.add("good");
          correct++;
          setPct(Math.min(100, Math.round((correct/need)*100)));
          if(correct >= need) return finish(true);
          setTimeout(()=>{
            t.classList.remove("good");
            nextTarget();
            renderTiles();
          }, 220);
        }else{
          t.classList.add("bad");
          setTimeout(()=>t.classList.remove("bad"), 220);
        }
      });
    });
  }
}

/* ==== GAME 2 ==== */
function game_Social(lvl, root, setGoal, setPct, rt, finish){
  const scenarios = [
    {q:"NjÃ« shok thotÃ«: â€œA luajmÃ« bashkÃ«?â€", a:["Po, hajde tÃ« luajmÃ«.","Ik.","Nuk e dÃ«gjoj."], ok:0},
    {q:"Kur dikush flet, Ã§farÃ« bÃ«jmÃ«?", a:["DÃ«gjojmÃ« dhe presim radhÃ«n.","Flasim mbi tÃ«.","Ikim."], ok:0},
    {q:"NÃ« radhÃ«, Ã§farÃ« Ã«shtÃ« e sjellshme?", a:["Presim radhÃ«n.","ShtyjmÃ« tÃ« parÃ«t.","Marrim pa pyetur."], ok:0},
    {q:"NÃ«se lodhem, mund tÃ« them:", a:["Kam nevojÃ« pÃ«r pushim.","Jam i keq.","Sâ€™di."], ok:0},
    {q:"Kur dua njÃ« lodÃ«r, mund tÃ« pyes:", a:["A mund ta marr, tÃ« lutem?","Ma jep tani!","E marr vetÃ«."], ok:0},
    {q:"Kur mbaroj lojÃ«n, mund tÃ« them:", a:["Faleminderit.","HÃ«.","Sâ€™ka gjÃ«."], ok:0},
    {q:"Kur jam i mÃ«rzitur, mund tÃ« them:", a:["MÃ« duhet pak qetÃ«si.","Do bÃ«rtas!","Do iki."], ok:0},
    {q:"Kur dikush bie, mund tÃ« them:", a:["A je mirÃ«?","Nuk mÃ« intereson.","Qesh."], ok:0},
  ];

  const rounds = Math.min(scenarios.length, Math.max(4, 3+lvl));
  let score = 0, idx = 0;
  const deck = shuffle(scenarios).slice(0, rounds);

  setGoal(`Zgjidh pÃ«rgjigjen mÃ« tÃ« sjellshme (duhen ${rounds} raunde).`);
  setPct(0);

  function draw(){
    const s = deck[idx];
    root.innerHTML = `
      <div class="note small"><b>Situata:</b> ${esc(s.q)}</div>
      <div class="stack" style="margin-top:10px">
        ${s.a.map((x,i)=>`<div class="tile" data-i="${i}" style="min-height:64px; font-size:14px">${esc(x)}</div>`).join("")}
      </div>
    `;
    root.querySelectorAll(".tile").forEach(t=>{
      t.addEventListener("click", ()=>{
        if(rt.isPaused()) return;
        const chosen = Number(t.getAttribute("data-i"));
        if(chosen === s.ok){
          t.classList.add("good");
          score++;
        }else{
          t.classList.add("bad");
        }
        setTimeout(()=>{
          idx++;
          setPct(Math.round((idx/rounds)*100));
          if(idx >= rounds) return finish(score >= Math.ceil(rounds*0.7));
          draw();
        }, 420);
      });
    });
  }
  draw();
}

/* ==== GAME 3 (FIXED: sequence without repeating numbers inside the sequence) ==== */
function game_Focus(lvl, root, setGoal, setPct, rt, finish){
  const size = Math.min(12, 6+lvl*2);
  const seqLen = Math.min(8, 3+lvl);
  let seq = [];
  let input = [];
  let showing = true;

  setGoal(`Mbaj mend sekuencÃ«n (gjatÃ«sia: ${seqLen}).`);
  setPct(0);

  const nums = Array.from({length:size}, (_,i)=>i+1);

  function newRound(){
    input = [];
    // sample without replacement
    seq = shuffle(nums).slice(0, seqLen);
    showing = true;
    render(true);
    showSequence();
  }

  function showSequence(){
    let i=0;
    const highlight = () => {
      if(rt.isPaused()) { rt.timeout = setTimeout(highlight, 200); return; }
      if(i>=seq.length){
        showing=false;
        render(false);
        return;
      }
      const n = seq[i];
      const el = root.querySelector(`[data-n="${n}"]`);
      if(el){
        el.classList.add("good");
        setTimeout(()=>el.classList.remove("good"), 260);
      }
      i++;
      rt.timeout = setTimeout(highlight, Math.max(320, 520 - lvl*50));
    };
    rt.timeout = setTimeout(highlight, 450);
  }

  function render(isShowing){
    root.innerHTML = `
      <div class="note small">
        ${isShowing ? "Shiko me qetÃ«siâ€¦" : "Tani pÃ«rsÃ«rite sekuencÃ«n duke klikuar numrat."}
      </div>
      <div class="tiles" style="margin-top:10px">
        ${nums.map(n=>`<div class="tile" data-n="${n}" style="font-size:16px">${n}</div>`).join("")}
      </div>
    `;

    root.querySelectorAll(".tile").forEach(t=>{
      t.addEventListener("click", ()=>{
        if(rt.isPaused()) return;
        if(showing) return;

        const n = Number(t.getAttribute("data-n"));
        input.push(n);

        const k = input.length - 1;
        if(n !== seq[k]){
          t.classList.add("bad");
          setTimeout(()=>finish(false), 520);
          return;
        }else{
          t.classList.add("good");
          setTimeout(()=>t.classList.remove("good"), 180);
        }

        setPct(Math.round((input.length/seqLen)*100));
        if(input.length >= seqLen){
          setTimeout(()=>finish(true), 320);
        }
      });
    });
  }

  newRound();
}

/* ==== GAME 4 (FIXED: unique targets + expanded pool) ==== */
function game_Emotions(lvl, root, setGoal, setPct, rt, finish){
  const faces = [
    {w:"I gÃ«zuar", f:"ğŸ˜Š"},
    {w:"I trishtuar", f:"ğŸ˜¢"},
    {w:"I zemÃ«ruar", f:"ğŸ˜ "},
    {w:"I frikÃ«suar", f:"ğŸ˜¨"},
    {w:"I befasuar", f:"ğŸ˜®"},
    {w:"I qetÃ«", f:"ğŸ˜Œ"},
    {w:"I hutuar", f:"ğŸ˜•"},
    {w:"I lodhur", f:"ğŸ˜´"},
    {w:"I turpshÃ«m", f:"ğŸ˜³"},
    {w:"I sÃ«murÃ«", f:"ğŸ¤¢"},
  ];

  const rounds = Math.min(faces.length, Math.max(4, 3 + lvl));
  let done = 0;
  let targetCycle = shuffle(faces).slice(0, rounds);

  setGoal(`Zgjidh fytyrÃ«n qÃ« pÃ«rputhet me emocionin (raunde: ${rounds}).`);
  setPct(0);

  function round(){
    const target = targetCycle[done];
    const optCount = Math.min(4, 2 + lvl);
    const distractors = shuffle(faces.filter(x=>x.w !== target.w)).slice(0, Math.max(2, optCount - 1));
    const opts = shuffle([target, ...distractors]);

    root.innerHTML = `
      <div class="note small">Emocioni: <b style="font-size:18px">${esc(target.w)}</b></div>
      <div class="tiles" style="margin-top:10px">
        ${opts.map(o=>`<div class="tile" data-w="${esc(o.w)}" style="font-size:32px">${esc(o.f)}</div>`).join("")}
      </div>
    `;

    root.querySelectorAll(".tile").forEach(t=>{
      t.addEventListener("click", ()=>{
        if(rt.isPaused()) return;
        const w = t.getAttribute("data-w");
        if(w === target.w){
          t.classList.add("good");
          done++;
          setPct(Math.round((done/rounds)*100));
          if(done >= rounds) return finish(true);
          setTimeout(round, 320);
        }else{
          t.classList.add("bad");
          setTimeout(()=>t.classList.remove("bad"), 220);
        }
      });
    });
  }

  round();
}

/* ==== GAME 5 (FIXED: more pairs + unique within level) ==== */
function game_Sensory(lvl, root, setGoal, setPct, rt, finish){
  const pairs = [
    {q:"ZhurmÃ« e lartÃ« apo zÃ« i butÃ«?", a:["ZÃ« i butÃ«","ZhurmÃ« e lartÃ«"], ok:0},
    {q:"DritÃ« e fortÃ« apo dritÃ« e ngrohtÃ«?", a:["DritÃ« e ngrohtÃ«","DritÃ« e fortÃ«"], ok:0},
    {q:"TeksturÃ« e ashpÃ«r apo e butÃ«?", a:["E butÃ«","E ashpÃ«r"], ok:0},
    {q:"ShumÃ« njerÃ«z apo kÃ«nd i qetÃ«?", a:["KÃ«nd i qetÃ«","ShumÃ« njerÃ«z"], ok:0},
    {q:"RitÃ«m i shpejtÃ« apo i ngadaltÃ«?", a:["I ngadaltÃ«","I shpejtÃ«"], ok:0},
    {q:"ErÃ« e fortÃ« apo erÃ« neutrale?", a:["ErÃ« neutrale","ErÃ« e fortÃ«"], ok:0},
    {q:"Prekje e papritur apo paralajmÃ«rim i butÃ«?", a:["ParalajmÃ«rim i butÃ«","Prekje e papritur"], ok:0},
    {q:"Ambient i ndriÃ§uar fort apo dritÃ« e ulÃ«t?", a:["DritÃ« e ulÃ«t","NdriÃ§im i fortÃ«"], ok:0},
    {q:"MuzikÃ« e fortÃ« apo muzikÃ« e butÃ«?", a:["MuzikÃ« e butÃ«","MuzikÃ« e fortÃ«"], ok:0},
    {q:"ShumÃ« ngjyra apo pak ngjyra?", a:["Pak ngjyra","ShumÃ« ngjyra"], ok:0},
  ];

  const rounds = Math.min(pairs.length, Math.max(4, 3+lvl));
  let i=0, ok=0;
  const deck = shuffle(pairs).slice(0, rounds);

  setGoal(`Zgjidh opsionin mÃ« qetÃ«sues (raunde: ${rounds}).`);
  setPct(0);

  function draw(){
    const s = deck[i];
    root.innerHTML = `
      <div class="note small"><b>Pyetje:</b> ${esc(s.q)}</div>
      <div class="row" style="margin-top:10px">
        ${s.a.map((x,idx)=>`<div class="tile" data-i="${idx}" style="flex:1; min-height:70px">${esc(x)}</div>`).join("")}
      </div>
    `;
    root.querySelectorAll(".tile").forEach(t=>{
      t.addEventListener("click", ()=>{
        if(rt.isPaused()) return;
        const chosen = Number(t.getAttribute("data-i"));
        if(chosen === s.ok){ ok++; t.classList.add("good"); } else t.classList.add("bad");
        i++;
        setPct(Math.round((i/rounds)*100));
        setTimeout(()=>{
          if(i>=rounds) return finish(ok >= Math.ceil(rounds*0.7));
          draw();
        }, 380);
      });
    });
  }
  draw();
}

/* ==== GAME 6 ==== */
function game_Coordination(lvl, root, setGoal, setPct, rt, finish){
  const needed = Math.max(8, 6 + lvl*4);
  let hit = 0;
  setGoal(`Prek shenjÃ«n qÃ« shfaqet (duhen ${needed} goditje tÃ« sakta).`);
  setPct(0);

  root.innerHTML = `
    <div class="note small">Prek shenjÃ«n kur shfaqet. Merr kohÃ«n tÃ«nde.</div>
    <div id="arena" class="glass" style="height:320px; border-radius:22px; position:relative; overflow:hidden; margin-top:10px; background: rgba(255,255,255,.20); border:1px solid rgba(255,255,255,.35)"></div>
  `;
  const arena = document.getElementById("arena");

  function spawn(){
    if(rt.isPaused()){ rt.timeout = setTimeout(spawn, 220); return; }

    arena.innerHTML = "";
    const b = document.createElement("div");
    b.className = "marker";
    b.style.width = "60px";
    b.style.height = "60px";
    b.style.borderRadius = "20px";
    b.style.left = (10 + Math.random()*80) + "%";
    b.style.top = (10 + Math.random()*70) + "%";

    const c = ["#2f8a5e","#43a874","#67c08f","#7fd7ff","#ffd36a","#ff78b7"][Math.floor(Math.random()*6)];
    b.innerHTML = `<span style="background:${c}; width:36px; height:36px">â—</span>`;
    arena.appendChild(b);

    b.addEventListener("click", ()=>{
      if(rt.isPaused()) return;
      hit++;
      setPct(Math.round((hit/needed)*100));
      b.style.transform = "translateY(2px) scale(.98)";
      if(hit>=needed) return finish(true);
      rt.timeout = setTimeout(spawn, Math.max(300, 900 - lvl*120));
    });

    rt.timeout = setTimeout(spawn, Math.max(700, 1400 - lvl*120));
  }

  spawn();
}

/* Stop running game when navigating */
function stopGameRuntime(){
  if(state.gameRuntime){
    try{ state.gameRuntime.clearAll(); }catch{}
    state.gameRuntime = null;
  }
}

/* =======================
   CHANGE (12 Q)
======================= */
function renderChange(){
  const questions = [
    "Reagon kur e thÃ«rrasin nÃ« emÃ«r?",
    "PÃ«rdor gjeste (tregon, tund kokÃ«n, etj.)?",
    "Ka kontakt me sy gjatÃ« komunikimit?",
    "Ndjek udhÃ«zime tÃ« thjeshta (1â€“2 hapa)?",
    "Preferon lojÃ« tÃ« pÃ«rbashkÃ«t me tÃ« tjerÃ«t?",
    "Ka sjellje pÃ«rsÃ«ritÃ«se (p.sh. lÃ«kundje, rrotullim objektesh)?",
    "Ka sensitivitet tÃ« lartÃ« ndaj zhurmÃ«s/dritÃ«s/prekjes?",
    "Ka vÃ«shtirÃ«si nÃ« ndryshime rutine?",
    "Shfaq interes tÃ« kufizuar pÃ«r lodra tÃ« ndryshme?",
    "PÃ«rdor fjalÃ«/frasÃ« tÃ« pÃ«rsÃ«ritura (ekolali)?",
    "Ka shpÃ«rthime emocionale kur nuk kuptohet nevoja?",
    "Preferon tÃ« luajÃ« vetÃ«m pÃ«r periudha tÃ« gjata?"
  ];

  view.innerHTML = `
    <div class="glass card-pad stack" id="changeCard">
      <div>
        <div class="section-title">Fillo Ndryshimin</div>
        <div class="muted small">PyetÃ«sor orientues (12 pyetje) â€” pÃ«rgjigju: RrallÃ« / MjaftueshÃ«m / Shpesh.</div>
      </div>

      <div class="note tiny">
        <b>ShÃ«nim:</b> Rezultati Ã«shtÃ« vetÃ«m orientues dhe nuk Ã«shtÃ« diagnozÃ«.
      </div>

      <form id="changeForm" class="stack">
        ${questions.map((q, i)=>questionBlock(q, "c"+i)).join("")}

        <div class="row">
          <button class="pill" type="submit">Shfaq rezultatin</button>
          <button class="pill secondary" type="button" onclick="go('home')">ğŸ  Ktheu nÃ« faqen kryesore</button>
        </div>
      </form>

      <div class="glass card-pad stack hidden" id="changeResult">
        <div class="section-title">Rezultati</div>
        <div class="note" id="changeText"></div>
        <div class="row">
          <button class="pill" id="saveChange">Ruaje nÃ« gallery</button>
          <button class="pill secondary" id="backChange">Kthehu te pyetÃ«sori</button>
        </div>
      </div>
    </div>
  `;

  const form = document.getElementById("changeForm");
  const resultBox = document.getElementById("changeResult");
  const text = document.getElementById("changeText");

  form.addEventListener("submit", (e)=>{
    e.preventDefault();
    const score = scoreScale(form, questions.length, "c");
    const pct = Math.round((score.maxScore? (score.sum/score.maxScore)*100 : 0));

    const msg = interpretPct(pct);
    text.innerHTML = `
      <div><b>Probabilitet orientues:</b> <span style="font-size:22px">${pct}%</span></div>
      <div class="small muted" style="margin-top:6px">${esc(msg)}</div>
      <div class="tiny muted" style="margin-top:10px">KÃ«shillÃ«: NÃ«se keni shqetÃ«sime, konsultohuni me specialist.</div>
    `;

    const u = currentUser();
    if(u){
      const uu = ensureUserProgress(u);
      uu.lastResults = uu.lastResults || {};
      uu.lastResults.change = { pct, at: Date.now() };
      updateUser(uu);
    }

    resultBox.classList.remove("hidden");
    form.classList.add("hidden");
  });

  document.getElementById("backChange").addEventListener("click", ()=>{
    resultBox.classList.add("hidden");
    form.classList.remove("hidden");
  });

  document.getElementById("saveChange").addEventListener("click", async ()=>{
    await saveElementAsImage(document.getElementById("changeCard"));
  });
}

/* =======================
   ROUTINE (20 Q + plan)
======================= */
function renderRoutine(){
  const questions = [
    "Ka vÃ«shtirÃ«si nÃ« ndryshime tÃ« papritura?",
    "Ka ndjeshmÃ«ri ndaj zhurmÃ«s/dritÃ«s?",
    "Shfaq sjellje pÃ«rsÃ«ritÃ«se?",
    "VÃ«shtirÃ«si nÃ« kontakt me sy?",
    "VÃ«shtirÃ«si nÃ« ndarjen e lodrave?",
    "Ndjek udhÃ«zime me 2 hapa?",
    "Ka shpÃ«rthime emocionale?",
    "Preferon lojÃ« tÃ« vetmuar?",
    "Ka interes tÃ« ngushtÃ« pÃ«r njÃ« temÃ«?",
    "Ka vÃ«shtirÃ«si nÃ« gjumÃ«/ritÃ«m ditor?",
    "VÃ«shtirÃ«si nÃ« komunikim tÃ« kÃ«rkesave?",
    "VÃ«shtirÃ«si nÃ« pritjen e radhÃ«s?",
    "VÃ«shtirÃ«si nÃ« motorikÃ«n e imÃ«t (laps, gÃ«rshÃ«rÃ«)?",
    "VÃ«shtirÃ«si nÃ« motorikÃ«n e madhe (ekuilibÃ«r)?",
    "VÃ«shtirÃ«si nÃ« pÃ«rqendrim?",
    "Reagon dobÃ«t ndaj emrit?",
    "VÃ«shtirÃ«si nÃ« lojÃ« imagjinative?",
    "Shpesh stres nÃ« ambiente sociale?",
    "Preferon rutinÃ« shumÃ« tÃ« rreptÃ«?",
    "Ka vÃ«shtirÃ«si nÃ« kuptimin e emocioneve tÃ« tÃ« tjerÃ«ve?"
  ];

  const u = currentUser();

  view.innerHTML = `
    <div class="glass card-pad stack" id="routineCard">
      <div>
        <div class="section-title">Rutina Ime</div>
        <div class="muted small">
          PyetÃ«sor (20) â†’ gjeneron plan javor me aktivitete. Ã‡do aktivitet ka check. DitÃ«t e plota numÃ«rohen si streak.
        </div>
      </div>

      ${u ? "" : `<div class="note"><b>ShÃ«nim:</b> PÃ«r streak dhe ruajtje, krijo profil tek â€œProfili i fÃ«mijÃ«sâ€.</div>`}

      <form id="routineForm" class="stack">
        ${questions.map((q, i)=>questionBlock(q, "r"+i)).join("")}

        <div class="row">
          <button class="pill" type="submit">Gjenero planin javor</button>
          <button class="pill secondary" type="button" onclick="go('home')">ğŸ  Ktheu nÃ« faqen kryesore</button>
        </div>
      </form>

      <div class="glass card-pad stack hidden" id="planBox">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="section-title">Plani Javor</div>
            <div class="muted small">Aktivitetet janÃ« tÃ« sugjeruara sipas pÃ«rgjigjeve.</div>
          </div>
          <button class="pill secondary" id="editRoutine">â†© Ndrysho pyetÃ«sorin</button>
        </div>

        <div class="note tiny" id="planNote"></div>
        <div id="planDays" class="stack"></div>

        <div class="row">
          <button class="pill" id="saveRoutine">Ruaje nÃ« gallery</button>
          <button class="pill secondary" onclick="go('home')">ğŸ  Ktheu nÃ« faqen kryesore</button>
        </div>
      </div>
    </div>
  `;

  const form = document.getElementById("routineForm");
  const planBox = document.getElementById("planBox");
  const planDays = document.getElementById("planDays");
  const planNote = document.getElementById("planNote");

  form.addEventListener("submit", (e)=>{
    e.preventDefault();
    const score = scoreScale(form, questions.length, "r");
    const pct = Math.round((score.maxScore? (score.sum/score.maxScore)*100 : 0));

    const emphasis = getEmphasisFromAnswers(score.answers, pct);
    const plan = buildWeeklyPlan(emphasis);

    const key = routineKeyForUser();
    localStorage.setItem(key, JSON.stringify({ createdAt: Date.now(), emphasis, plan, checks:{} }));

    const uu = currentUser();
    if(uu){
      const u2 = ensureUserProgress(uu);
      u2.lastResults = u2.lastResults || {};
      u2.lastResults.routine = { pct, emphasis, at: Date.now() };
      updateUser(u2);
    }

    showPlan(plan, emphasis);
  });

  document.getElementById("editRoutine").addEventListener("click", ()=>{
    planBox.classList.add("hidden");
    form.classList.remove("hidden");
  });

  document.getElementById("saveRoutine").addEventListener("click", async ()=>{
    await saveElementAsImage(document.getElementById("routineCard"));
  });

  const existing = loadRoutine();
  if(existing){
    showPlan(existing.plan, existing.emphasis, true);
  }

  function showPlan(plan, emphasis, existing=false){
    form.classList.add("hidden");
    planBox.classList.remove("hidden");

    planNote.innerHTML = `
      <b>Fokus:</b> ${esc(emphasis.join(", "))}<br>
      <span class="muted">Plani Ã«shtÃ« ${existing ? "i ruajtur nga mÃ« parÃ«" : "gjeneruar tani"} dhe mund tÃ« kontrollohet me checklist.</span>
    `;

    const store = loadRoutine() || { checks:{} };
    const checks = store.checks || {};

    planDays.innerHTML = plan.map((day, di)=>{
      const dayKey = `d${di}`;
      const allChecked = day.tasks.every((_,ti)=>checks[`${dayKey}_t${ti}`]===true);

      return `
        <div class="glass card-pad stack">
          <div class="row" style="justify-content:space-between">
            <b>${esc(day.name)}</b>
            <span class="pill secondary">${allChecked ? "âœ… Dita e plotÃ«" : "â˜‘ï¸ Checklist"}</span>
          </div>
          ${day.tasks.map((t, ti)=>{
            const k = `${dayKey}_t${ti}`;
            const on = checks[k]===true;
            return `
              <div class="task">
                <div>
                  <b>${esc(t.title)}</b>
                  <div class="tiny muted">${esc(t.how)}</div>
                </div>
                <div class="check ${on ? "on":""}" data-check="${k}">${on ? "âœ“" : ""}</div>
              </div>
            `;
          }).join("")}
        </div>
      `;
    }).join("");

    planDays.querySelectorAll("[data-check]").forEach(el=>{
      el.addEventListener("click", ()=>{
        const k = el.getAttribute("data-check");
        const store = loadRoutine() || { checks:{} };
        store.checks = store.checks || {};
        store.checks[k] = !store.checks[k];
        saveRoutine(store);
        showPlan(plan, emphasis, true);
        maybeUpdateStreak(plan, store.checks);
      });
    });

    maybeUpdateStreak(plan, checks);
  }
}

/* =======================
   MOSHA E TRURIT (12 MINI-GAMES)
   - â€œAge-equivalent performanceâ€ only (not diagnosis)
======================= */
function renderBrainAge(){
  const u = currentUser();
  const suggestedAge = u?.childAge ? Number(u.childAge) : 8;

  const existing = loadBrainAge();
  const last = existing?.result;

  view.innerHTML = `
    <div class="glass card-pad stack" id="brainAgeCard">
      <div class="row" style="justify-content:space-between; align-items:flex-start">
        <div>
          <div class="section-title">Mosha e trurit</div>
          <div class="muted small">
            12 mini-lojÃ«ra tÃ« qeta â†’ nxjerrin <b>moshÃ«-ekuivalente tÃ« performancÃ«s</b> (orientuese).
          </div>
        </div>
        <button class="pill secondary" onclick="go('home')">ğŸ  Kryesore</button>
      </div>

      <div class="note tiny">
        <b>Kujdes:</b> Ky nuk Ã«shtÃ« test IQ dhe nuk jep diagnozÃ«. Ã‹shtÃ« vetÃ«m â€œmoshÃ« lojeâ€ (performancÃ« nÃ« mini-lojÃ«ra).
        PÃ«r vlerÃ«sim klinik, konsultohuni me specialist.
      </div>

      <div class="grid2">
        <div class="glass card-pad stack">
          <div class="section-title">Para se tÃ« fillosh</div>
          <div class="muted small">
            Zgjidh moshÃ«n kronologjike tÃ« fÃ«mijÃ«s (pÃ«r llogaritjen e moshÃ«s-ekuivalente).
          </div>

          <div class="row">
            <div class="field" style="flex:1">
              <label>Mosha kronologjike (vjeÃ§)</label>
              <input id="brainAgeInput" type="number" min="1" max="18" value="${esc(suggestedAge)}"/>
            </div>
          </div>

          <div class="row">
            <button class="pill" id="startBrainAge">Fillo 12 lojÃ«rat</button>
            <button class="pill secondary" id="resumeBrainAge">Vazhdo nga ku mbete</button>
          </div>

          ${last ? `
            <div class="note">
              <b>Rezultati i fundit (orientues):</b><br>
              Mosha-ekuivalente: <b>${esc(last.ageEq)} vjeÃ§</b><br>
              Skor mesatar: <b>${esc(last.avgScore)}%</b><br>
              <span class="tiny muted">Ruajtur: ${niceDate(new Date(last.at))}</span>
            </div>
          ` : `
            <div class="note tiny">Nuk ka rezultat tÃ« ruajtur ende.</div>
          `}
        </div>

        <div class="glass card-pad stack">
          <div class="section-title">Si funksionon</div>
          <div class="muted small">
            - 12 lojÃ«ra tÃ« shkurtra (30â€“60 sek secila)<br>
            - PÃ«r secilÃ«n lojÃ« merret njÃ« skor (0â€“100)<br>
            - Skori mesatar kthehet nÃ« â€œmoshÃ« lojeâ€ (orientuese)
          </div>
          <div class="note">
            <b>KÃ«shillÃ« pÃ«r autizÃ«m:</b> Mbaje ambientin e qetÃ«, pÃ«rdor pauza, dhe mos e bÃ«j me nxitim.
          </div>
        </div>
      </div>

      <div class="glass card-pad stack hidden" id="brainAgePlayBox">
        <div class="row" style="justify-content:space-between; align-items:center">
          <div class="row" style="gap:10px; align-items:center">
            <span class="pill secondary" id="brainAgeTitle">Loja 1/12</span>
            <span class="pill secondary" id="brainAgeHint">â€”</span>
          </div>
          <div class="row" style="gap:10px">
            <button class="pill secondary" id="brainAgeQuit">Pusho & kthehu</button>
          </div>
        </div>

        <div class="stepper" id="brainAgeStepper"></div>
        <div id="brainAgeArea"></div>
      </div>

      <div class="glass card-pad stack hidden" id="brainAgeResultBox">
        <div class="section-title">Rezultati (orientues)</div>
        <div class="note" id="brainAgeResultText"></div>
        <div class="row">
          <button class="pill" id="brainAgeSaveImg">Ruaje nÃ« gallery</button>
          <button class="pill secondary" id="brainAgeAgain">BÃ«je pÃ«rsÃ«ri</button>
          <button class="pill secondary" onclick="go('home')">ğŸ  Kryesore</button>
        </div>
      </div>
    </div>
  `;

  const startBtn = document.getElementById("startBrainAge");
  const resumeBtn = document.getElementById("resumeBrainAge");
  const playBox = document.getElementById("brainAgePlayBox");
  const resBox = document.getElementById("brainAgeResultBox");
  const area = document.getElementById("brainAgeArea");
  const titleEl = document.getElementById("brainAgeTitle");
  const hintEl = document.getElementById("brainAgeHint");
  const stepperEl = document.getElementById("brainAgeStepper");
  const quitBtn = document.getElementById("brainAgeQuit");

  const ageInput = document.getElementById("brainAgeInput");

  function resetRun(){
    state.brainAgeStep = 0;
    state.brainAgeScores = [];
    saveBrainAge({ progress:{ step:0, scores:[] }, chronoAge: Number(ageInput.value||suggestedAge) });
  }

  function loadRun(){
    const store = loadBrainAge();
    if(store?.progress){
      state.brainAgeStep = Number(store.progress.step||0);
      state.brainAgeScores = Array.isArray(store.progress.scores) ? store.progress.scores : [];
    }else{
      resetRun();
    }
  }

  startBtn.addEventListener("click", ()=>{
    resetRun();
    startPlay();
  });

  resumeBtn.addEventListener("click", ()=>{
    loadRun();
    startPlay();
  });

  quitBtn.addEventListener("click", ()=>{
    // save progress
    saveBrainAge({ progress:{ step: state.brainAgeStep, scores: state.brainAgeScores }, chronoAge: Number(ageInput.value||suggestedAge), result: loadBrainAge()?.result || null });
    playBox.classList.add("hidden");
    resBox.classList.add("hidden");
    // show setup again
    renderBrainAge();
  });

  function startPlay(){
    playBox.classList.remove("hidden");
    resBox.classList.add("hidden");
    runStep();
  }

  const games12 = [
    { key:"tap", name:"Reagim i butÃ«", hint:"Prek yllin 6 herÃ«", run: miniTap },
    { key:"match", name:"PÃ«rputhje figurash", hint:"Gjej Ã§iftet (2x3)", run: miniMatchPairs },
    { key:"odd", name:"Gjeje tÃ« ndryshmen", hint:"Zgjidh atÃ« qÃ« sâ€™pÃ«rket", run: miniOddOneOut },
    { key:"mem2", name:"KujtesÃ« e shpejtÃ«", hint:"Mbaj mend 3 numra", run: miniMemorySequence },
    { key:"count", name:"NumÃ«rim i qetÃ«", hint:"Zgjidh numrin e saktÃ«", run: miniCounting },
    { key:"order", name:"Renditje", hint:"Nga mÃ« e vogla tek mÃ« e madhja", run: miniOrder },
    { key:"em", name:"Emocione tÃ« buta", hint:"Zgjidh fytyrÃ«n e duhur", run: miniEmotionPick },
    { key:"color", name:"Ngjyra", hint:"Gjej ngjyrÃ«n e kÃ«rkuar", run: miniColorPick },
    { key:"shape", name:"Forma", hint:"Gjej formÃ«n e kÃ«rkuar", run: miniShapePick },
    { key:"focus", name:"Fokus i shkurtÃ«r", hint:"Prek vetÃ«m â€œâ—â€", run: miniSelectiveAttention },
    { key:"route", name:"Ndjekje udhÃ«zimi", hint:"Zgjidh veprimin e sjellshÃ«m", run: miniSocialChoice },
    { key:"final", name:"Puzzle i lehtÃ«", hint:"Zgjidh pjesÃ«n qÃ« plotÃ«son", run: miniPuzzleFill },
  ];

  function renderStepper(){
    stepperEl.innerHTML = games12.map((_,i)=>`<div class="stepDot ${i===state.brainAgeStep?'on':''}">${i+1}</div>`).join("");
  }

  async function runStep(){
    const idx = state.brainAgeStep || 0;
    if(idx >= games12.length){
      return showResult();
    }

    renderStepper();

    const g = games12[idx];
    titleEl.textContent = `Loja ${idx+1}/12 â€¢ ${g.name}`;
    hintEl.textContent = g.hint;

    // ensure chrono age saved
    const chronoAge = Number(ageInput.value || suggestedAge);
    saveBrainAge({ progress:{ step: state.brainAgeStep, scores: state.brainAgeScores }, chronoAge, result: loadBrainAge()?.result || null });

    area.innerHTML = `<div class="note small">Duke u pÃ«rgatiturâ€¦</div>`;
    const score = await g.run(area);
    const s = clampInt(score, 0, 100);

    state.brainAgeScores[idx] = s;
    state.brainAgeStep = idx + 1;

    saveBrainAge({ progress:{ step: state.brainAgeStep, scores: state.brainAgeScores }, chronoAge, result: loadBrainAge()?.result || null });

    // short calm transition
    area.innerHTML = `
      <div class="note">
        <b>Skori i lojÃ«s:</b> <span style="font-size:20px">${s}%</span><br>
        <span class="tiny muted">KalojmÃ« te loja tjetÃ«râ€¦</span>
      </div>
    `;
    setTimeout(runStep, 650);
  }

  function showResult(){
    playBox.classList.add("hidden");
    resBox.classList.remove("hidden");

    const chronoAge = Number(ageInput.value || suggestedAge);
    const scores = state.brainAgeScores.filter(x => typeof x === "number");
    const avg = scores.length ? Math.round(scores.reduce((a,b)=>a+b,0)/scores.length) : 0;

    // Map avgScore -> age equivalent (0% => 40% of age; 100% => 120% of age)
    const factor = 0.4 + 0.8*(avg/100);
    const ageEq = clampInt(Math.round(chronoAge * factor), 2, 18);

    const msg = brainAgeMessage(avg);

    const result = { ageEq, avgScore: avg, chronoAge, scores, at: Date.now() };

    // save to profile if exists
    const uu = currentUser();
    if(uu){
      const u2 = ensureUserProgress(uu);
      u2.lastResults = u2.lastResults || {};
      u2.lastResults.brainAge = result;
      updateUser(u2);
    }

    // save store
    saveBrainAge({ progress:{ step:0, scores:[] }, chronoAge, result });

    const box = document.getElementById("brainAgeResultText");
    box.innerHTML = `
      <div><b>Mosha kronologjike:</b> ${esc(chronoAge)} vjeÃ§</div>
      <div><b>Skor mesatar:</b> <span style="font-size:22px">${esc(avg)}%</span></div>
      <div style="margin-top:8px"><b>Mosha-ekuivalente e performancÃ«s (orientuese):</b> <span style="font-size:22px">${esc(ageEq)} vjeÃ§</span></div>
      <div class="small muted" style="margin-top:8px">${esc(msg)}</div>
      <div class="tiny muted" style="margin-top:10px">
        Kjo Ã«shtÃ« â€œmoshÃ« lojeâ€ dhe mund tÃ« ndryshojÃ« shumÃ« nga dita nÃ« ditÃ« (lodhje, motivim, stres, etj.).
      </div>
    `;

    document.getElementById("brainAgeAgain").addEventListener("click", ()=>{
      state.brainAgeStep = 0;
      state.brainAgeScores = [];
      renderBrainAge();
    });

    document.getElementById("brainAgeSaveImg").addEventListener("click", async ()=>{
      await saveElementAsImage(document.getElementById("brainAgeCard"));
    });
  }
}

/* ----- 12 MINI GAMES (all calm, no harsh timers) ----- */
function miniTap(root){
  return new Promise(resolve=>{
    let hit = 0;
    const need = 6;
    root.innerHTML = `
      <div class="note small">Prek yllin kur e sheh. Duhet: <b>${need}</b> herÃ«.</div>
      <div id="tapArena" class="glass" style="height:320px; border-radius:22px; position:relative; overflow:hidden; margin-top:10px; background: rgba(255,255,255,.20); border:1px solid rgba(255,255,255,.35)"></div>
      <div class="row" style="margin-top:10px"><span class="pill secondary" id="tapHud">0/${need}</span></div>
    `;
    const arena = root.querySelector("#tapArena");
    const hud = root.querySelector("#tapHud");

    function spawn(){
      arena.innerHTML = "";
      const b = document.createElement("div");
      b.className = "marker";
      b.style.width="64px"; b.style.height="64px"; b.style.borderRadius="22px";
      b.style.left = (8 + Math.random()*84) + "%";
      b.style.top  = (10 + Math.random()*72) + "%";
      const c = ["#2f8a5e","#43a874","#67c08f","#7fd7ff","#ffd36a","#ff78b7"][Math.floor(Math.random()*6)];
      b.innerHTML = `<span style="background:${c}; width:38px; height:38px">â˜…</span>`;
      arena.appendChild(b);

      b.addEventListener("click", ()=>{
        hit++;
        hud.textContent = `${hit}/${need}`;
        b.style.transform="translateY(2px) scale(.98)";
        if(hit>=need){
          // score: always 100 here (no timer stress)
          return resolve(100);
        }
        setTimeout(spawn, 380);
      });
    }
    spawn();
  });
}

function miniMatchPairs(root){
  // 2x3 pairs = 6 tiles (3 pairs)
  return new Promise(resolve=>{
    const icons = shuffle(["ğŸ","ğŸŒ","ğŸ“","ğŸ‡","ğŸ‰","ğŸŠ","ğŸ¶","ğŸ±","ğŸ¼","ğŸ¦Š"]).slice(0,3);
    const deck = shuffle([...icons, ...icons]);
    let open = [];
    let matched = 0;
    let moves = 0;

    root.innerHTML = `
      <div class="note small">Gjej Ã§iftet. Prek 2 karta. QÃ«llimi: 3 Ã§ifte.</div>
      <div class="tiles" style="grid-template-columns: repeat(3, 1fr);">
        ${deck.map((x,i)=>`<div class="tile" data-i="${i}" style="font-size:30px">?</div>`).join("")}
      </div>
      <div class="row"><span class="pill secondary" id="mpHud">Ã‡ifte: 0/3</span></div>
    `;
    const hud = root.querySelector("#mpHud");
    const tiles = [...root.querySelectorAll(".tile")];

    function reveal(i){
      tiles[i].textContent = deck[i];
      tiles[i].classList.add("good");
    }
    function hide(i){
      tiles[i].textContent = "?";
      tiles[i].classList.remove("good");
      tiles[i].classList.remove("bad");
    }

    tiles.forEach(t=>{
      t.addEventListener("click", ()=>{
        const i = Number(t.getAttribute("data-i"));
        if(t.getAttribute("data-done")==="1") return;
        if(open.includes(i)) return;
        if(open.length===2) return;

        reveal(i);
        open.push(i);

        if(open.length===2){
          moves++;
          const [a,b] = open;
          if(deck[a] === deck[b]){
            tiles[a].setAttribute("data-done","1");
            tiles[b].setAttribute("data-done","1");
            matched++;
            hud.textContent = `Ã‡ifte: ${matched}/3`;
            open = [];
            if(matched===3){
              // score based on moves (best 3 moves)
              const score = clampInt(Math.round(100 - (moves-3)*15), 55, 100);
              return resolve(score);
            }
          }else{
            tiles[a].classList.add("bad");
            tiles[b].classList.add("bad");
            setTimeout(()=>{
              hide(a); hide(b);
              open = [];
            }, 520);
          }
        }
      });
    });
  });
}

function miniOddOneOut(root){
  return new Promise(resolve=>{
    const rounds = 5;
    let i=0, ok=0;

    function round(){
      const sets = [
        {items:["ğŸ","ğŸ","ğŸŒ","ğŸ¶"], odd:3},
        {items:["âš½","ğŸ€","ğŸ¾","ğŸ"], odd:3},
        {items:["ğŸš—","ğŸšŒ","ğŸš²","ğŸ‡"], odd:3},
        {items:["ğŸŒ™","â­","â˜€ï¸","ğŸ§¦"], odd:3},
        {items:["ğŸ±","ğŸ¶","ğŸ°","ğŸ¥•"], odd:3},
        {items:["ğŸ“˜","âœï¸","ğŸ§ ","ğŸŠ"], odd:3},
      ];
      const s = shuffle(sets)[0];

      root.innerHTML = `
        <div class="note small">Gjeje tÃ« ndryshmen. Raundi: <b>${i+1}/${rounds}</b></div>
        <div class="tiles" style="grid-template-columns: repeat(4, 1fr);">
          ${s.items.map((x,idx)=>`<div class="tile" data-i="${idx}" style="font-size:30px">${x}</div>`).join("")}
        </div>
      `;

      root.querySelectorAll(".tile").forEach(t=>{
        t.addEventListener("click", ()=>{
          const idx = Number(t.getAttribute("data-i"));
          if(idx===s.odd){ ok++; t.classList.add("good"); } else t.classList.add("bad");
          i++;
          setTimeout(()=>{
            if(i>=rounds){
              const score = Math.round((ok/rounds)*100);
              return resolve(score);
            }
            round();
          }, 420);
        });
      });
    }
    round();
  });
}

function miniMemorySequence(root){
  return new Promise(resolve=>{
    const rounds = 3;
    let done=0, ok=0;

    function next(){
      const seqLen = 3;
      const nums = shuffle([1,2,3,4,5,6,7,8,9]).slice(0, seqLen);
      root.innerHTML = `
        <div class="note small">Shiko 3 numra pÃ«r 2 sekonda, pastaj zgjidhi nÃ« rend.</div>
        <div class="note" style="text-align:center; font-size:34px; font-weight:1000">${nums.join("  ")}</div>
      `;
      setTimeout(()=>{
        const opts = shuffle([ ...nums, ...shuffle([1,2,3,4,5,6,7,8,9].filter(x=>!nums.includes(x))).slice(0,3) ]);
        let input=[];
        root.innerHTML = `
          <div class="note small">Zgjidh numrat nÃ« rend: (raundi ${done+1}/${rounds})</div>
          <div class="tiles" style="grid-template-columns: repeat(4, 1fr);">
            ${opts.map(n=>`<div class="tile" data-n="${n}" style="font-size:18px">${n}</div>`).join("")}
          </div>
          <div class="row"><span class="pill secondary" id="msHud">0/${seqLen}</span></div>
        `;
        const hud = root.querySelector("#msHud");
        root.querySelectorAll(".tile").forEach(t=>{
          t.addEventListener("click", ()=>{
            const n = Number(t.getAttribute("data-n"));
            input.push(n);
            hud.textContent = `${input.length}/${seqLen}`;
            if(n !== nums[input.length-1]){
              t.classList.add("bad");
              done++;
              setTimeout(()=>{
                if(done>=rounds){
                  const score = Math.round((ok/rounds)*100);
                  return resolve(score);
                }
                next();
              }, 420);
              return;
            }else{
              t.classList.add("good");
            }
            if(input.length>=seqLen){
              ok++;
              done++;
              setTimeout(()=>{
                if(done>=rounds){
                  const score = Math.round((ok/rounds)*100);
                  return resolve(score);
                }
                next();
              }, 420);
            }
          });
        });
      }, 2000);
    }
    next();
  });
}

function miniCounting(root){
  return new Promise(resolve=>{
    const rounds=5;
    let i=0, ok=0;
    const icons = ["â—","â—","â—","â—","â—","â—","â—","â—"];

    function round(){
      const count = 2 + Math.floor(Math.random()*6); // 2..7
      const shown = shuffle(icons).slice(0,count);
      const options = shuffle([count, count+1, Math.max(1,count-1), count+2].filter((v,idx,arr)=>arr.indexOf(v)===idx)).slice(0,3);
      if(!options.includes(count)) options[Math.floor(Math.random()*options.length)] = count;
      const opts = shuffle(options);

      root.innerHTML = `
        <div class="note small">Sa pika shikon? Raundi: <b>${i+1}/${rounds}</b></div>
        <div class="note" style="text-align:center; font-size:28px">${shown.join(" ")}</div>
        <div class="row" style="margin-top:10px">
          ${opts.map(n=>`<div class="tile" data-n="${n}" style="flex:1; min-height:70px">${n}</div>`).join("")}
        </div>
      `;
      root.querySelectorAll(".tile").forEach(t=>{
        t.addEventListener("click", ()=>{
          const n = Number(t.getAttribute("data-n"));
          if(n===count){ ok++; t.classList.add("good"); } else t.classList.add("bad");
          i++;
          setTimeout(()=>{
            if(i>=rounds) return resolve(Math.round((ok/rounds)*100));
            round();
          }, 360);
        });
      });
    }
    round();
  });
}

function miniOrder(root){
  return new Promise(resolve=>{
    const rounds=4;
    let i=0, ok=0;

    function round(){
      const nums = shuffle([1,2,3,4,5,6,7,8,9]).slice(0,4);
      const sorted = nums.slice().sort((a,b)=>a-b);
      let input=[];

      root.innerHTML = `
        <div class="note small">Prek numrat nga mÃ« i vogli tek mÃ« i madhi. Raundi: <b>${i+1}/${rounds}</b></div>
        <div class="tiles" style="grid-template-columns: repeat(4,1fr);">
          ${nums.map(n=>`<div class="tile" data-n="${n}" style="font-size:18px">${n}</div>`).join("")}
        </div>
      `;
      root.querySelectorAll(".tile").forEach(t=>{
        t.addEventListener("click", ()=>{
          const n = Number(t.getAttribute("data-n"));
          input.push(n);
          if(n !== sorted[input.length-1]){
            t.classList.add("bad");
            i++;
            setTimeout(()=>{
              if(i>=rounds) return resolve(Math.round((ok/rounds)*100));
              round();
            }, 380);
            return;
          }else{
            t.classList.add("good");
          }
          if(input.length===sorted.length){
            ok++;
            i++;
            setTimeout(()=>{
              if(i>=rounds) return resolve(Math.round((ok/rounds)*100));
              round();
            }, 380);
          }
        });
      });
    }
    round();
  });
}

function miniEmotionPick(root){
  return new Promise(resolve=>{
    const faces = [
      {w:"I gÃ«zuar", f:"ğŸ˜Š"},
      {w:"I trishtuar", f:"ğŸ˜¢"},
      {w:"I zemÃ«ruar", f:"ğŸ˜ "},
      {w:"I qetÃ«", f:"ğŸ˜Œ"},
      {w:"I befasuar", f:"ğŸ˜®"},
    ];
    const rounds = 5;
    let i=0, ok=0;
    const cycle = shuffle(faces).slice(0, rounds);

    function round(){
      const target = cycle[i];
      const opts = shuffle([target, ...shuffle(faces.filter(x=>x!==target)).slice(0,2)]);
      root.innerHTML = `
        <div class="note small">Emocioni: <b>${esc(target.w)}</b> (raundi ${i+1}/${rounds})</div>
        <div class="tiles" style="grid-template-columns: repeat(3,1fr);">
          ${opts.map(o=>`<div class="tile" data-w="${esc(o.w)}" style="font-size:34px">${esc(o.f)}</div>`).join("")}
        </div>
      `;
      root.querySelectorAll(".tile").forEach(t=>{
        t.addEventListener("click", ()=>{
          const w = t.getAttribute("data-w");
          if(w===target.w){ ok++; t.classList.add("good"); } else t.classList.add("bad");
          i++;
          setTimeout(()=>{
            if(i>=rounds) return resolve(Math.round((ok/rounds)*100));
            round();
          }, 360);
        });
      });
    }
    round();
  });
}

function miniColorPick(root){
  return new Promise(resolve=>{
    const colors = [
      {name:"Jeshile", hex:"#67c08f"},
      {name:"Blu", hex:"#7fd7ff"},
      {name:"VerdhÃ«", hex:"#ffd36a"},
      {name:"RozÃ«", hex:"#ff78b7"},
    ];
    const rounds=5;
    let i=0, ok=0;
    const cycle = shuffle(colors).slice(0, rounds);

    function round(){
      const target = cycle[i];
      const opts = shuffle([target, ...shuffle(colors.filter(x=>x!==target)).slice(0,2)]);
      root.innerHTML = `
        <div class="note small">Gjej ngjyrÃ«n: <b>${esc(target.name)}</b> (raundi ${i+1}/${rounds})</div>
        <div class="tiles" style="grid-template-columns: repeat(3,1fr);">
          ${opts.map(o=>`
            <div class="tile" data-n="${esc(o.name)}" style="min-height:86px">
              <div style="width:36px; height:36px; border-radius:14px; background:${o.hex}; border:1px solid rgba(255,255,255,.55)"></div>
            </div>
          `).join("")}
        </div>
      `;
      root.querySelectorAll(".tile").forEach(t=>{
        t.addEventListener("click", ()=>{
          const n = t.getAttribute("data-n");
          if(n===target.name){ ok++; t.classList.add("good"); } else t.classList.add("bad");
          i++;
          setTimeout(()=>{
            if(i>=rounds) return resolve(Math.round((ok/rounds)*100));
            round();
          }, 360);
        });
      });
    }
    round();
  });
}

function miniShapePick(root){
  return new Promise(resolve=>{
    const shapes = [
      {name:"Rreth", s:"â—"},
      {name:"Katror", s:"â– "},
      {name:"TrekÃ«ndÃ«sh", s:"â–²"},
      {name:"Yll", s:"â˜…"},
    ];
    const rounds=5;
    let i=0, ok=0;
    const cycle = shuffle(shapes).slice(0, rounds);

    function round(){
      const target = cycle[i];
      const opts = shuffle([target, ...shuffle(shapes.filter(x=>x!==target)).slice(0,2)]);
      root.innerHTML = `
        <div class="note small">Gjej formÃ«n: <b>${esc(target.name)}</b> (raundi ${i+1}/${rounds})</div>
        <div class="tiles" style="grid-template-columns: repeat(3,1fr);">
          ${opts.map(o=>`<div class="tile" data-n="${esc(o.name)}" style="font-size:34px">${esc(o.s)}</div>`).join("")}
        </div>
      `;
      root.querySelectorAll(".tile").forEach(t=>{
        t.addEventListener("click", ()=>{
          const n = t.getAttribute("data-n");
          if(n===target.name){ ok++; t.classList.add("good"); } else t.classList.add("bad");
          i++;
          setTimeout(()=>{
            if(i>=rounds) return resolve(Math.round((ok/rounds)*100));
            round();
          }, 360);
        });
      });
    }
    round();
  });
}

function miniSelectiveAttention(root){
  return new Promise(resolve=>{
    // tap only â— among mixed shapes
    const rounds=10;
    let i=0, ok=0;

    function round(){
      const items = shuffle(["â—","â– ","â–²","â˜…","â—†"]).slice(0,4);
      if(!items.includes("â—")) items[0] = "â—";
      const opts = shuffle(items);

      root.innerHTML = `
        <div class="note small">Prek vetÃ«m <b>â—</b>. Raundi: <b>${i+1}/${rounds}</b></div>
        <div class="tiles" style="grid-template-columns: repeat(4,1fr);">
          ${opts.map(x=>`<div class="tile" data-x="${esc(x)}" style="font-size:30px">${esc(x)}</div>`).join("")}
        </div>
      `;
      root.querySelectorAll(".tile").forEach(t=>{
        t.addEventListener("click", ()=>{
          const x = t.getAttribute("data-x");
          if(x==="â—"){ ok++; t.classList.add("good"); } else t.classList.add("bad");
          i++;
          setTimeout(()=>{
            if(i>=rounds) return resolve(Math.round((ok/rounds)*100));
            round();
          }, 260);
        });
      });
    }
    round();
  });
}

function miniSocialChoice(root){
  return new Promise(resolve=>{
    const scenarios = shuffle([
      {q:"Dikush thotÃ«: â€œA mund tÃ« luaj?â€", a:["Po, hajde.","Ik.","Sâ€™dua."], ok:0},
      {q:"Kur presim nÃ« radhÃ«:", a:["Presim radhÃ«n.","ShtyjmÃ«.","Marrim pa pyetur."], ok:0},
      {q:"Kur lodhem:", a:["KÃ«rkoj pushim.","BÃ«rtas.","Ik pa thÃ«nÃ« gjÃ«."], ok:0},
      {q:"Kur dikush flet:", a:["DÃ«gjoj.","Flas mbi tÃ«.","E injoroj."], ok:0},
      {q:"Kur mbaroj njÃ« lojÃ«:", a:["Faleminderit.","Sâ€™ka.","HÃ«."], ok:0},
    ]);
    const rounds=5;
    let i=0, ok=0;

    function round(){
      const s = scenarios[i];
      root.innerHTML = `
        <div class="note small">Zgjidh pÃ«rgjigjen mÃ« tÃ« sjellshme. Raundi: <b>${i+1}/${rounds}</b></div>
        <div class="note small"><b>Situata:</b> ${esc(s.q)}</div>
        <div class="stack">
          ${s.a.map((x,idx)=>`<div class="tile" data-i="${idx}" style="min-height:64px; font-size:14px">${esc(x)}</div>`).join("")}
        </div>
      `;
      root.querySelectorAll(".tile").forEach(t=>{
        t.addEventListener("click", ()=>{
          const idx = Number(t.getAttribute("data-i"));
          if(idx===s.ok){ ok++; t.classList.add("good"); } else t.classList.add("bad");
          i++;
          setTimeout(()=>{
            if(i>=rounds) return resolve(Math.round((ok/rounds)*100));
            round();
          }, 360);
        });
      });
    }
    round();
  });
}

function miniPuzzleFill(root){
  return new Promise(resolve=>{
    const rounds=4;
    let i=0, ok=0;

    function round(){
      const puzzles = [
        {q:"â˜… â˜… _ â˜…", missing:"â˜…", opts:["â˜…","â—","â–²"]},
        {q:"â— â–² â— _", missing:"â–²", opts:["â–²","â– ","â—"]},
        {q:"â–  â–  â–  _", missing:"â– ", opts:["â– ","â˜…","â—"]},
        {q:"â–² â— â–² _", missing:"â—", opts:["â—","â–²","â—†"]},
        {q:"â—† _ â—† â—†", missing:"â—†", opts:["â—†","â˜…","â– "]},
      ];
      const p = shuffle(puzzles)[0];

      root.innerHTML = `
        <div class="note small">Zgjidh pjesÃ«n qÃ« plotÃ«son modelin. Raundi: <b>${i+1}/${rounds}</b></div>
        <div class="note" style="text-align:center; font-size:26px; letter-spacing:.22em">${esc(p.q)}</div>
        <div class="row" style="margin-top:10px">
          ${shuffle(p.opts).map(x=>`<div class="tile" data-x="${esc(x)}" style="flex:1; min-height:70px; font-size:28px">${esc(x)}</div>`).join("")}
        </div>
      `;
      root.querySelectorAll(".tile").forEach(t=>{
        t.addEventListener("click", ()=>{
          const x = t.getAttribute("data-x");
          if(x===p.missing){ ok++; t.classList.add("good"); } else t.classList.add("bad");
          i++;
          setTimeout(()=>{
            if(i>=rounds) return resolve(Math.round((ok/rounds)*100));
            round();
          }, 360);
        });
      });
    }
    round();
  });
}

function brainAgeMessage(avg){
  if(avg >= 85) return "PerformancÃ« shumÃ« e mirÃ« nÃ« mini-lojÃ«ra. Mund tÃ« shtoni gradualisht vÃ«shtirÃ«sinÃ« dhe kohÃ«n e fokusit.";
  if(avg >= 65) return "PerformancÃ« e mirÃ«. Vazhdo me rutinÃ« tÃ« qetÃ« dhe ushtrime tÃ« shkurtra (5â€“10 min).";
  if(avg >= 45) return "PerformancÃ« mesatare. Ndihmon strukturÃ«, pushime tÃ« shkurtra, dhe motivim i butÃ«.";
  return "PerformancÃ« e ulÃ«t sot. Kjo mund tÃ« ndikohet nga lodhja/stresi. Provo pÃ«rsÃ«ri njÃ« ditÃ« tjetÃ«r nÃ« ambient tÃ« qetÃ«.";
}

/* =======================
   RESULT placeholder
======================= */
function renderResult(){
  view.innerHTML = `<div class="glass card-pad">Rezultat.</div>`;
}

/* =======================
   QUESTION BLOCKS + SCORING
======================= */
function questionBlock(text, name){
  return `
    <div class="q-item">
      <div class="q-title">${esc(text)}</div>
      <div class="radio-row" data-group="${esc(name)}">
        ${radioOpt(name,"RrallÃ«",1)}
        ${radioOpt(name,"MjaftueshÃ«m",2)}
        ${radioOpt(name,"Shpesh",3)}
      </div>
    </div>
  `;
}
function radioOpt(name,label,val){
  const id = `${name}_${val}`;
  return `
    <label class="radio" for="${id}">
      <input id="${id}" type="radio" name="${esc(name)}" value="${val}" required />
      ${esc(label)}
    </label>
  `;
}
document.addEventListener("change", (e)=>{
  const r = e.target;
  if(!(r && r.matches('input[type="radio"]'))) return;
  const group = r.closest("[data-group]");
  if(!group) return;
  group.querySelectorAll(".radio").forEach(x=>x.classList.remove("active"));
  r.closest(".radio").classList.add("active");
});

function scoreScale(formEl, n, prefix){
  let sum = 0;
  let answers = [];
  for(let i=0;i<n;i++){
    const v = Number(formEl.querySelector(`input[name="${prefix+i}"]:checked`)?.value || 0);
    answers.push(v);
    sum += v;
  }
  return { sum, maxScore: n*3, answers };
}
function interpretPct(pct){
  if(pct < 35) return "Shenja tÃ« pakta tÃ« raportuara. Vazhdo me stimulim dhe strukturÃ« tÃ« butÃ«.";
  if(pct < 60) return "Disa shenja tÃ« raportuara. Mund tÃ« ndihmojÃ« rutinÃ«, vizualÃ« dhe ushtrime tÃ« shkurtra sociale.";
  if(pct < 80) return "Shenja tÃ« moderuara. Sugjerohet konsultim profesional pÃ«r vlerÃ«sim mÃ« tÃ« thelluar.";
  return "Shenja tÃ« shumta tÃ« raportuara. Konsultimi profesional rekomandohet fuqimisht pÃ«r udhÃ«zime tÃ« personalizuara.";
}

/* =======================
   ROUTINE LOGIC
======================= */
function getEmphasisFromAnswers(answers, pct){
  const buckets = {
    "Komunikimi": [10],
    "Socializimi": [4,11,17],
    "PÃ«rqendrimi": [14,5],
    "Sensorjale": [1,2],
    "Emocione": [6,19,7,18],
    "Koordinimi": [12,13],
  };
  const scores = Object.entries(buckets).map(([k, idxs])=>{
    const s = idxs.reduce((a,i)=>a + (answers[i]||1), 0);
    return {k, s};
  }).sort((a,b)=>b.s-a.s);

  const top = scores.slice(0,3).map(x=>x.k);
  if(pct > 70 && !top.includes("Emocione")) top[2] = "Emocione";
  return top;
}

function buildWeeklyPlan(emphasis){
  const bank = {
    "Komunikimi":[
      {title:"Zgjedhje me 2 opsione", how:"Pyet: â€œDÃ«shiron ujÃ« apo lÃ«ng?â€ dhe prit 5 sekonda."},
      {title:"FjalÃ« + figurÃ«", how:"Trego figurÃ«n dhe thuaj fjalÃ«n ngadalÃ« 3 herÃ«."},
      {title:"KÃ«rkesÃ« e thjeshtÃ«", how:"FÃ«mija kÃ«rkon njÃ« objekt me 1 fjalÃ«/gest."},
      {title:"PÃ«rshkrim i shkurtÃ«r", how:"PÃ«rshkruaj njÃ« veprim: â€œPo veshim kÃ«pucÃ«t.â€"},
    ],
    "Socializimi":[
      {title:"LojÃ« me radhÃ«", how:"2â€“3 minuta: radhÃ« me top ose zar."},
      {title:"PÃ«rshÃ«ndetje e butÃ«", how:"Model: â€œPÃ«rshÃ«ndetjeâ€ + buzÃ«qeshje."},
      {title:"Kontakt i shkurtÃ«r", how:"1â€“2 sekonda kontakt sysh gjatÃ« njÃ« pyetjeje."},
      {title:"Rregull i vetÃ«m", how:"â€œPresim radhÃ«nâ€ nÃ« njÃ« aktivitet tÃ« vogÃ«l."},
    ],
    "PÃ«rqendrimi":[
      {title:"DetyrÃ« 2-minutÃ«she", how:"Puzzle i vogÃ«l ose renditje ngjyrash."},
      {title:"UdhÃ«zim me 2 hapa", how:"â€œMerr lapsin dhe vendose nÃ« tavolinÃ«.â€"},
      {title:"KujtesÃ« e thjeshtÃ«", how:"Trego 3 objekte, mbuloji, dhe gjej 1."},
      {title:"Pushim i planifikuar", how:"25â€“60 sekonda pushim pas fokusit."},
    ],
    "Sensorjale":[
      {title:"KÃ«nd qetÃ«simi", how:"Krijo njÃ« vend tÃ« vogÃ«l tÃ« qetÃ« (jastek + dritÃ« e ngrohtÃ«)."},
      {title:"Zgjedhje teksturash", how:"Zgjidh midis 2 teksturave tÃ« buta."},
      {title:"FrymÃ«marrje e udhÃ«zuar", how:"3 frymÃ«marrje tÃ« ngadalta, me numÃ«rim 1â€“3."},
      {title:"Planifikim i zhurmÃ«s", how:"NÃ«se ka zhurmÃ«, pÃ«rdor kufje ose largim tÃ« shkurtÃ«r."},
    ],
    "Emocione":[
      {title:"KartÃ« emocioni", how:"Zgjidh â€œi qetÃ« / i trishtuar / i gÃ«zuarâ€ me figurÃ«."},
      {title:"EmÃ«rto ndjesinÃ«", how:"Thuaj: â€œDuket se je i lodhur.â€ (pa gjykim)."},
      {title:"Tranzicion i butÃ«", how:"ParalajmÃ«ro 2 minuta para ndryshimit."},
      {title:"ShpÃ«rblim i vogÃ«l", how:"LavdÃ«ro pÃ«r pÃ«rpjekjen: â€œBravo qÃ« u pÃ«rpoqe!â€"},
    ],
    "Koordinimi":[
      {title:"MotorikÃ« e imÃ«t", how:"KapÃ«se rrobash, rruaza tÃ« mÃ«dha, ose plastelinÃ«."},
      {title:"EkuilibÃ«r i lehtÃ«", how:"Ecje e ngadaltÃ« nÃ« vijÃ« tÃ« imagjinuar 30 sek."},
      {title:"Koordinim sy-dorÃ«", how:"Hedhje topi nÃ« kosh nga afÃ«r."},
      {title:"RitÃ«m i ngadaltÃ«", how:"DÃ«gjo ritÃ«m dhe trokit lehtÃ« 10 herÃ«."},
    ]
  };

  const days = ["E HÃ«nÃ«","E MartÃ«","E MÃ«rkurÃ«","E Enjte","E Premte","E ShtunÃ«","E Diel"];
  const picks = emphasis.flatMap(k => (bank[k]||[]).map(x=>({...x, tag:k})));

  const plan = days.map((name, di)=>{
    const tasks = [];
    for(let i=0;i<3;i++){
      const item = picks[(di*3+i) % picks.length] || {title:"Aktivitet i qetÃ«", how:"Lexim i shkurtÃ«r dhe pushim.", tag:"â€”"};
      tasks.push({ title: `${item.title} (${item.tag})`, how: item.how });
    }
    return { name, tasks };
  });

  return plan;
}

function routineKeyForUser(){
  const u = currentUser();
  return u ? `${LS_ROUTINE}_${u.username}` : `${LS_ROUTINE}_guest`;
}
function loadRoutine(){
  try{
    const raw = localStorage.getItem(routineKeyForUser());
    return raw ? JSON.parse(raw) : null;
  }catch(e){ return null; }
}
function saveRoutine(obj){
  localStorage.setItem(routineKeyForUser(), JSON.stringify(obj));
}

function maybeUpdateStreak(plan, checks){
  const u = currentUser();
  if(!u) return;

  const today = new Date().toISOString().slice(0,10);
  const anyFullDay = plan.some((day, di)=> day.tasks.every((_, ti)=>checks[`d${di}_t${ti}`]===true));
  if(!anyFullDay) return;

  const uu = ensureUserProgress(u);
  uu.progress.routines = uu.progress.routines || { streak:0, lastDay:null };
  if(uu.progress.routines.lastDay === today) return;

  const last = uu.progress.routines.lastDay;
  if(last){
    const yest = new Date(Date.now() - 86400000);
    const yestKey = yest.toISOString().slice(0,10);
    if(last === yestKey){
      uu.progress.routines.streak = (uu.progress.routines.streak||0) + 1;
    }else{
      uu.progress.routines.streak = 1;
    }
  }else{
    uu.progress.routines.streak = 1;
  }
  uu.progress.routines.lastDay = today;
  updateUser(uu);
}

/* =======================
   SAVE AS IMAGE
======================= */
async function saveElementAsImage(el){
  if(typeof html2canvas !== "function"){
    alert("Nuk u gjet html2canvas. Sigurohu qÃ« ke internet ose hiqe opsionin e ruajtjes.");
    return;
  }
  const canvas = await html2canvas(el, { scale: 2, backgroundColor: null });
  const a = document.createElement("a");
  a.download = `GENCARE_${Date.now()}.png`;
  a.href = canvas.toDataURL("image/png");
  a.click();
}

/* =======================
   UTILS
======================= */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}
function clampInt(n, min, max){
  n = Number(n);
  if(Number.isNaN(n)) return min;
  return Math.max(min, Math.min(max, Math.round(n)));
}

/* =======================
   INIT
======================= */
render();
</script>
</body>
</html>
