<!doctype html>
<html lang="sq">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GENCARE â€¢ GENE4LIFE</title>

  <!-- Save as image -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      /* ======= GENCARE â€œGreen + Friendsâ€ Palette ======= */
      --g0:#07160F;        /* deep forest */
      --g1:#0B2A1A;        /* forest */
      --g2:#11452A;        /* pine */
      --g3:#1F6B3E;        /* leaf */
      --g4:#3AAE6F;        /* mint */
      --g5:#7AE6AE;        /* soft neon mint */

      --cream:#F3F6EE;
      --sand:#E7E2D6;

      --sky:#BFE9FF;       /* playful */
      --sun:#FFD58A;       /* warm */
      --berry:#FF9BC7;     /* candy */
      --lav:#CBB9FF;       /* lavender */

      --ink:#07110C;
      --text: rgba(7,17,12,.92);
      --muted: rgba(7,17,12,.66);

      --card: rgba(255,255,255,.12);
      --card2: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.22);
      --stroke2: rgba(0,0,0,.18);

      --shadow: 0 18px 55px rgba(0,0,0,.30);
      --shadowSoft: 0 14px 30px rgba(0,0,0,.18);
      --radius: 24px;

      --easeOut: cubic-bezier(.2,.9,.2,1);
      --easeIn: cubic-bezier(.5,.0,.8,.2);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      overflow-x:hidden;

      /* Animated layered background (greens + playful accents) */
      background:
        radial-gradient(1100px 800px at 20% 10%, rgba(122,230,174,.42), transparent 55%),
        radial-gradient(900px 700px at 90% 20%, rgba(191,233,255,.26), transparent 55%),
        radial-gradient(900px 700px at 25% 85%, rgba(255,213,138,.20), transparent 55%),
        radial-gradient(900px 700px at 85% 88%, rgba(255,155,199,.18), transparent 55%),
        linear-gradient(135deg, rgba(7,22,15,1), rgba(11,42,26,1));
      animation: bgShift 14s var(--easeOut) infinite alternate;
    }
    @keyframes bgShift{
      0%{ filter: saturate(1.06) brightness(.98); }
      100%{ filter: saturate(1.18) brightness(1.02); }
    }

    a{color:inherit; text-decoration:none}
    button{font:inherit; cursor:pointer}
    .hidden{display:none !important}
    .tiny{font-size:12px}
    .small{font-size:13px}
    .muted{color:var(--muted)}
    h1,h2,h3{margin:0}

    /* ======= Doodle layer: child-drawn stars + squiggles (animated) ======= */
    body:before{
      content:"";
      position:fixed; inset:-10%;
      pointer-events:none;
      opacity:.55;
      mix-blend-mode: screen;

      background-image:
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='520' height='520' viewBox='0 0 520 520'%3E%3Cg fill='none' stroke-linecap='round'%3E%3Cg stroke='%23BFE9FF' stroke-width='3' opacity='.32'%3E%3Cpath d='M52 96c24-18 48-18 72 0'/%3E%3Cpath d='M68 122c26-18 52-18 78 0'/%3E%3Cpath d='M340 410c26-18 52-18 78 0'/%3E%3Cpath d='M356 436c26-18 52-18 78 0'/%3E%3C/g%3E%3Cg stroke='%237AE6AE' stroke-width='3' opacity='.22'%3E%3Cpath d='M420 92c-18 18-18 42 0 60'/%3E%3Cpath d='M446 98c-18 18-18 42 0 60'/%3E%3Cpath d='M120 320c-18 18-18 42 0 60'/%3E%3Cpath d='M146 326c-18 18-18 42 0 60'/%3E%3C/g%3E%3Cg stroke='%23FFD58A' stroke-width='4' opacity='.18'%3E%3Cpath d='M210 80c18 14 42 14 60 0'/%3E%3Cpath d='M220 104c18 14 42 14 60 0'/%3E%3C/g%3E%3C/g%3E%3Cg opacity='.52'%3E%3Cg fill='none' stroke='%23FFFFFF' stroke-width='3' opacity='.22'%3E%3Cpath d='M92 220l10 18 20 4-14 14 3 20-18-10-18 10 3-20-14-14 20-4z'/%3E%3Cpath d='M452 290l10 18 20 4-14 14 3 20-18-10-18 10 3-20-14-14 20-4z'/%3E%3Cpath d='M262 452l10 18 20 4-14 14 3 20-18-10-18 10 3-20-14-14 20-4z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      background-size: 520px 520px;
      background-repeat: repeat;
      transform: rotate(-3deg);
      animation: doodleDrift 18s var(--easeOut) infinite alternate;
      filter: blur(.2px);
    }
    @keyframes doodleDrift{
      0%{ transform: translate(-2%, -1%) rotate(-3deg); }
      100%{ transform: translate(2%, 1%) rotate(2deg); }
    }

    /* Grain (soft) */
    body:after{
      content:"";
      position:fixed; inset:0;
      pointer-events:none;
      opacity:.16;
      mix-blend-mode: soft-light;
      background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='260' height='260'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.85' numOctaves='2' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='260' height='260' filter='url(%23n)' opacity='.22'/%3E%3C/svg%3E");
    }

    /* ======= App shell ======= */
    .app{
      min-height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }
    .shell{
      width:min(1120px, 100%);
      border-radius: 30px;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(122,230,174,.16), transparent 60%),
        radial-gradient(900px 520px at 100% 30%, rgba(191,233,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      border:1px solid rgba(255,255,255,.18);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
      backdrop-filter: blur(12px);
    }

    /* ======= Topbar (more playful) ======= */
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,.14);
      background:
        radial-gradient(900px 140px at 25% 0%, rgba(122,230,174,.14), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.04));
    }
    .brand-mini{
      display:flex; gap:10px; align-items:center;
      font-weight:900;
      letter-spacing:.10em;
      text-transform:uppercase;
      font-size:12px;
      color: rgba(255,255,255,.88);
    }
    .badge{
      width:36px; height:36px; border-radius:14px;
      display:grid; place-items:center;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.25), transparent 45%),
        linear-gradient(135deg, rgba(58,174,111,.92), rgba(17,69,42,.92));
      border:1px solid rgba(255,255,255,.20);
      box-shadow: 0 14px 28px rgba(0,0,0,.22);
      position:relative;
      overflow:hidden;
    }
    .badge:before{
      content:"";
      position:absolute; inset:-20%;
      background:
        radial-gradient(circle at 30% 10%, rgba(255,255,255,.18), transparent 55%),
        radial-gradient(circle at 70% 90%, rgba(255,255,255,.10), transparent 60%);
      transform: rotate(12deg);
    }
    .badge span{ position:relative; font-size:18px; }
    .brand-mini .mutedMini{opacity:.72; font-weight:800}

    .right-actions{display:flex; gap:10px; align-items:center}

    /* ======= Buttons ======= */
    .pill{
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.20);
      background:
        radial-gradient(900px 70px at 20% 15%, rgba(255,255,255,.18), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));
      box-shadow: 0 12px 26px rgba(0,0,0,.18);
      backdrop-filter: blur(12px);
      color: rgba(255,255,255,.88);
      font-weight:800;
      font-size:13px;
      transition: transform .14s var(--easeOut), filter .14s var(--easeOut);
    }
    .pill.secondary{
      background:
        radial-gradient(900px 70px at 20% 15%, rgba(255,255,255,.12), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      opacity:.92;
    }
    .pill:hover{filter: brightness(1.06)}
    .pill:active{transform: translateY(2px) scale(.99)}
    .pill:focus{outline:2px solid rgba(122,230,174,.55); outline-offset:2px}

    .content{
      min-height: calc(100vh - 90px);
      padding:18px;
    }

    /* ======= Cards ======= */
    .glass{
      background:
        radial-gradient(900px 220px at 20% 10%, rgba(255,255,255,.14), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.16);
      box-shadow: var(--shadowSoft);
      backdrop-filter: blur(14px);
      border-radius: var(--radius);
      position:relative;
      overflow:hidden;
    }
    .glass:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(800px 260px at 22% 0%, rgba(122,230,174,.10), transparent 60%),
        radial-gradient(700px 240px at 90% 0%, rgba(191,233,255,.08), transparent 60%);
      pointer-events:none;
    }
    .glass > *{position:relative}

    .card-pad{padding:18px}
    .stack{display:flex; flex-direction:column; gap:12px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .grid2{display:grid; grid-template-columns: 1.1fr .9fr; gap:16px}
    @media (max-width: 900px){ .grid2{grid-template-columns:1fr} }

    .section-title{
      font-weight:950;
      letter-spacing:.02em;
      font-size:18px;
      color: rgba(255,255,255,.92);
      text-shadow: 0 10px 28px rgba(0,0,0,.22);
    }

    /* ======= Inputs ======= */
    .field{display:flex; flex-direction:column; gap:6px}
    label{font-size:12px; opacity:.82; font-weight:850; color: rgba(255,255,255,.80)}
    input, select, textarea{
      width:100%;
      padding:11px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.08);
      outline:none;
      color: rgba(255,255,255,.92);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.12);
      backdrop-filter: blur(12px);
    }
    textarea{min-height:88px; resize:vertical}
    input::placeholder, textarea::placeholder{color: rgba(255,255,255,.55)}

    .note{
      padding:12px 14px;
      border-radius: 18px;
      background: rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.86);
    }

    .divider{height:1px; background: rgba(255,255,255,.14); margin: 8px 0}

    /* ======= Page transitions (smoother) ======= */
    .fade-in{animation: fade .28s var(--easeOut)}
    @keyframes fade{
      from{opacity:0; transform: translateY(10px) scale(.995); filter: blur(1px)}
      to{opacity:1; transform:none; filter: blur(0)}
    }

    /* ======= Landing ======= */
    .landing{
      min-height: 78vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:26px 16px;
      position:relative;
      overflow:hidden;
      border-radius: 24px;

      background:
        radial-gradient(900px 600px at 25% 20%, rgba(122,230,174,.22), transparent 55%),
        radial-gradient(700px 500px at 80% 75%, rgba(255,213,138,.10), transparent 60%),
        linear-gradient(140deg, rgba(11,42,26,.90), rgba(7,22,15,.95));
      border:1px solid rgba(255,255,255,.10);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }

    .landing:before{
      content:"";
      position:absolute; inset:-50%;
      background:
        radial-gradient(900px 600px at 30% 20%, rgba(191,233,255,.12), transparent 55%),
        radial-gradient(700px 500px at 80% 70%, rgba(122,230,174,.14), transparent 60%),
        radial-gradient(650px 450px at 15% 85%, rgba(255,155,199,.10), transparent 60%),
        linear-gradient(120deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      animation: drift 12s var(--easeOut) infinite alternate;
      pointer-events:none;
      filter: saturate(1.1);
    }
    @keyframes drift{
      0%{transform: translate(-3%, -2%) rotate(0deg)}
      100%{transform: translate(3%, 2%) rotate(1.6deg)}
    }

    .landing-stickers{
      position:absolute; inset:0; pointer-events:none;
      opacity:.85;
    }
    .sticker{
      position:absolute;
      width:180px; height:180px;
      border-radius: 40px;
      background:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.16), transparent 55%),
        linear-gradient(135deg, rgba(58,174,111,.35), rgba(191,233,255,.20));
      border:1px dashed rgba(255,255,255,.18);
      box-shadow: 0 18px 40px rgba(0,0,0,.25);
      transform: rotate(-10deg);
      animation: floaty 6.2s var(--easeOut) infinite alternate;
      filter: blur(.2px);
    }
    .sticker.s1{left:-40px; top:30px; transform: rotate(-14deg); animation-duration:7.4s}
    .sticker.s2{right:-50px; bottom:-30px; transform: rotate(12deg); animation-duration:8.2s}
    .sticker.s3{right:18%; top:-60px; width:140px; height:140px; transform: rotate(8deg); opacity:.55; animation-duration:9.2s}
    @keyframes floaty{
      from{transform: translateY(-6px) rotate(var(--r, -10deg))}
      to{transform: translateY(8px) rotate(calc(var(--r, -10deg) + 2deg))}
    }

    .landing-center{
      position:relative;
      text-align:center;
      padding:26px 18px;
      border-radius: 32px;
      background:
        radial-gradient(900px 220px at 30% 0%, rgba(122,230,174,.18), transparent 65%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 30px 80px rgba(0,0,0,.35);
      backdrop-filter: blur(16px);
      max-width: 880px;
    }

    .gencare-link{
      display:inline-block;
      font-weight: 950;
      letter-spacing: .12em;
      text-transform: uppercase;
      font-size: clamp(44px, 9vw, 96px);
      line-height: 1.02;
      padding: 10px 14px;
      border-radius: 22px;
      cursor:pointer;
      user-select:none;

      color: rgba(255,255,255,.94);
      text-shadow:
        0 1px 0 rgba(0,0,0,.22),
        0 18px 60px rgba(0,0,0,.22);

      background:
        radial-gradient(900px 120px at 30% 15%, rgba(255,255,255,.18), transparent 55%),
        radial-gradient(900px 240px at 80% 0%, rgba(122,230,174,.18), transparent 55%),
        linear-gradient(135deg, rgba(58,174,111,.55), rgba(17,69,42,.35));
      border: 1px solid rgba(255,255,255,.18);
      box-shadow:
        0 26px 74px rgba(0,0,0,.30),
        inset 0 1px 0 rgba(255,255,255,.18);
      transition: transform .14s var(--easeOut), filter .14s var(--easeOut);
      position:relative;
      overflow:hidden;
    }
    .gencare-link:before{
      content:"";
      position:absolute; inset:-40%;
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.18), transparent 55%),
        radial-gradient(circle at 80% 70%, rgba(191,233,255,.10), transparent 60%);
      animation: shimmer 3.8s var(--easeOut) infinite alternate;
      pointer-events:none;
    }
    @keyframes shimmer{
      from{transform: translate(-2%, -2%) rotate(0deg)}
      to{transform: translate(2%, 2%) rotate(4deg)}
    }
    .gencare-link:hover{filter: brightness(1.07)}
    .gencare-link:active{transform: translateY(2px) scale(.995)}

    .landing-slogan{
      margin-top:10px;
      font-size: clamp(14px, 2.2vw, 18px);
      color: rgba(255,255,255,.86);
      font-weight: 750;
      letter-spacing:.02em;
    }

    /* ======= Home ======= */
    .home-scroll{
      max-height: 72vh;
      overflow:auto;
      padding-right:6px;
    }
    .home-scroll::-webkit-scrollbar{width:10px}
    .home-scroll::-webkit-scrollbar-thumb{
      background: rgba(255,255,255,.12);
      border-radius:999px;
      border:2px solid rgba(0,0,0,.18);
    }

    .hero{
      padding:20px;
      border-radius: 28px;
      background:
        radial-gradient(900px 360px at 30% 10%, rgba(122,230,174,.18), transparent 55%),
        radial-gradient(900px 360px at 85% 0%, rgba(191,233,255,.10), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: var(--shadowSoft);
      position:relative;
      overflow:hidden;
    }
    .hero:after{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(500px 120px at 15% 0%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(500px 140px at 90% 20%, rgba(255,255,255,.06), transparent 60%);
      pointer-events:none;
    }
    .hero h1{
      font-size: clamp(28px, 4.8vw, 54px);
      font-weight: 950;
      letter-spacing: .12em;
      text-transform: uppercase;
      margin-bottom: 8px;
      color: rgba(255,255,255,.92);
      text-shadow: 0 16px 40px rgba(0,0,0,.28);
    }
    .hero p{
      margin:8px 0 0;
      color: rgba(255,255,255,.82);
      font-weight:700;
      line-height: 1.6;
    }
    .color-break{
      height:18px;
      border-radius: 999px;
      background: linear-gradient(90deg,
        rgba(58,174,111,.80),
        rgba(122,230,174,.72),
        rgba(191,233,255,.55),
        rgba(255,213,138,.55),
        rgba(255,155,199,.45)
      );
      border:1px solid rgba(255,255,255,.14);
      box-shadow: 0 12px 26px rgba(0,0,0,.18);
      margin:14px 0;
      position:relative;
      overflow:hidden;
    }
    .color-break:before{
      content:"";
      position:absolute; inset:-40%;
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,.16), transparent 55%);
      animation: drift 8s var(--easeOut) infinite alternate;
      pointer-events:none;
    }

    .menu-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
      margin-top:14px;
    }
    @media (max-width: 980px){ .menu-grid{grid-template-columns: repeat(2,1fr)} }
    @media (max-width: 600px){ .menu-grid{grid-template-columns: 1fr} }

    .bigbtn{
      padding:16px 16px;
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(900px 120px at 20% 0%, rgba(122,230,174,.12), transparent 60%),
        radial-gradient(900px 120px at 90% 0%, rgba(191,233,255,.08), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: var(--shadowSoft);
      backdrop-filter: blur(14px);
      text-align:left;
      position:relative;
      overflow:hidden;
      transition: transform .14s var(--easeOut), filter .14s var(--easeOut);
      color: rgba(255,255,255,.90);
    }
    .bigbtn:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(760px 180px at 18% 10%, rgba(255,255,255,.10), transparent 55%),
        radial-gradient(900px 240px at 90% 0%, rgba(255,255,255,.06), transparent 60%);
      pointer-events:none;
    }
    .bigbtn:hover{filter: brightness(1.06)}
    .bigbtn:active{transform: translateY(2px) scale(.995)}
    .bigbtn .t{position:relative; font-weight:950; letter-spacing:.02em; font-size:16px}
    .bigbtn .d{position:relative; margin-top:6px; color:rgba(255,255,255,.76); font-weight:750; font-size:13px; line-height:1.35}

    /* ======= Informohu (DNA stage) ======= */
    .dna-stage{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width: 900px){ .dna-stage{grid-template-columns:1fr} }

    .dna-box{
      padding:18px;
      position:relative;
      min-height: 420px;
      overflow:hidden;
    }
    .dna-bg{
      position:absolute; inset:0;
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(122,230,174,.14), transparent 55%),
        radial-gradient(700px 500px at 80% 70%, rgba(191,233,255,.10), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      animation: drift 12s var(--easeOut) infinite alternate;
      opacity:.95;
    }

    .helix-svg{
      position:absolute;
      left:50%; top:50%;
      width:min(440px, 78vw);
      transform: translate(-50%,-50%);
      opacity:.98;
      filter: drop-shadow(0 18px 35px rgba(0,0,0,.22));
    }

    .marker{
      position:absolute;
      width:48px; height:48px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(circle at 30% 20%, rgba(255,255,255,.12), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 18px 36px rgba(0,0,0,.22);
      display:flex; align-items:center; justify-content:center;
      font-weight: 950;
      cursor:pointer;
      transition: transform .14s var(--easeOut), filter .14s var(--easeOut);
      user-select:none;
    }
    .marker:hover{filter: brightness(1.07)}
    .marker:active{transform: translateY(2px) scale(.995)}
    .marker span{
      display:inline-block;
      width:30px; height:30px;
      border-radius: 999px;
      display:flex; align-items:center; justify-content:center;
      color: rgba(255,255,255,.92);
      text-shadow: 0 1px 0 rgba(0,0,0,.24);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.18);
      border: 1px dashed rgba(255,255,255,.20);
    }

    /* ======= Games ======= */
    .game-grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:14px;
    }
    @media (max-width: 980px){ .game-grid{grid-template-columns: repeat(2,1fr)} }
    @media (max-width: 600px){ .game-grid{grid-template-columns: 1fr} }

    .starrow{display:flex; gap:10px; flex-wrap:wrap}
    .star{
      width:56px; height:56px;
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(circle at 35% 25%, rgba(255,255,255,.14), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 18px 34px rgba(0,0,0,.22);
      display:flex; align-items:center; justify-content:center;
      font-size:22px;
      cursor:pointer;
      user-select:none;
      transition: transform .14s var(--easeOut), filter .14s var(--easeOut);
      color: rgba(255,255,255,.92);
    }
    .star:hover{filter: brightness(1.06)}
    .star:active{transform: translateY(2px) scale(.995)}

    .progressbar{
      height:12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      overflow:hidden;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.10);
    }
    .progressbar > div{
      height:100%;
      width:0%;
      background: linear-gradient(90deg,
        rgba(58,174,111,.90),
        rgba(122,230,174,.80),
        rgba(191,233,255,.55)
      );
      border-right:1px solid rgba(255,255,255,.14);
      transition: width .25s var(--easeOut);
    }

    .game-board{ padding:16px; min-height: 320px; }
    .game-hud{
      display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;
      margin-bottom:10px;
    }
    .hud-chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      font-weight:900;
      font-size:12px;
      color: rgba(255,255,255,.88);
    }

    /* Pause/Resume icons (Pause=triangle, Resume=||) */
    .iconbtn{
      width:46px; height:46px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.16);
      background:
        radial-gradient(circle at 35% 25%, rgba(255,255,255,.14), transparent 55%),
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow: 0 16px 34px rgba(0,0,0,.22);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      user-select:none;
      transition: transform .14s var(--easeOut), filter .14s var(--easeOut);
    }
    .iconbtn:hover{filter: brightness(1.07)}
    .iconbtn:active{transform: translateY(2px) scale(.995)}
    .tri{
      width:0;height:0;
      border-top:10px solid transparent;
      border-bottom:10px solid transparent;
      border-left:16px solid rgba(255,255,255,.86);
      margin-left:3px;
    }
    .bars{ width:16px; height:20px; display:flex; justify-content:space-between; }
    .bars i{
      display:block; width:5px; height:20px; border-radius:4px;
      background: rgba(255,255,255,.82);
    }

    .tiles{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 720px){ .tiles{grid-template-columns: repeat(3,1fr)} }
    @media (max-width: 480px){ .tiles{grid-template-columns: repeat(2,1fr)} }

    .tile{
      padding:14px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      box-shadow: 0 14px 30px rgba(0,0,0,.18);
      min-height: 70px;
      display:flex; align-items:center; justify-content:center;
      text-align:center;
      font-weight:950;
      cursor:pointer;
      user-select:none;
      transition: transform .14s var(--easeOut), filter .14s var(--easeOut);
      color: rgba(255,255,255,.92);
    }
    .tile:hover{filter: brightness(1.06)}
    .tile:active{transform: translateY(2px) scale(.995)}
    .tile.good{outline: 2px solid rgba(122,230,174,.55)}
    .tile.bad{outline: 2px solid rgba(255,155,199,.55)}

    /* Questionnaire blocks */
    .q-item{
      padding:14px;
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      box-shadow: 0 16px 34px rgba(0,0,0,.18);
    }
    .q-title{font-weight:950; margin-bottom:10px; color: rgba(255,255,255,.92)}
    .radio-row{display:flex; gap:10px; flex-wrap:wrap}
    .radio{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      cursor:pointer;
      user-select:none;
      font-weight:900;
      font-size:13px;
      color: rgba(255,255,255,.80);
      transition: transform .12s var(--easeOut), filter .12s var(--easeOut);
    }
    .radio:hover{filter: brightness(1.06)}
    .radio input{width:auto}
    .radio.active{
      background:
        radial-gradient(700px 70px at 20% 0%, rgba(122,230,174,.20), transparent 60%),
        rgba(255,255,255,.10);
      border-color: rgba(122,230,174,.45);
      color: rgba(255,255,255,.92);
    }

    /* Routine tasks */
    .task{
      display:flex;
      justify-content:space-between;
      gap:12px;
      padding:12px 12px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.07);
      align-items:center;
    }
    .task b{font-size:13px; color: rgba(255,255,255,.92)}
    .check{
      width:24px;height:24px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer;
      user-select:none;
      font-weight:950;
      color: rgba(255,255,255,.92);
    }
    .check.on{
      background: rgba(122,230,174,.24);
      border-color: rgba(122,230,174,.55);
    }

    /* Keep landing helix layer (still used, but now matches greens) */
    .helix-layer{
      position:absolute; inset:0;
      pointer-events:none;
      opacity:.92;
    }
    .helix{
      position:absolute;
      width:min(520px, 85vw);
      height:auto;
      filter: drop-shadow(0 22px 40px rgba(0,0,0,.28));
      opacity:.85;
      animation: spin 18s linear infinite;
      transform-origin:center;
    }
    .helix.h1{left:-8%; top:8%; animation-duration:22s; opacity:.55}
    .helix.h2{right:-10%; bottom:-8%; animation-duration:26s; opacity:.48}
    .helix.h3{left:55%; top:18%; width:min(420px, 70vw); animation-duration:30s; opacity:.28; filter: blur(1px) drop-shadow(0 22px 40px rgba(0,0,0,.22))}
    @keyframes spin{to{transform: rotate(360deg)}}
  </style>
</head>

<body>
  <div class="app">
    <div class="shell" id="shell">
      <div class="topbar">
        <div class="brand-mini" aria-label="GENCARE â€¢ GENE4LIFE">
          <div class="badge"><span>ğŸ§©</span></div>
          <span>GENCARE</span>
          <span style="opacity:.55">â€¢</span>
          <span class="mutedMini">GENE4LIFE</span>
        </div>
        <div class="right-actions">
          <button class="pill secondary" id="btnBack" title="Kthehu" style="display:none">â† Kthehu</button>
          <button class="pill" id="btnHome" title="Faqja Kryesore" style="display:none">ğŸ  Kryesore</button>
        </div>
      </div>

      <div class="content" id="view"></div>
    </div>
  </div>

<script>
/* =======================
   STORAGE + STATE
======================= */
const LS_USERS = "gencare_users_v1";
const LS_SESSION = "gencare_session_v1";
const LS_ROUTINE = "gencare_routine_v1";

const state = {
  route: "landing",
  routeStack: [],
  infoTopicIndex: 0,
  selectedGameId: null,
  selectedLevel: 1,
  gameRuntime: null,
};

const GAMES = [
  { id:"komunikimi", title:"Komunikimi", desc:"FjalÃ«, figura, shprehje â€” pÃ«r tÃ« ndihmuar komunikimin." },
  { id:"social", title:"Socializimi", desc:"Situata sociale dhe zgjedhje tÃ« thjeshta." },
  { id:"perqendrim", title:"TÃ« NxÃ«nit & PÃ«rqendrimi", desc:"KujtesÃ« e shpejtÃ« dhe fokus." },
  { id:"emocione", title:"Emocionet", desc:"Njohja e emocioneve nÃ« mÃ«nyrÃ« tÃ« qetÃ«." },
  { id:"sensori", title:"NdjeshmÃ«ria Sensorjale", desc:"Zgjedhje tÃ« buta â€” tinguj/ndjesi tÃ« imagjinuara." },
  { id:"koordinim", title:"LÃ«vizja & Koordinimi", desc:"Reagim i kontrolluar â€” prek/shfaq." },
];

const INFO_TOPICS = [
  { key:"komunikimi", title:"Komunikimi & Gjuha", bullets:[
    "Shenjat e para mund tÃ« shfaqen gradualisht: vonesÃ« nÃ« fjalÃ«, pak gjeste, ose vÃ«shtirÃ«si nÃ« pÃ«rdorimin e fjalÃ«ve pÃ«r kÃ«rkesa.",
    "Mund tÃ« vÃ«rehet pÃ«rsÃ«ritje fjalÃ«sh/frasash (ekolali) ose pÃ«rdorim i kufizuar i gjuhÃ«s funksionale.",
    "Ndihmon: rutinÃ« e qetÃ«, fjali tÃ« shkurtra, zgjedhje me 2 opsione, vizualÃ« (figura)."
  ]},
  { key:"social", title:"NdÃ«rveprimi Social & Kontakti me Sy", bullets:[
    "Mund tÃ« ketÃ« kontakt me sy tÃ« kufizuar, vÃ«shtirÃ«si nÃ« ndjekjen e lojÃ«s sÃ« pÃ«rbashkÃ«t, ose mungesÃ« interesi pÃ«r bashkÃ«moshatarÃ«t.",
    "Reagimi ndaj emrit mund tÃ« jetÃ« i dobÃ«t, ose preferon lojÃ« tÃ« vetmuar pÃ«r kohÃ« tÃ« gjatÃ«.",
    "Ndihmon: lojÃ«ra me radhÃ«, aktivitete tÃ« shkurtra bashkÃ«, lavdÃ«rim i qartÃ« dhe i butÃ«."
  ]},
  { key:"perqendrim", title:"TÃ« NxÃ«nit & PÃ«rqendrimi", bullets:[
    "VÃ«shtirÃ«si nÃ« fokus, kalim i shpejtÃ« nga njÃ« aktivitet tek tjetri, ose vÃ«mendje shumÃ« e lartÃ« vetÃ«m pÃ«r njÃ« interes specifik.",
    "Mund tÃ« ketÃ« sfida nÃ« ndjekjen e udhÃ«zimeve me shumÃ« hapa.",
    "Ndihmon: udhÃ«zime 1â€“2 hapa, pushime tÃ« shkurtra, strukturÃ« vizuale e ditÃ«s."
  ]},
  { key:"emocione", title:"Emocionet", bullets:[
    "VÃ«shtirÃ«si nÃ« shprehjen/kuptimin e emocioneve; shpÃ«rthime kur nuk kuptohet nevoja ose kur ka ndryshime tÃ« papritura.",
    "Rritje ankthi nÃ« ambiente tÃ« zhurmshme ose gjatÃ« tranzicioneve.",
    "Ndihmon: paralajmÃ«rime tÃ« buta pÃ«r ndryshime, â€œkarte emocioniâ€, frymÃ«marrje e udhÃ«zuar."
  ]},
  { key:"sensori", title:"NdjeshmÃ«ria Sensorjale", bullets:[
    "Reagime tÃ« forta ndaj dritÃ«s, zhurmÃ«s, prekjes, erÃ«rave ose teksturave tÃ« caktuara.",
    "Mund tÃ« kÃ«rkojÃ« stimulim (lÃ«kundje, rrotullim) ose tÃ« shmangÃ« disa ndjesi.",
    "Ndihmon: â€œkÃ«nd qetÃ«simiâ€, kufje, lodra sensoriale tÃ« buta, zgjedhje tÃ« kontrolluara."
  ]},
  { key:"koordinim", title:"LÃ«vizja & Koordinimi", bullets:[
    "Mund tÃ« ketÃ« vÃ«shtirÃ«si me motorikÃ«n e imÃ«t (laps, gÃ«rshÃ«rÃ«) ose koordinimin nÃ« lojÃ«ra fizike.",
    "Sjellje pÃ«rsÃ«ritÃ«se (p.sh. lÃ«kundje) mund tÃ« shÃ«rbejÃ« si vetÃ«rregullim.",
    "Ndihmon: ushtrime tÃ« shkurtra motorike, aktivitete me ritÃ«m tÃ« ngadaltÃ«, progres gradual."
  ]},
];

function getUsers(){ try{ return JSON.parse(localStorage.getItem(LS_USERS) || "[]"); }catch(e){ return []; } }
function setUsers(users){ localStorage.setItem(LS_USERS, JSON.stringify(users)); }
function getSession(){ try{ return JSON.parse(localStorage.getItem(LS_SESSION) || "null"); }catch(e){ return null; } }
function setSession(s){ localStorage.setItem(LS_SESSION, JSON.stringify(s)); }
function clearSession(){ localStorage.removeItem(LS_SESSION); }
function currentUser(){
  const s = getSession();
  if(!s) return null;
  return getUsers().find(u => u.username === s.username) || null;
}
function updateUser(patch){
  const users = getUsers();
  const idx = users.findIndex(u => u.username === patch.username);
  if(idx>=0){ users[idx] = { ...users[idx], ...patch }; setUsers(users); }
}

/* =======================
   ROUTING
======================= */
const view = document.getElementById("view");
const btnBack = document.getElementById("btnBack");
const btnHome = document.getElementById("btnHome");

btnBack.addEventListener("click", () => popRoute());
btnHome.addEventListener("click", () => go("home"));

function go(route, params={}){
  stopGameRuntime();
  state.routeStack.push({ route: state.route, snapshot: snapshotState() });
  state.route = route;
  Object.assign(state, params);
  render();
}
function popRoute(){
  stopGameRuntime();
  const prev = state.routeStack.pop();
  if(!prev){ state.route="home"; render(); return; }
  state.route = prev.route;
  restoreSnapshot(prev.snapshot);
  render();
}
function snapshotState(){
  return { infoTopicIndex: state.infoTopicIndex, selectedGameId: state.selectedGameId, selectedLevel: state.selectedLevel };
}
function restoreSnapshot(s){
  if(!s) return;
  state.infoTopicIndex = s.infoTopicIndex;
  state.selectedGameId = s.selectedGameId;
  state.selectedLevel = s.selectedLevel;
}
function setNavButtons(){
  const showBack = state.route !== "landing" && state.route !== "home";
  const showHome = state.route !== "landing";
  btnBack.style.display = showBack ? "inline-flex" : "none";
  btnHome.style.display = showHome ? "inline-flex" : "none";
}

/* =======================
   HELPERS
======================= */
function esc(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m])); }
function niceDate(d = new Date()){
  return d.toLocaleDateString("sq-AL", { weekday:"short", year:"numeric", month:"short", day:"2-digit" });
}
function ensureUserProgress(u){
  return { ...u, progress: u.progress || { games:{}, routines:{ streak:0, lastDay:null } }, createdAt: u.createdAt || Date.now() };
}
function computeOverallProgress(u){
  u = ensureUserProgress(u);
  let total=0, done=0;
  for(const g of GAMES){
    for(let lvl=1; lvl<=5; lvl++){
      total++;
      if(u.progress.games?.[g.id]?.[lvl] === true) done++;
    }
  }
  const pct = total ? Math.round((done/total)*100) : 0;
  return { pct, done, total };
}

/* =======================
   RENDER
======================= */
function render(){
  setNavButtons();
  view.className = "fade-in";

  if(state.route === "landing") return renderLanding();
  if(state.route === "home") return renderHome();
  if(state.route === "manual") return renderManual();
  if(state.route === "profile") return renderProfile();
  if(state.route === "informohu") return renderInformohu();
  if(state.route === "infoTopic") return renderInfoTopic();
  if(state.route === "games") return renderGamesMenu();
  if(state.route === "gameLevels") return renderGameLevels();
  if(state.route === "gamePlay") return renderGamePlay();
  if(state.route === "change") return renderChange();
  if(state.route === "routine") return renderRoutine();
  if(state.route === "result") return renderResult();

  view.innerHTML = `<div class="glass card-pad"><b>RrugÃ« e panjohur:</b> ${esc(state.route)}</div>`;
}

/* =======================
   SVG HELIX (now green-themed)
======================= */
function helixSVG(opacity=1){
  const root = getComputedStyle(document.documentElement);
  const gA = root.getPropertyValue('--g4').trim();
  const gB = root.getPropertyValue('--g2').trim();
  const gC = root.getPropertyValue('--sky').trim();
  const gD = root.getPropertyValue('--sun').trim();

  return `
  <svg viewBox="0 0 220 520" class="helix-svg" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
    <defs>
      <linearGradient id="g1" x1="0" x2="1">
        <stop offset="0" stop-color="${gA}" stop-opacity="${opacity}"/>
        <stop offset="1" stop-color="${gC}" stop-opacity="${opacity}"/>
      </linearGradient>
      <linearGradient id="g2" x1="0" x2="1">
        <stop offset="0" stop-color="${gB}" stop-opacity="${opacity}"/>
        <stop offset="1" stop-color="${gD}" stop-opacity="${opacity}"/>
      </linearGradient>
    </defs>

    <path d="M70,10 C160,60 160,120 70,170 C-20,220 -20,300 70,350 C160,400 160,460 70,510"
          fill="none" stroke="url(#g1)" stroke-width="10" stroke-linecap="round" opacity=".95"/>
    <path d="M150,10 C60,60 60,120 150,170 C240,220 240,300 150,350 C60,400 60,460 150,510"
          fill="none" stroke="url(#g2)" stroke-width="10" stroke-linecap="round" opacity=".9"/>

    ${Array.from({length:10}).map((_,i)=>{
      const y = 40 + i*48;
      const flip = i%2===0;
      return `<line x1="${flip?78:142}" y1="${y}" x2="${flip?142:78}" y2="${y+12}"
                    stroke="rgba(255,255,255,.22)" stroke-width="6" stroke-linecap="round"/>`;
    }).join("")}

    <circle cx="74" cy="40" r="4" fill="rgba(255,255,255,.24)"/>
    <circle cx="146" cy="92" r="4" fill="rgba(255,255,255,.22)"/>
    <circle cx="78" cy="244" r="4" fill="rgba(255,255,255,.20)"/>
    <circle cx="148" cy="410" r="4" fill="rgba(255,255,255,.18)"/>
  </svg>`;
}

/* =======================
   LANDING
======================= */
function renderLanding(){
  btnHome.style.display = "none";
  btnBack.style.display = "none";

  view.innerHTML = `
    <section class="landing">
      <div class="landing-stickers">
        <div class="sticker s1" style="--r:-14deg"></div>
        <div class="sticker s2" style="--r:12deg"></div>
        <div class="sticker s3" style="--r:8deg"></div>
      </div>

      <div class="helix-layer">
        <div class="helix h1">${helixSVG(.95)}</div>
        <div class="helix h2">${helixSVG(.85)}</div>
        <div class="helix h3">${helixSVG(.60)}</div>
      </div>

      <div class="landing-center">
        <div class="gencare-link" id="enterGencare" role="button" tabindex="0" aria-label="Hyr nÃ« GENCARE">
          GENCARE
        </div>
        <div class="landing-slogan">Ndryshimet na bÃ«jnÃ« unike.</div>
        <div class="note small" style="margin-top:14px; text-align:left">
          <b>QÃ«llimi:</b> informim + stimulim nÃ« mÃ«nyrÃ« tÃ« qetÃ« dhe miqÃ«sore pÃ«r fÃ«mijÃ«t.
          <span class="muted" style="display:block; margin-top:6px; color:rgba(255,255,255,.72)">
            Ky website nuk zÃ«vendÃ«son vlerÃ«simin profesional.
          </span>
        </div>
      </div>
    </section>
  `;

  const enter = document.getElementById("enterGencare");
  const open = () => { state.routeStack = []; state.route = "home"; render(); };
  enter.addEventListener("click", open);
  enter.addEventListener("keydown", (e)=>{ if(e.key==="Enter"||e.key===" "){ e.preventDefault(); open(); } });
}

/* =======================
   HOME
======================= */
function renderHome(){
  const u = currentUser();
  const overall = u ? computeOverallProgress(u) : null;

  view.innerHTML = `
    <div class="home-scroll">
      <div class="hero">
        <h1>GENCARE</h1>
        <p><b>MirÃ« se erdhÃ«t nÃ« website</b></p>
        <p>
          NjÃ« ndryshim i vogÃ«l nÃ« ADN nuk Ã«shtÃ« pengesÃ«. Me <b>GENE4LIFE</b>, Ã§do fÃ«mijÃ« mund tÃ« stimulohet,
          tÃ« mÃ«sojÃ« dhe tÃ« zhvillojÃ« aftÃ«sitÃ« e tij unike. Ndihmo fÃ«mijÃ«n tÃ« arrijÃ« potencialin e plotÃ«.
        </p>

        <div class="color-break"></div>

        <div class="row">
          <span class="pill secondary">Status: ${u ? "I identifikuar" : "Pa profil"}</span>
          ${u ? `<span class="pill secondary">PÃ«rdorues: <b>${esc(u.username)}</b></span>` : ""}
          ${u ? `<span class="pill secondary">Progres: <b>${overall.pct}%</b> (${overall.done}/${overall.total})</span>` : ""}
        </div>
      </div>

      <div style="height:12px"></div>

      <div class="menu-grid">
        ${menuBtn("Manuali i pÃ«rdorimit","Si tÃ« pÃ«rdoret website-i (burime & orientim).","manual")}
        ${menuBtn("Profili i fÃ«mijÃ«s","Krijo profil (username unik) dhe shiko progresin.","profile")}
        ${menuBtn("Informohu","Kliko nÃ« ADN dhe lexo informacionin pÃ«r Ã§do temÃ«.","informohu")}
        ${menuBtn("Lojrat","6 lojÃ«ra me 5 nivele â€“ me pauzÃ« & resume.","games")}
        ${menuBtn("Fillo Ndryshimin","PyetÃ«sor orientues (12 pyetje).","change")}
        ${menuBtn("Rutina Ime","PyetÃ«sor (20) + plan javor me checklist.","routine")}
      </div>

      <div style="height:14px"></div>
      <div class="note">
        <b>ShÃ«nim:</b> Ky website Ã«shtÃ« ndÃ«rtuar pÃ«r informim dhe stimulim. Nuk zÃ«vendÃ«son vlerÃ«simin profesional.
      </div>
    </div>
  `;
}

function menuBtn(t,d,route){
  return `
    <button class="bigbtn" data-route="${route}">
      <div class="t">${esc(t)}</div>
      <div class="d">${esc(d)}</div>
    </button>
  `;
}

view.addEventListener("click", (e)=>{
  const btn = e.target.closest("[data-route]");
  if(!btn) return;
  go(btn.getAttribute("data-route"));
});

/* =======================
   MANUAL
======================= */
function renderManual(){
  view.innerHTML = `
    <div class="glass card-pad stack">
      <div>
        <div class="section-title">Manuali i pÃ«rdorimit</div>
        <div class="muted small">Si mund ta pÃ«rdorÃ« prindi kÃ«tÃ« website, hap pas hapi.</div>
      </div>

      <div class="note">
        <b>1) Fillimi</b><br>
        Krijoni njÃ« profil tek <b>â€œProfili i fÃ«mijÃ«sâ€</b>. Kjo ruan progresin nÃ« pajisjen tuaj (localStorage).
      </div>

      <div class="note">
        <b>2) Informohu</b><br>
        Tek <b>â€œInformohuâ€</b> klikoni shenjÃ«n <b>!</b> nÃ« heliksin e ADN pÃ«r tÃ« lexuar tema tÃ« ndryshme.
      </div>

      <div class="note">
        <b>3) Lojrat</b><br>
        Zgjidhni njÃ« lojÃ« â†’ zgjidhni nivelin (1â€“5) â†’ luani. PÃ«rfundimi i nivelit shÃ«nohet nÃ« profil.
      </div>

      <div class="note">
        <b>4) PyetÃ«sorÃ«t</b><br>
        <b>â€œFillo Ndryshiminâ€</b> jep njÃ« vlerÃ«sim orientues (jo diagnozÃ«). <b>â€œRutina Imeâ€</b> krijon njÃ« plan javor.
      </div>

      <div class="note">
        <b>Burimet</b><br>
        PÃ«rmbajtja Ã«shtÃ« e formuluar nÃ« stil edukativ dhe orientues (psikoedukim, strukturÃ«, vizualÃ«, rutinÃ«).
        PÃ«r vendime klinike, konsultohuni me profesionistÃ«.
      </div>

      <div class="row">
        <button class="pill" onclick="go('home')">ğŸ  Ktheu nÃ« faqen kryesore</button>
      </div>
    </div>
  `;
}

/* =======================
   PROFILE (Sign up / Login + Progress)
   (Core logic unchanged)
======================= */
function renderProfile(){
  const u = currentUser();

  if(!u){
    view.innerHTML = `
      <div class="grid2">
        <div class="glass card-pad stack">
          <div>
            <div class="section-title">Profili i fÃ«mijÃ«s</div>
            <div class="muted small">Krijo profil personal (username unik) dhe ruaj progresin.</div>
          </div>

          <div class="note">
            <b>Siguria:</b> TÃ« dhÃ«nat ruhen vetÃ«m nÃ« pajisjen tuaj (browser) dhe nuk dÃ«rgohen askund.
          </div>

          <form id="signupForm" class="stack">
            <div class="field"><label>Emri i prindit/kujdestarit ligjor</label><input required name="parentName" placeholder="p.sh. Renita"/></div>
            <div class="field"><label>Emri i fÃ«mijÃ«s</label><input required name="childName" placeholder="p.sh. Mateo"/></div>
            <div class="row">
              <div class="field" style="flex:1"><label>Mosha e fÃ«mijÃ«s</label><input required name="childAge" type="number" min="1" max="18" placeholder="p.sh. 8"/></div>
              <div class="field" style="flex:1"><label>Problemi i deklaruar/diagnostifikuar (opsional)</label><input name="declared" placeholder="opsional"/></div>
            </div>
            <div class="row">
              <div class="field" style="flex:1"><label>Adresa e gmail tÃ« prindit</label><input required name="gmail" type="email" placeholder="emri@gmail.com"/></div>
              <div class="field" style="flex:1"><label>Numri i kontaktit (opsional)</label><input name="phone" placeholder="+355 ..."/></div>
            </div>

            <div class="divider"></div>

            <div class="row">
              <div class="field" style="flex:1"><label>Username (unik)</label><input required name="username" placeholder="p.sh. gencare_prindi"/></div>
              <div class="field" style="flex:1"><label>Password (min 6 + karakter special)</label><input required name="password" type="password" placeholder="******"/></div>
            </div>

            <div class="row">
              <button class="pill" type="submit">Ruaj profilin</button>
              <button class="pill secondary" type="button" id="goLogin">Kam profil (Log in)</button>
            </div>

            <div class="note tiny" id="signupMsg" style="display:none"></div>
          </form>
        </div>

        <div class="glass card-pad stack">
          <div class="section-title">Pse profil?</div>
          <div class="muted small" style="color:rgba(255,255,255,.78)">
            Profili mban shÃ«nim:
            <ul>
              <li>Progresin nÃ« lojÃ«ra (nivel/yll)</li>
              <li>Streak tÃ« rutinÃ«s (ditÃ« rresht me aktivitete tÃ« kryera)</li>
              <li>Rezultatet orientuese tÃ« pyetÃ«sorÃ«ve</li>
            </ul>
          </div>
          <div class="note">
            <b>KÃ«shillÃ«:</b> Filloni me nivelet 1â€“2 dhe rriteni gradualisht vÃ«shtirÃ«sinÃ«.
          </div>
        </div>
      </div>
    `;

    document.getElementById("goLogin").addEventListener("click", () => renderLoginInline());
    document.getElementById("signupForm").addEventListener("submit", (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const data = Object.fromEntries(fd.entries());

      const msg = document.getElementById("signupMsg");
      const users = getUsers();
      const username = String(data.username||"").trim().toLowerCase();

      if(username.length < 3){
        msg.style.display="block"; msg.textContent="Username duhet tÃ« ketÃ« tÃ« paktÃ«n 3 karaktere."; return;
      }
      if(users.some(u=>u.username === username)){
        msg.style.display="block"; msg.textContent="Ky username ekziston. Zgjidh njÃ« tjetÃ«r."; return;
      }
      const pw = String(data.password||"");
      if(pw.length < 6 || !/[^\w\s]/.test(pw)){
        msg.style.display="block";
        msg.textContent="Password duhet tÃ« ketÃ« min 6 karaktere dhe tÃ« paktÃ«n 1 karakter special (p.sh. ! @ #).";
        return;
      }

      const user = ensureUserProgress({
        username,
        password: pw,
        parentName: data.parentName.trim(),
        childName: data.childName.trim(),
        childAge: Number(data.childAge),
        declared: (data.declared||"").trim(),
        gmail: data.gmail.trim(),
        phone: (data.phone||"").trim(),
        createdAt: Date.now(),
        lastResults: {}
      });

      users.push(user);
      setUsers(users);
      setSession({ username });

      msg.style.display="block";
      msg.textContent="TÃ« dhÃ«nat tuaja u ruajtÃ«n. Duke rifreskuarâ€¦";
      setTimeout(()=>{ renderProfile(); }, 650);
    });

    return;
  }

  const fixed = ensureUserProgress(u);
  updateUser(fixed);
  const overall = computeOverallProgress(fixed);

  const streak = fixed.progress?.routines?.streak || 0;
  const lastDay = fixed.progress?.routines?.lastDay;

  view.innerHTML = `
    <div class="glass card-pad stack">
      <div class="row" style="justify-content:space-between; align-items:flex-start">
        <div>
          <div class="section-title">Profili i fÃ«mijÃ«s</div>
          <div class="muted small">TÃ« dhÃ«nat u ruajtÃ«n â€” ky Ã«shtÃ« progresi aktual.</div>
        </div>
        <button class="pill secondary" id="logoutBtn">Dil (Log out)</button>
      </div>

      <div class="grid2">
        <div class="glass card-pad stack">
          <div class="row">
            <span class="pill secondary">Username: <b>${esc(fixed.username)}</b></span>
            <span class="pill secondary">Krijuar: <b>${niceDate(new Date(fixed.createdAt))}</b></span>
          </div>

          <div class="note">
            <b>Prindi/Kujdestari:</b> ${esc(fixed.parentName)}<br>
            <b>FÃ«mija:</b> ${esc(fixed.childName)} (${esc(fixed.childAge)} vjeÃ§)<br>
            <b>DiagnozÃ«/Problem (ops.):</b> ${esc(fixed.declared || "â€”")}<br>
            <b>Gmail:</b> ${esc(fixed.gmail)}<br>
            <b>Kontakt (ops.):</b> ${esc(fixed.phone || "â€”")}
          </div>

          <div class="note">
            <b>Streak i rutinÃ«s:</b> <b>${streak}</b> ditÃ« rresht<br>
            <span class="tiny muted" style="color:rgba(255,255,255,.70)">Dita e fundit e plotÃ«suar: ${esc(lastDay || "â€”")}</span>
          </div>

          <div>
            <div class="row" style="justify-content:space-between">
              <b style="color:rgba(255,255,255,.92)">Progresi i lojÃ«rave</b>
              <span class="muted small">${overall.done}/${overall.total}</span>
            </div>
            <div class="progressbar"><div style="width:${overall.pct}%"></div></div>
            <div class="tiny muted" style="margin-top:6px; color:rgba(255,255,255,.70)">PÃ«rfunduar: <b>${overall.pct}%</b></div>
          </div>
        </div>

        <div class="glass card-pad stack">
          <div class="section-title">Detaje progresi</div>
          <div class="muted small">Kliko â€œLojratâ€ pÃ«r tÃ« vazhduar. KÃ«tu shfaqen nivelet e pÃ«rfunduara.</div>
          <div class="stack" style="gap:10px">
            ${GAMES.map(g=>{
              const map = fixed.progress.games?.[g.id] || {};
              const doneLvls = [1,2,3,4,5].filter(l=>map[l]===true).length;
              return `
                <div class="task">
                  <div>
                    <b>${esc(g.title)}</b><div class="tiny muted" style="color:rgba(255,255,255,.70)">${doneLvls}/5 nivele</div>
                  </div>
                  <span class="pill secondary">${doneLvls===5 ? "âœ…" : "â­"}</span>
                </div>
              `;
            }).join("")}
          </div>
        </div>
      </div>

      <div class="row">
        <button class="pill" onclick="go('home')">ğŸ  Ktheu nÃ« faqen kryesore</button>
      </div>
    </div>
  `;

  document.getElementById("logoutBtn").addEventListener("click", ()=>{
    clearSession();
    renderProfile();
  });
}

function renderLoginInline(){
  view.innerHTML = `
    <div class="glass card-pad stack" style="max-width:620px; margin:0 auto">
      <div>
        <div class="section-title">Log in</div>
        <div class="muted small">Fut username dhe password pÃ«r tÃ« hapur profilin.</div>
      </div>

      <form id="loginForm" class="stack">
        <div class="field"><label>Username</label><input required name="username" placeholder="username"/></div>
        <div class="field"><label>Password</label><input required type="password" name="password" placeholder="******"/></div>
        <div class="row">
          <button class="pill" type="submit">Hyr</button>
          <button class="pill secondary" type="button" onclick="go('profile')">Kthehu</button>
        </div>
        <div class="note tiny" id="loginMsg" style="display:none"></div>
      </form>
    </div>
  `;

  document.getElementById("loginForm").addEventListener("submit", (e)=>{
    e.preventDefault();
    const fd = new FormData(e.target);
    const username = String(fd.get("username")||"").trim().toLowerCase();
    const password = String(fd.get("password")||"");

    const msg = document.getElementById("loginMsg");
    const u = getUsers().find(x => x.username===username && x.password===password);
    if(!u){
      msg.style.display="block";
      msg.textContent="TÃ« dhÃ«nat nuk pÃ«rputhen. Provo pÃ«rsÃ«ri.";
      return;
    }
    setSession({ username });
    renderProfile();
  });
}

/* =======================
   INFORMOHU
======================= */
function renderInformohu(){
  view.innerHTML = `
    <div class="dna-stage">
      <div class="glass dna-box">
        <div class="dna-bg"></div>
        ${helixSVG(.95)}

        ${INFO_TOPICS.map((t, i)=>{
          const pos = [
            {x: "62%", y:"18%"},
            {x: "48%", y:"30%"},
            {x: "60%", y:"42%"},
            {x: "46%", y:"56%"},
            {x: "58%", y:"70%"},
            {x: "50%", y:"83%"},
          ][i];

          const c = [
            "rgba(58,174,111,.95)",
            "rgba(122,230,174,.90)",
            "rgba(191,233,255,.80)",
            "rgba(255,213,138,.80)",
            "rgba(255,155,199,.75)",
            "rgba(203,185,255,.75)"
          ][i];

          return `
            <div class="marker" data-topic="${i}" style="left:${pos.x}; top:${pos.y}">
              <span style="background:${c}">!</span>
            </div>
          `;
        }).join("")}
      </div>

      <div class="glass card-pad stack">
        <div>
          <div class="section-title">Informohu</div>
          <div class="muted small">
            Kliko shenjÃ«n <b>!</b> nÃ« ADN pÃ«r tÃ« hapur temÃ«n pÃ«rkatÃ«se. Pastaj vazhdo me shigjeta te tema tjetÃ«r.
          </div>
        </div>

        <div class="note">
          <b>Temat:</b>
          <ul class="small" style="margin:8px 0 0; color:rgba(255,255,255,.78); line-height:1.55">
            ${INFO_TOPICS.map(t=>`<li>${esc(t.title)}</li>`).join("")}
          </ul>
        </div>

        <div class="row">
          <button class="pill" onclick="go('home')">ğŸ  Ktheu nÃ« faqen kryesore</button>
        </div>
      </div>
    </div>
  `;

  view.querySelectorAll("[data-topic]").forEach(el=>{
    el.addEventListener("click", ()=>{
      const idx = Number(el.getAttribute("data-topic"));
      state.infoTopicIndex = idx;
      go("infoTopic");
    });
  });
}

function renderInfoTopic(){
  const idx = state.infoTopicIndex || 0;
  const t = INFO_TOPICS[idx];

  const prevIdx = (idx - 1 + INFO_TOPICS.length) % INFO_TOPICS.length;
  const nextIdx = (idx + 1) % INFO_TOPICS.length;

  view.innerHTML = `
    <div class="glass card-pad stack" id="topicCard">
      <div class="row" style="justify-content:space-between; align-items:flex-start">
        <div>
          <div class="section-title">${esc(t.title)}</div>
          <div class="muted small">Kur shfaqen shenjat, si shfaqen, dhe Ã§farÃ« mund tÃ« ndihmojÃ« (orientuese).</div>
        </div>
        <div class="row">
          <button class="pill secondary" id="prevTopic">â†</button>
          <button class="pill secondary" id="nextTopic">â†’</button>
        </div>
      </div>

      <div class="note">
        <b>Informacion i pÃ«rgjithshÃ«m</b>
        <ul class="small" style="margin:8px 0 0; color:rgba(255,255,255,.82); line-height:1.6">
          ${t.bullets.map(b=>`<li>${esc(b)}</li>`).join("")}
        </ul>
      </div>

      <div class="note tiny">
        <b>Kujdes:</b> KÃ«to janÃ« informacione orientuese. PÃ«r shqetÃ«sime specifike, konsultohuni me specialist.
      </div>

      <div class="row">
        <button class="pill" onclick="go('home')">ğŸ  Ktheu nÃ« faqen kryesore</button>
        <button class="pill secondary" onclick="popRoute()">â†© Kthehu te ADN</button>
      </div>
    </div>
  `;

  document.getElementById("prevTopic").addEventListener("click", ()=>{
    state.infoTopicIndex = prevIdx; renderInfoTopic();
  });
  document.getElementById("nextTopic").addEventListener("click", ()=>{
    state.infoTopicIndex = nextIdx; renderInfoTopic();
  });
}

/* =======================
   GAMES MENU + LEVELS
======================= */
function renderGamesMenu(){
  view.innerHTML = `
    <div class="glass card-pad stack">
      <div>
        <div class="section-title">Lojrat</div>
        <div class="muted small">Zgjidh njÃ« lojÃ«. Secila ka 5 nivele (â­) dhe shÃ«non progresin nÃ« profil.</div>
      </div>

      <div class="game-grid">
        ${GAMES.map(g=>`
          <button class="bigbtn" data-game="${g.id}">
            <div class="t">${esc(g.title)}</div>
            <div class="d">${esc(g.desc)}</div>
          </button>
        `).join("")}
      </div>

      <div class="note tiny">
        <b>Pauz/Resume:</b> NÃ« lojÃ« do shohÃ«sh <b>pauzÃ«</b> (â–¶) dhe <b>resume</b> (||) sipas ikonave standarde.
      </div>

      <div class="row">
        <button class="pill" onclick="go('home')">ğŸ  Ktheu nÃ« faqen kryesore</button>
      </div>
    </div>
  `;

  view.querySelectorAll("[data-game]").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.selectedGameId = btn.getAttribute("data-game");
      go("gameLevels");
    });
  });
}

function renderGameLevels(){
  const g = GAMES.find(x=>x.id===state.selectedGameId) || GAMES[0];
  const u = currentUser();
  const doneMap = u?.progress?.games?.[g.id] || {};

  view.innerHTML = `
    <div class="glass card-pad stack">
      <div class="row" style="justify-content:space-between; align-items:flex-start">
        <div>
          <div class="section-title">${esc(g.title)}</div>
          <div class="muted small">Zgjidh nivelin e vÃ«shtirÃ«sisÃ« (â­1 mÃ« i thjeshti â†’ â­5 mÃ« i vÃ«shtiri).</div>
        </div>
        <button class="pill secondary" onclick="go('games')">â† Te Lojrat</button>
      </div>

      <div class="starrow">
        ${[1,2,3,4,5].map(l=>{
          const done = doneMap[l]===true;
          return `<div class="star" data-level="${l}" title="Niveli ${l}">${done ? "âœ…" : "â­"}</div>`;
        }).join("")}
      </div>

      <div class="note">
        <b>KÃ«shillÃ«:</b> NÃ«se fÃ«mija lodhet, pÃ«rdor pauzÃ« (â–¶) dhe vazhdo kur tÃ« jetÃ« gati.
      </div>

      <div class="row">
        <button class="pill" onclick="go('home')">ğŸ  Ktheu nÃ« faqen kryesore</button>
      </div>
    </div>
  `;

  view.querySelectorAll("[data-level]").forEach(el=>{
    el.addEventListener("click", ()=>{
      state.selectedLevel = Number(el.getAttribute("data-level"));
      go("gamePlay");
    });
  });
}

/* =======================
   GAME PLAY (core unchanged)
======================= */
function renderGamePlay(){
  const g = GAMES.find(x=>x.id===state.selectedGameId) || GAMES[0];
  const lvl = state.selectedLevel || 1;
  const u = currentUser();

  view.innerHTML = `
    <div class="glass card-pad stack">
      <div class="row" style="justify-content:space-between; align-items:flex-start">
        <div>
          <div class="section-title">${esc(g.title)} â€¢ Niveli ${lvl}</div>
          <div class="muted small">Loja Ã«shtÃ« e thjeshtÃ«, qetÃ«suese dhe me progres gradual.</div>
        </div>
        <div class="row">
          <button class="pill secondary" onclick="go('gameLevels')">â† Nivelet</button>
          <button class="pill" onclick="go('home')">ğŸ  Kryesore</button>
        </div>
      </div>

      ${u ? "" : `<div class="note"><b>ShÃ«nim:</b> PÃ«r tÃ« ruajtur progresin, krijo profil tek â€œProfili i fÃ«mijÃ«sâ€.</div>`}

      <div class="glass game-board">
        <div class="game-hud">
          <span class="hud-chip" id="hudGoal">QÃ«llimi: â€”</span>
          <span class="hud-chip" id="hudScore">Progres: 0%</span>
          <div class="row" style="gap:10px">
            <div class="iconbtn" id="pauseBtn" title="PauzÃ« (â–¶)"><div class="tri"></div></div>
            <div class="iconbtn" id="resumeBtn" title="Vazhdo (||)" style="display:none"><div class="bars"><i></i><i></i></div></div>
          </div>
        </div>

        <div id="gameArea"></div>
      </div>

      <div class="row">
        <button class="pill secondary" id="endBtn">PÃ«rfundo & Kthehu</button>
      </div>
    </div>
  `;

  const gameArea = document.getElementById("gameArea");
  const hudGoal = document.getElementById("hudGoal");
  const hudScore = document.getElementById("hudScore");
  const pauseBtn = document.getElementById("pauseBtn");
  const resumeBtn = document.getElementById("resumeBtn");
  const endBtn = document.getElementById("endBtn");

  let paused = false;
  const runtime = {
    interval: null,
    timeout: null,
    cleanup: [],
    setPaused(v){
      paused = v;
      pauseBtn.style.display = paused ? "none" : "flex";
      resumeBtn.style.display = paused ? "flex" : "none";
    },
    isPaused(){ return paused; },
    clearAll(){
      if(runtime.interval) clearInterval(runtime.interval);
      if(runtime.timeout) clearTimeout(runtime.timeout);
      runtime.cleanup.forEach(fn=>{ try{fn()}catch{} });
      runtime.cleanup = [];
    }
  };
  state.gameRuntime = runtime;

  pauseBtn.addEventListener("click", ()=> runtime.setPaused(true));
  resumeBtn.addEventListener("click", ()=> runtime.setPaused(false));
  endBtn.addEventListener("click", ()=>{ finishGame(false); });

  function setGoal(s){ hudGoal.textContent = "QÃ«llimi: " + s; }
  function setPct(p){ hudScore.textContent = "Progres: " + p + "%"; }

  function finishGame(completed){
    runtime.clearAll();
    state.gameRuntime = null;

    if(completed){
      const u2 = currentUser();
      if(u2){
        const uu = ensureUserProgress(u2);
        uu.progress.games = uu.progress.games || {};
        uu.progress.games[g.id] = uu.progress.games[g.id] || {};
        uu.progress.games[g.id][lvl] = true;
        updateUser(uu);
      }
      gameArea.innerHTML = `
        <div class="note" style="margin-top:10px">
          <b>Bravo!</b> Niveli u pÃ«rfundua dhe u shÃ«nua nÃ« profil.
        </div>
        <div class="row" style="margin-top:10px">
          <button class="pill" onclick="go('home')">ğŸ  Ktheu nÃ« faqen kryesore</button>
          <button class="pill secondary" onclick="go('gameLevels')">â­ Zgjidh nivel tjetÃ«r</button>
        </div>
      `;
      pauseBtn.style.display="none";
      resumeBtn.style.display="none";
    }else{
      go("gameLevels");
    }
  }

  if(g.id === "komunikimi") return game_Communication(lvl, gameArea, setGoal, setPct, runtime, finishGame);
  if(g.id === "social") return game_Social(lvl, gameArea, setGoal, setPct, runtime, finishGame);
  if(g.id === "perqendrim") return game_Focus(lvl, gameArea, setGoal, setPct, runtime, finishGame);
  if(g.id === "emocione") return game_Emotions(lvl, gameArea, setGoal, setPct, runtime, finishGame);
  if(g.id === "sensori") return game_Sensory(lvl, gameArea, setGoal, setPct, runtime, finishGame);
  if(g.id === "koordinim") return game_Coordination(lvl, gameArea, setGoal, setPct, runtime, finishGame);
}

/* ==== GAME 1: Communication ==== */
function game_Communication(lvl, root, setGoal, setPct, rt, finish){
  const pool = [
    {w:"UjÃ«", p:"ğŸ«—"},
    {w:"BukÃ«", p:"ğŸ"},
    {w:"LibÃ«r", p:"ğŸ“˜"},
    {w:"Top", p:"âš½"},
    {w:"Gjumi", p:"ğŸŒ™"},
    {w:"Luaj", p:"ğŸ²"},
    {w:"MuzikÃ«", p:"ğŸµ"},
    {w:"Vizat", p:"âœï¸"},
  ];
  const count = Math.min(3+lvl, 8);
  const items = shuffle(pool).slice(0,count);
  let target = items[Math.floor(Math.random()*items.length)];
  let correct = 0;
  const need = Math.max(4, 3+lvl);

  setGoal(`Kliko ikonÃ«n qÃ« pÃ«rputhet me fjalÃ«n: â€œ${target.w}â€ (duhen ${need} saktÃ«)`);
  setPct(0);

  function nextTarget(){
    target = items[Math.floor(Math.random()*items.length)];
    setGoal(`Kliko ikonÃ«n qÃ« pÃ«rputhet me fjalÃ«n: â€œ${target.w}â€ (duhen ${need} saktÃ«)`);
  }

  renderTiles();

  function renderTiles(){
    root.innerHTML = `
      <div class="note small">Fjala: <b style="font-size:18px">${esc(target.w)}</b></div>
      <div class="tiles">
        ${items.map(it=>`<div class="tile" data-w="${esc(it.w)}" style="font-size:26px">${esc(it.p)}</div>`).join("")}
      </div>
    `;
    root.querySelectorAll(".tile").forEach(t=>{
      t.addEventListener("click", ()=>{
        if(rt.isPaused()) return;
        const w = t.getAttribute("data-w");
        if(w === target.w){
          t.classList.add("good");
          correct++;
          setPct(Math.min(100, Math.round((correct/need)*100)));
          if(correct >= need) return finish(true);
          setTimeout(()=>{ t.classList.remove("good"); nextTarget(); renderTiles(); }, 250);
        }else{
          t.classList.add("bad");
          setTimeout(()=>t.classList.remove("bad"), 250);
        }
      });
    });
  }
}

/* ==== GAME 2: Social ==== */
function game_Social(lvl, root, setGoal, setPct, rt, finish){
  const scenarios = [
    {q:"NjÃ« shok thotÃ«: â€œA luajmÃ« bashkÃ«?â€", a:["Po, hajde tÃ« luajmÃ«.","Ik.","Nuk e dÃ«gjoj."], ok:0},
    {q:"Kur dikush flet, Ã§farÃ« bÃ«jmÃ«?", a:["DÃ«gjojmÃ« dhe presim radhÃ«n.","Flasim mbi tÃ«.","Ikim."], ok:0},
    {q:"NÃ« radhÃ«, Ã§farÃ« Ã«shtÃ« e sjellshme?", a:["Presim radhÃ«n.","ShtyjmÃ« tÃ« parÃ«t.","Marrim pa pyetur."], ok:0},
    {q:"NÃ«se lodhem, mund tÃ« them:", a:["Kam nevojÃ« pÃ«r pushim.","Jam i keq.","Sâ€™di."], ok:0},
    {q:"Kur dua njÃ« lodÃ«r, mund tÃ« pyes:", a:["A mund ta marr, tÃ« lutem?","Ma jep tani!","E marr vetÃ«."], ok:0},
    {q:"Kur mbaroj lojÃ«n, mund tÃ« them:", a:["Faleminderit.","HÃ«.","Sâ€™ka gjÃ«."], ok:0},
  ];

  const rounds = Math.max(4, 3+lvl);
  let score = 0, idx = 0;
  const deck = shuffle(scenarios).slice(0, Math.min(rounds, scenarios.length));

  setGoal(`Zgjidh pÃ«rgjigjen mÃ« tÃ« sjellshme (duhen ${rounds} raunde).`);
  setPct(0);

  function draw(){
    const s = deck[idx];
    root.innerHTML = `
      <div class="note small"><b>Situata:</b> ${esc(s.q)}</div>
      <div class="stack" style="margin-top:10px">
        ${s.a.map((x,i)=>`<div class="tile" data-i="${i}" style="min-height:64px; font-size:14px">${esc(x)}</div>`).join("")}
      </div>
    `;
    root.querySelectorAll(".tile").forEach(t=>{
      t.addEventListener("click", ()=>{
        if(rt.isPaused()) return;
        const chosen = Number(t.getAttribute("data-i"));
        if(chosen === s.ok){ t.classList.add("good"); score++; }
        else{ t.classList.add("bad"); }
        setTimeout(()=>{
          idx++;
          setPct(Math.round((idx/rounds)*100));
          if(idx >= rounds) return finish(score >= Math.ceil(rounds*0.7));
          draw();
        }, 420);
      });
    });
  }
  draw();
}

/* ==== GAME 3: Focus ==== */
function game_Focus(lvl, root, setGoal, setPct, rt, finish){
  const size = Math.min(12, 6+lvl*2);
  const seqLen = Math.min(8, 3+lvl);
  let seq = [];
  let input = [];
  let showing = true;

  setGoal(`Mbaj mend sekuencÃ«n (gjatÃ«sia: ${seqLen}).`);
  setPct(0);

  const nums = Array.from({length:size}, (_,i)=>i+1);

  function newRound(){
    seq = [];
    input = [];
    for(let i=0;i<seqLen;i++) seq.push(nums[Math.floor(Math.random()*nums.length)]);
    showing = true;
    render(true);
    showSequence();
  }

  function showSequence(){
    let i=0;
    const highlight = () => {
      if(rt.isPaused()) { rt.timeout = setTimeout(highlight, 200); return; }
      if(i>=seq.length){ showing=false; render(false); return; }
      const n = seq[i];
      const el = root.querySelector(`[data-n="${n}"]`);
      if(el){
        el.classList.add("good");
        setTimeout(()=>el.classList.remove("good"), 260);
      }
      i++;
      rt.timeout = setTimeout(highlight, Math.max(320, 520 - lvl*50));
    };
    rt.timeout = setTimeout(highlight, 450);
  }

  function render(isShowing){
    root.innerHTML = `
      <div class="note small">
        ${isShowing ? "Shiko me qetÃ«siâ€¦" : "Tani pÃ«rsÃ«rite sekuencÃ«n duke klikuar numrat."}
      </div>
      <div class="tiles" style="margin-top:10px">
        ${nums.map(n=>`<div class="tile" data-n="${n}" style="font-size:16px">${n}</div>`).join("")}
      </div>
    `;

    root.querySelectorAll(".tile").forEach(t=>{
      t.addEventListener("click", ()=>{
        if(rt.isPaused()) return;
        if(showing) return;

        const n = Number(t.getAttribute("data-n"));
        input.push(n);

        const k = input.length - 1;
        if(n !== seq[k]){
          t.classList.add("bad");
          setTimeout(()=>finish(false), 520);
          return;
        }else{
          t.classList.add("good");
          setTimeout(()=>t.classList.remove("good"), 180);
        }

        setPct(Math.round((input.length/seqLen)*100));
        if(input.length >= seqLen) setTimeout(()=>finish(true), 320);
      });
    });
  }

  newRound();
}

/* ==== GAME 4: Emotions ==== */
function game_Emotions(lvl, root, setGoal, setPct, rt, finish){
  const faces = [
    {w:"I gÃ«zuar", f:"ğŸ˜Š"},
    {w:"I trishtuar", f:"ğŸ˜¢"},
    {w:"I zemÃ«ruar", f:"ğŸ˜ "},
    {w:"I frikÃ«suar", f:"ğŸ˜¨"},
    {w:"I befasuar", f:"ğŸ˜®"},
    {w:"I qetÃ«", f:"ğŸ˜Œ"},
  ];

  const rounds = Math.max(4, 3+lvl);
  let done = 0;

  setGoal(`Zgjidh fytyrÃ«n qÃ« pÃ«rputhet me emocioni (raunde: ${rounds}).`);
  setPct(0);

  function round(){
    const target = faces[Math.floor(Math.random()*faces.length)];
    const opts = shuffle([target, ...shuffle(faces.filter(x=>x!==target)).slice(0, Math.min(2+lvl, faces.length-1))]);

    root.innerHTML = `
      <div class="note small">Emocioni: <b style="font-size:18px">${esc(target.w)}</b></div>
      <div class="tiles" style="margin-top:10px">
        ${opts.map(o=>`<div class="tile" data-w="${esc(o.w)}" style="font-size:30px">${esc(o.f)}</div>`).join("")}
      </div>
    `;
    root.querySelectorAll(".tile").forEach(t=>{
      t.addEventListener("click", ()=>{
        if(rt.isPaused()) return;
        const w = t.getAttribute("data-w");
        if(w === target.w){
          t.classList.add("good");
          done++;
          setPct(Math.round((done/rounds)*100));
          if(done>=rounds) return finish(true);
          setTimeout(round, 360);
        }else{
          t.classList.add("bad");
          setTimeout(()=>t.classList.remove("bad"), 260);
        }
      });
    });
  }
  round();
}

/* ==== GAME 5: Sensory ==== */
function game_Sensory(lvl, root, setGoal, setPct, rt, finish){
  const pairs = [
    {q:"ZhurmÃ« e lartÃ« apo zÃ« i butÃ«?", a:["ZÃ« i butÃ«","ZhurmÃ« e lartÃ«"], ok:0},
    {q:"DritÃ« e fortÃ« apo dritÃ« e ngrohtÃ«?", a:["DritÃ« e ngrohtÃ«","DritÃ« e fortÃ«"], ok:0},
    {q:"TeksturÃ« e ashpÃ«r apo e butÃ«?", a:["E butÃ«","E ashpÃ«r"], ok:0},
    {q:"ShumÃ« njerÃ«z apo kÃ«nd i qetÃ«?", a:["KÃ«nd i qetÃ«","ShumÃ« njerÃ«z"], ok:0},
    {q:"RitÃ«m i shpejtÃ« apo i ngadaltÃ«?", a:["I ngadaltÃ«","I shpejtÃ«"], ok:0},
  ];

  const rounds = Math.max(4, 3+lvl);
  let i=0, ok=0;
  const deck = shuffle(pairs);
  setGoal(`Zgjidh opsionin mÃ« qetÃ«sues (raunde: ${rounds}).`);
  setPct(0);

  function draw(){
    const s = deck[i % deck.length];
    root.innerHTML = `
      <div class="note small"><b>Pyetje:</b> ${esc(s.q)}</div>
      <div class="row" style="margin-top:10px">
        ${s.a.map((x,idx)=>`<div class="tile" data-i="${idx}" style="flex:1; min-height:70px">${esc(x)}</div>`).join("")}
      </div>
    `;
    root.querySelectorAll(".tile").forEach(t=>{
      t.addEventListener("click", ()=>{
        if(rt.isPaused()) return;
        const chosen = Number(t.getAttribute("data-i"));
        if(chosen === s.ok){ ok++; t.classList.add("good"); } else t.classList.add("bad");
        i++;
        setPct(Math.round((i/rounds)*100));
        setTimeout(()=>{
          if(i>=rounds) return finish(ok >= Math.ceil(rounds*0.7));
          draw();
        }, 380);
      });
    });
  }
  draw();
}

/* ==== GAME 6: Coordination ==== */
function game_Coordination(lvl, root, setGoal, setPct, rt, finish){
  const needed = Math.max(8, 6 + lvl*4);
  let hit = 0;
  setGoal(`Prek shenjÃ«n qÃ« shfaqet (duhen ${needed} goditje tÃ« sakta).`);
  setPct(0);

  root.innerHTML = `
    <div class="note small">Prek shenjÃ«n kur shfaqet. Merr kohÃ«n tÃ«nde.</div>
    <div id="arena" class="glass" style="height:320px; border-radius:22px; position:relative; overflow:hidden; margin-top:10px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.14)"></div>
  `;
  const arena = document.getElementById("arena");

  function spawn(){
    if(rt.isPaused()){ rt.timeout = setTimeout(spawn, 220); return; }

    arena.innerHTML = "";
    const b = document.createElement("div");
    b.className = "marker";
    b.style.width = "60px";
    b.style.height = "60px";
    b.style.borderRadius = "18px";
    b.style.left = (10 + Math.random()*80) + "%";
    b.style.top = (10 + Math.random()*70) + "%";

    const c = ["rgba(58,174,111,.95)","rgba(122,230,174,.90)","rgba(191,233,255,.75)","rgba(255,213,138,.75)","rgba(255,155,199,.70)"][Math.floor(Math.random()*5)];
    b.innerHTML = `<span style="background:${c}; width:34px; height:34px">â—</span>`;
    arena.appendChild(b);

    b.addEventListener("click", ()=>{
      if(rt.isPaused()) return;
      hit++;
      setPct(Math.round((hit/needed)*100));
      b.style.transform = "translateY(2px) scale(.98)";
      if(hit>=needed) return finish(true);
      rt.timeout = setTimeout(spawn, Math.max(300, 900 - lvl*120));
    });

    rt.timeout = setTimeout(spawn, Math.max(700, 1400 - lvl*120));
  }

  spawn();
}

/* Stop running game when navigating */
function stopGameRuntime(){
  if(state.gameRuntime){
    try{ state.gameRuntime.clearAll(); }catch{}
    state.gameRuntime = null;
  }
}

/* =======================
   Fillo Ndryshimin (12 Q)
======================= */
function renderChange(){
  const questions = [
    "Reagon kur e thÃ«rrasin nÃ« emÃ«r?",
    "PÃ«rdor gjeste (tregon, tund kokÃ«n, etj.)?",
    "Ka kontakt me sy gjatÃ« komunikimit?",
    "Ndjek udhÃ«zime tÃ« thjeshta (1â€“2 hapa)?",
    "Preferon lojÃ« tÃ« pÃ«rbashkÃ«t me tÃ« tjerÃ«t?",
    "Ka sjellje pÃ«rsÃ«ritÃ«se (p.sh. lÃ«kundje, rrotullim objektesh)?",
    "Ka sensitivitet tÃ« lartÃ« ndaj zhurmÃ«s/dritÃ«s/prekjes?",
    "Ka vÃ«shtirÃ«si nÃ« ndryshime rutine?",
    "Shfaq interes tÃ« kufizuar pÃ«r lodra tÃ« ndryshme?",
    "PÃ«rdor fjalÃ«/frasÃ« tÃ« pÃ«rsÃ«ritura (ekolali)?",
    "Ka shpÃ«rthime emocionale kur nuk kuptohet nevoja?",
    "Preferon tÃ« luajÃ« vetÃ«m pÃ«r periudha tÃ« gjata?"
  ];

  view.innerHTML = `
    <div class="glass card-pad stack" id="changeCard">
      <div>
        <div class="section-title">Fillo Ndryshimin</div>
        <div class="muted small">PyetÃ«sor orientues (12 pyetje) â€” pÃ«rgjigju: RrallÃ« / MjaftueshÃ«m / Shpesh.</div>
      </div>

      <div class="note tiny">
        <b>ShÃ«nim:</b> Rezultati Ã«shtÃ« vetÃ«m orientues dhe nuk Ã«shtÃ« diagnozÃ«.
      </div>

      <form id="changeForm" class="stack">
        ${questions.map((q, i)=>questionBlock(q, "c"+i)).join("")}

        <div class="row">
          <button class="pill" type="submit">Shfaq rezultatin</button>
          <button class="pill secondary" type="button" onclick="go('home')">ğŸ  Ktheu nÃ« faqen kryesore</button>
        </div>
      </form>

      <div class="glass card-pad stack hidden" id="changeResult">
        <div class="section-title">Rezultati</div>
        <div class="note" id="changeText"></div>
        <div class="row">
          <button class="pill" id="saveChange">Ruaje nÃ« gallery</button>
          <button class="pill secondary" id="backChange">Kthehu te pyetÃ«sori</button>
        </div>
      </div>
    </div>
  `;

  const form = document.getElementById("changeForm");
  const resultBox = document.getElementById("changeResult");
  const text = document.getElementById("changeText");

  form.addEventListener("submit", (e)=>{
    e.preventDefault();
    const score = scoreScale(form, questions.length, "c");
    const pct = Math.round((score.maxScore? (score.sum/score.maxScore)*100 : 0));

    const msg = interpretPct(pct);
    text.innerHTML = `
      <div><b>Probabilitet orientues:</b> <span style="font-size:22px">${pct}%</span></div>
      <div class="small muted" style="margin-top:6px; color:rgba(255,255,255,.78)">${esc(msg)}</div>
      <div class="tiny muted" style="margin-top:10px; color:rgba(255,255,255,.70)">KÃ«shillÃ«: NÃ«se keni shqetÃ«sime, konsultohuni me specialist.</div>
    `;

    const u = currentUser();
    if(u){
      const uu = ensureUserProgress(u);
      uu.lastResults = uu.lastResults || {};
      uu.lastResults.change = { pct, at: Date.now() };
      updateUser(uu);
    }

    resultBox.classList.remove("hidden");
    form.classList.add("hidden");
  });

  document.getElementById("backChange").addEventListener("click", ()=>{
    resultBox.classList.add("hidden");
    form.classList.remove("hidden");
  });

  document.getElementById("saveChange").addEventListener("click", async ()=>{
    await saveElementAsImage(document.getElementById("changeCard"));
  });
}

/* =======================
   Rutina Ime (20 Q + Plan)
======================= */
function renderRoutine(){
  const questions = [
    "Ka vÃ«shtirÃ«si nÃ« ndryshime tÃ« papritura?",
    "Ka ndjeshmÃ«ri ndaj zhurmÃ«s/dritÃ«s?",
    "Shfaq sjellje pÃ«rsÃ«ritÃ«se?",
    "VÃ«shtirÃ«si nÃ« kontakt me sy?",
    "VÃ«shtirÃ«si nÃ« ndarjen e lodrave?",
    "Ndjek udhÃ«zime me 2 hapa?",
    "Ka shpÃ«rthime emocionale?",
    "Preferon lojÃ« tÃ« vetmuar?",
    "Ka interes tÃ« ngushtÃ« pÃ«r njÃ« temÃ«?",
    "Ka vÃ«shtirÃ«si nÃ« gjumÃ«/ritÃ«m ditor?",
    "VÃ«shtirÃ«si nÃ« komunikim tÃ« kÃ«rkesave?",
    "VÃ«shtirÃ«si nÃ« pritjen e radhÃ«s?",
    "VÃ«shtirÃ«si nÃ« motorikÃ«n e imÃ«t (laps, gÃ«rshÃ«rÃ«)?",
    "VÃ«shtirÃ«si nÃ« motorikÃ«n e madhe (ekuilibÃ«r)?",
    "VÃ«shtirÃ«si nÃ« pÃ«rqendrim?",
    "Reagon dobÃ«t ndaj emrit?",
    "VÃ«shtirÃ«si nÃ« lojÃ« imagjinative?",
    "Shpesh stres nÃ« ambiente sociale?",
    "Preferon rutinÃ« shumÃ« tÃ« rreptÃ«?",
    "Ka vÃ«shtirÃ«si nÃ« kuptimin e emocioneve tÃ« tÃ« tjerÃ«ve?"
  ];

  const u = currentUser();

  view.innerHTML = `
    <div class="glass card-pad stack" id="routineCard">
      <div>
        <div class="section-title">Rutina Ime</div>
        <div class="muted small">
          PyetÃ«sor (20) â†’ gjeneron plan javor me aktivitete. Ã‡do aktivitet ka check. DitÃ«t e plota numÃ«rohen si streak.
        </div>
      </div>

      ${u ? "" : `<div class="note"><b>ShÃ«nim:</b> PÃ«r streak dhe ruajtje, krijo profil tek â€œProfili i fÃ«mijÃ«sâ€.</div>`}

      <form id="routineForm" class="stack">
        ${questions.map((q, i)=>questionBlock(q, "r"+i)).join("")}

        <div class="row">
          <button class="pill" type="submit">Gjenero planin javor</button>
          <button class="pill secondary" type="button" onclick="go('home')">ğŸ  Ktheu nÃ« faqen kryesore</button>
        </div>
      </form>

      <div class="glass card-pad stack hidden" id="planBox">
        <div class="row" style="justify-content:space-between; align-items:flex-start">
          <div>
            <div class="section-title">Plani Javor</div>
            <div class="muted small">Aktivitetet janÃ« tÃ« sugjeruara sipas pÃ«rgjigjeve.</div>
          </div>
          <button class="pill secondary" id="editRoutine">â†© Ndrysho pyetÃ«sorin</button>
        </div>

        <div class="note tiny" id="planNote"></div>
        <div id="planDays" class="stack"></div>

        <div class="row">
          <button class="pill" id="saveRoutine">Ruaje nÃ« gallery</button>
          <button class="pill secondary" onclick="go('home')">ğŸ  Ktheu nÃ« faqen kryesore</button>
        </div>
      </div>
    </div>
  `;

  const form = document.getElementById("routineForm");
  const planBox = document.getElementById("planBox");
  const planDays = document.getElementById("planDays");
  const planNote = document.getElementById("planNote");

  form.addEventListener("submit", (e)=>{
    e.preventDefault();
    const score = scoreScale(form, questions.length, "r");
    const pct = Math.round((score.maxScore? (score.sum/score.maxScore)*100 : 0));

    const emphasis = getEmphasisFromAnswers(score.answers, pct);
    const plan = buildWeeklyPlan(emphasis);

    const key = routineKeyForUser();
    localStorage.setItem(key, JSON.stringify({ createdAt: Date.now(), emphasis, plan, checks:{} }));

    const uu = currentUser();
    if(uu){
      const u2 = ensureUserProgress(uu);
      u2.lastResults = u2.lastResults || {};
      u2.lastResults.routine = { pct, emphasis, at: Date.now() };
      updateUser(u2);
    }

    showPlan(plan, emphasis);
  });

  document.getElementById("editRoutine").addEventListener("click", ()=>{
    planBox.classList.add("hidden");
    form.classList.remove("hidden");
  });

  document.getElementById("saveRoutine").addEventListener("click", async ()=>{
    await saveElementAsImage(document.getElementById("routineCard"));
  });

  const existing = loadRoutine();
  if(existing) showPlan(existing.plan, existing.emphasis, true);

  function showPlan(plan, emphasis, existing=false){
    form.classList.add("hidden");
    planBox.classList.remove("hidden");

    planNote.innerHTML = `
      <b>Fokus:</b> ${esc(emphasis.join(", "))}<br>
      <span class="muted" style="color:rgba(255,255,255,.70)">
        Plani Ã«shtÃ« ${existing ? "i ruajtur nga mÃ« parÃ«" : "gjeneruar tani"} dhe mund tÃ« kontrollohet me checklist.
      </span>
    `;

    const store = loadRoutine() || { checks:{} };
    const checks = store.checks || {};

    planDays.innerHTML = plan.map((day, di)=>{
      const dayKey = `d${di}`;
      const allChecked = day.tasks.every((_,ti)=>checks[`${dayKey}_t${ti}`]===true);

      return `
        <div class="glass card-pad stack">
          <div class="row" style="justify-content:space-between">
            <b style="color:rgba(255,255,255,.92)">${esc(day.name)}</b>
            <span class="pill secondary">${allChecked ? "âœ… Dita e plotÃ«" : "â˜‘ï¸ Checklist"}</span>
          </div>
          ${day.tasks.map((t, ti)=>{
            const k = `${dayKey}_t${ti}`;
            const on = checks[k]===true;
            return `
              <div class="task">
                <div>
                  <b>${esc(t.title)}</b>
                  <div class="tiny muted" style="color:rgba(255,255,255,.70)">${esc(t.how)}</div>
                </div>
                <div class="check ${on ? "on":""}" data-check="${k}">${on ? "âœ“" : ""}</div>
              </div>
            `;
          }).join("")}
        </div>
      `;
    }).join("");

    planDays.querySelectorAll("[data-check]").forEach(el=>{
      el.addEventListener("click", ()=>{
        const k = el.getAttribute("data-check");
        const store = loadRoutine() || { checks:{} };
        store.checks = store.checks || {};
        store.checks[k] = !store.checks[k];
        saveRoutine(store);
        showPlan(plan, emphasis, true);
        maybeUpdateStreak(plan, store.checks);
      });
    });

    maybeUpdateStreak(plan, checks);
  }
}

/* =======================
   RESULT placeholder
======================= */
function renderResult(){
  view.innerHTML = `<div class="glass card-pad">Rezultat.</div>`;
}

/* =======================
   QUESTION BLOCKS + SCORING
======================= */
function questionBlock(text, name){
  return `
    <div class="q-item">
      <div class="q-title">${esc(text)}</div>
      <div class="radio-row" data-group="${esc(name)}">
        ${radioOpt(name,"RrallÃ«",1)}
        ${radioOpt(name,"MjaftueshÃ«m",2)}
        ${radioOpt(name,"Shpesh",3)}
      </div>
    </div>
  `;
}
function radioOpt(name,label,val){
  const id = `${name}_${val}`;
  return `
    <label class="radio" for="${id}">
      <input id="${id}" type="radio" name="${esc(name)}" value="${val}" required />
      ${esc(label)}
    </label>
  `;
}
document.addEventListener("change", (e)=>{
  const r = e.target;
  if(!(r && r.matches('input[type="radio"]'))) return;
  const group = r.closest("[data-group]");
  if(!group) return;
  group.querySelectorAll(".radio").forEach(x=>x.classList.remove("active"));
  r.closest(".radio").classList.add("active");
});

function scoreScale(formEl, n, prefix){
  let sum = 0;
  let answers = [];
  for(let i=0;i<n;i++){
    const v = Number(formEl.querySelector(`input[name="${prefix+i}"]:checked`)?.value || 0);
    answers.push(v);
    sum += v;
  }
  return { sum, maxScore: n*3, answers };
}
function interpretPct(pct){
  if(pct < 35) return "Shenja tÃ« pakta tÃ« raportuara. Vazhdo me stimulim dhe strukturÃ« tÃ« butÃ«.";
  if(pct < 60) return "Disa shenja tÃ« raportuara. Mund tÃ« ndihmojÃ« rutinÃ«, vizualÃ« dhe ushtrime tÃ« shkurtra sociale.";
  if(pct < 80) return "Shenja tÃ« moderuara. Sugjerohet konsultim profesional pÃ«r vlerÃ«sim mÃ« tÃ« thelluar.";
  return "Shenja tÃ« shumta tÃ« raportuara. Konsultimi profesional rekomandohet fuqimisht pÃ«r udhÃ«zime tÃ« personalizuara.";
}

/* =======================
   ROUTINE PLAN LOGIC (core unchanged)
======================= */
function getEmphasisFromAnswers(answers, pct){
  const buckets = {
    "Komunikimi": [10],
    "Socializimi": [4,11,17],
    "PÃ«rqendrimi": [14,5],
    "Sensorjale": [1,2],
    "Emocione": [6,19,7,18],
    "Koordinimi": [12,13],
  };
  const scores = Object.entries(buckets).map(([k, idxs])=>{
    const s = idxs.reduce((a,i)=>a + (answers[i]||1), 0);
    return {k, s};
  }).sort((a,b)=>b.s-a.s);

  const top = scores.slice(0,3).map(x=>x.k);
  if(pct > 70 && !top.includes("Emocione")) top[2] = "Emocione";
  return top;
}

function buildWeeklyPlan(emphasis){
  const bank = {
    "Komunikimi":[
      {title:"Zgjedhje me 2 opsione", how:"Pyet: â€œDÃ«shiron ujÃ« apo lÃ«ng?â€ dhe prit 5 sekonda."},
      {title:"FjalÃ« + figurÃ«", how:"Trego figurÃ«n dhe thuaj fjalÃ«n ngadalÃ« 3 herÃ«."},
      {title:"KÃ«rkesÃ« e thjeshtÃ«", how:"FÃ«mija kÃ«rkon njÃ« objekt me 1 fjalÃ«/gest."},
      {title:"PÃ«rshkrim i shkurtÃ«r", how:"PÃ«rshkruaj njÃ« veprim: â€œPo veshim kÃ«pucÃ«t.â€"},
    ],
    "Socializimi":[
      {title:"LojÃ« me radhÃ«", how:"2â€“3 minuta: radhÃ« me top ose zar."},
      {title:"PershÃ«ndetje e butÃ«", how:"Model: â€œPÃ«rshÃ«ndetjeâ€ + buzÃ«qeshje."},
      {title:"Kontakt i shkurtÃ«r", how:"1â€“2 sekonda kontakt sysh gjatÃ« njÃ« pyetjeje."},
      {title:"Rregull i vetÃ«m", how:"â€œPresim radhÃ«nâ€ nÃ« njÃ« aktivitet tÃ« vogÃ«l."},
    ],
    "PÃ«rqendrimi":[
      {title:"DetyrÃ« 2-minutÃ«she", how:"Puzzle i vogÃ«l ose renditje ngjyrash."},
      {title:"UdhÃ«zim me 2 hapa", how:"â€œMerr lapsin dhe vendose nÃ« tavolinÃ«.â€"},
      {title:"KujtesÃ« e thjeshtÃ«", how:"Trego 3 objekte, mbuloji, dhe gjej 1."},
      {title:"Pushim i planifikuar", how:"25â€“60 sekonda pushim pas fokusit."},
    ],
    "Sensorjale":[
      {title:"KÃ«nd qetÃ«simi", how:"Krijo njÃ« vend tÃ« vogÃ«l tÃ« qetÃ« (jastek + dritÃ« e ngrohtÃ«)."},
      {title:"Zgjedhje teksturash", how:"Zgjidh midis 2 teksturave tÃ« buta."},
      {title:"FrymÃ«marrje e udhÃ«zuar", how:"3 frymÃ«marrje tÃ« ngadalta, me numÃ«rim 1â€“3."},
      {title:"Planifikim i zhurmÃ«s", how:"NÃ«se ka zhurmÃ«, pÃ«rdor kufje ose largim tÃ« shkurtÃ«r."},
    ],
    "Emocione":[
      {title:"KartÃ« emocioni", how:"Zgjidh â€œi qetÃ« / i trishtuar / i gÃ«zuarâ€ me figurÃ«."},
      {title:"EmÃ«rto ndjesinÃ«", how:"Thuaj: â€œDuket se je i lodhur.â€ (pa gjykim)."},
      {title:"Tranzicion i butÃ«", how:"ParalajmÃ«ro 2 minuta para ndryshimit."},
      {title:"ShpÃ«rblim i vogÃ«l", how:"LavdÃ«ro pÃ«r pÃ«rpjekjen: â€œBravo qÃ« u pÃ«rpoqe!â€"},
    ],
    "Koordinimi":[
      {title:"MotorikÃ« e imÃ«t", how:"KapÃ«se rrobash, rruaza tÃ« mÃ«dha, ose plastelinÃ«."},
      {title:"EkuilibÃ«r i lehtÃ«", how:"Ecje e ngadaltÃ« nÃ« vijÃ« tÃ« imagjinuar 30 sek."},
      {title:"Koordinim sy-dorÃ«", how:"Hedhje topi nÃ« kosh nga afÃ«r."},
      {title:"RitÃ«m i ngadaltÃ«", how:"DÃ«gjo ritÃ«m dhe trokit lehtÃ« 10 herÃ«."},
    ]
  };

  const days = ["E HÃ«nÃ«","E MartÃ«","E MÃ«rkurÃ«","E Enjte","E Premte","E ShtunÃ«","E Diel"];
  const picks = emphasis.flatMap(k => (bank[k]||[]).map(x=>({...x, tag:k})));

  return days.map((name, di)=>{
    const tasks = [];
    for(let i=0;i<3;i++){
      const item = picks[(di*3+i) % picks.length] || {title:"Aktivitet i qetÃ«", how:"Lexim i shkurtÃ«r dhe pushim.", tag:"â€”"};
      tasks.push({ title: `${item.title} (${item.tag})`, how: item.how });
    }
    return { name, tasks };
  });
}

function routineKeyForUser(){
  const u = currentUser();
  return u ? `${LS_ROUTINE}_${u.username}` : `${LS_ROUTINE}_guest`;
}
function loadRoutine(){ try{ const raw = localStorage.getItem(routineKeyForUser()); return raw ? JSON.parse(raw) : null; }catch(e){ return null; } }
function saveRoutine(obj){ localStorage.setItem(routineKeyForUser(), JSON.stringify(obj)); }

function maybeUpdateStreak(plan, checks){
  const u = currentUser();
  if(!u) return;

  const today = new Date().toISOString().slice(0,10);

  const anyFullDay = plan.some((day, di)=> day.tasks.every((_, ti)=>checks[`d${di}_t${ti}`]===true));
  if(!anyFullDay) return;

  const uu = ensureUserProgress(u);
  uu.progress.routines = uu.progress.routines || { streak:0, lastDay:null };

  if(uu.progress.routines.lastDay === today) return;

  const last = uu.progress.routines.lastDay;
  if(last){
    const yest = new Date(Date.now() - 86400000).toISOString().slice(0,10);
    if(last === yest) uu.progress.routines.streak = (uu.progress.routines.streak||0) + 1;
    else uu.progress.routines.streak = 1;
  }else{
    uu.progress.routines.streak = 1;
  }

  uu.progress.routines.lastDay = today;
  updateUser(uu);
}

/* =======================
   SAVE AS IMAGE
======================= */
async function saveElementAsImage(el){
  if(typeof html2canvas !== "function"){
    alert("Nuk u gjet html2canvas. Sigurohu qÃ« ke internet ose hiqe opsionin e ruajtjes.");
    return;
  }
  const canvas = await html2canvas(el, { scale: 2, backgroundColor: null });
  const a = document.createElement("a");
  a.download = `GENCARE_${Date.now()}.png`;
  a.href = canvas.toDataURL("image/png");
  a.click();
}

/* =======================
   UTILS
======================= */
function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

/* =======================
   INIT
======================= */
render();
</script>
</body>
</html>
